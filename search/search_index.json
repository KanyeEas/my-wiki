{"config":{"lang":["en","zh"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"],"fields":{"title":{"boost":1000.0},"text":{"boost":1.0},"tags":{"boost":1000000.0}}},"docs":[{"location":"","title":"\u6b22\u8fce\u6765\u5230 Fanzewei \u7684 Wiki","text":"<p>\u6b22\u8fce\uff01\u8fd9\u662f\u6211\u7684\u4e2a\u4eba\u77e5\u8bc6\u5e93\uff0c\u7528\u4e8e\u8bb0\u5f55\u6211\u7684\u5b66\u4e60\u65c5\u7a0b\u548c\u6280\u672f\u7b14\u8bb0\u3002</p> <p>\u5185\u5bb9\u4e3b\u8981\u96c6\u4e2d\u5728 \u7cfb\u7edf\u8f6f\u4ef6 \u548c \u7b97\u6cd5 \u65b9\u9762\u3002</p>"},{"location":"#_1","title":"\ud83d\udcda \u4e3b\u8981\u5185\u5bb9","text":""},{"location":"#arkcompiler","title":"ArkCompiler","text":"<p>\u6df1\u5165\u63a2\u8ba8 ArkCompiler \u7684\u4f7f\u7528\u3001\u6e90\u7801\u5206\u6790\u548c\u6784\u5efa\u7cfb\u7edf\u3002 - \u7f16\u8bd1\u6307\u5357: \u5982\u4f55\u7f16\u8bd1 ArkCompiler \u548c Device LLVM\u3002 - Arena \u5206\u914d\u5668: \u5185\u5b58\u7ba1\u7406\u4f18\u5316\u7684\u6d4b\u8bd5\u6307\u5357\u3002 - Trace \u5b8c\u6574\u6307\u5357: \u8986\u76d6 Trace \u539f\u7406\u3001\u4f7f\u7528\u65b9\u6cd5\u3001\u53ef\u89c6\u5316\u548c\u81ea\u52a8\u63d2\u6869\u3002 - es2panda \u5f00\u53d1\u6307\u5357: \u5e38\u89c1\u914d\u7f6e\u3001\u4f9d\u8d56\u7ba1\u7406\u4e0e\u6807\u51c6\u5e93\u4f7f\u7528\u5b9e\u8df5\u3002 - \u9501\u5b9e\u73b0\u5b8c\u6574\u5206\u6790: Ark Runtime \u9501\u673a\u5236 Deep Dive\uff0c\u5305\u542b Futex\u3001\u6b7b\u9501\u907f\u514d\u548c\u6027\u80fd\u4f18\u5316\u3002</p>"},{"location":"#leetcode","title":"LeetCode","text":"<p>\u7b97\u6cd5\u5b66\u4e60\u7b14\u8bb0\u548c\u89e3\u9898\u6a21\u5f0f\u3002 - \u4e8c\u5206\u67e5\u627e: C++ \u6a21\u677f\u548c\u8fb9\u754c\u60c5\u51b5\u5206\u6790\u3002</p>"},{"location":"#_2","title":"\ud83d\udee0\ufe0f \u5173\u4e8e\u672c\u7ad9","text":"<p>\u672c\u7ad9\u57fa\u4e8e MkDocs \u6784\u5efa\u5e76\u6258\u7ba1\u4e8e GitHub Pages\u3002\u652f\u6301\uff1a - \ud83d\udcdd \u57fa\u4e8e Markdown \u7684\u5185\u5bb9 - \ud83c\udf13 \u6df1\u8272/\u6d45\u8272\u6a21\u5f0f\u81ea\u52a8\u5207\u6362 - \u270f\ufe0f \u76f4\u63a5\u5728 GitHub \u4e0a\u7f16\u8f91 - \ud83d\udd0d \u5168\u6587\u641c\u7d22</p> <p>[!TIP] \u4f7f\u7528\u9876\u90e8\u7684 \u641c\u7d22\u680f\uff08\u6216\u6309 <code>s</code>\uff09\u5feb\u901f\u67e5\u627e\u4efb\u4f55\u4e3b\u9898\u3002</p>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/","title":"Ark Runtime \u9501\u5b9e\u73b0\u5b8c\u6574\u5206\u6790","text":""},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#_1","title":"\u6982\u8ff0","text":"<p>Ark Runtime \u5b9e\u73b0\u4e86\u4e00\u5957\u57fa\u4e8e Linux futex \u7684\u9ad8\u6027\u80fd\u540c\u6b65\u539f\u8bed\u7cfb\u7edf\uff0c\u63d0\u4f9b\u4e86\u591a\u79cd\u9501\u7c7b\u578b\u548c RAII \u5305\u88c5\u5668\uff0c\u7528\u4e8e\u4fdd\u8bc1\u591a\u7ebf\u7a0b\u73af\u5883\u4e0b\u7684\u6570\u636e\u5b89\u5168\u3002</p>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#_2","title":"\u6838\u5fc3\u7279\u6027","text":"<ul> <li>\u57fa\u4e8e Futex \u7684\u9ad8\u6027\u80fd\u5b9e\u73b0\uff1a\u5728 Linux \u5e73\u53f0\u4e0a\u4f7f\u7528 futex \u7cfb\u7edf\u8c03\u7528\uff0c\u51cf\u5c11\u5185\u6838\u6001\u5207\u6362</li> <li>\u6df7\u5408\u7b49\u5f85\u7b56\u7565\uff1a\u5feb\u901f\u8def\u5f84 + \u81ea\u65cb\u7b49\u5f85 + futex \u7b49\u5f85</li> <li>\u5185\u5b58\u9ad8\u6548\uff1a\u7d27\u51d1\u7684\u6570\u636e\u7ed3\u6784\u8bbe\u8ba1\uff0c\u6700\u5c0f\u5316\u5185\u5b58\u5360\u7528</li> <li>\u6b7b\u9501\u907f\u514d\uff1a\u591a\u9501\u573a\u666f\u4e0b\u7684\u81ea\u52a8\u6b7b\u9501\u907f\u514d\u7b97\u6cd5</li> <li>\u7ebf\u7a0b\u5b89\u5168\u5206\u6790\u652f\u6301\uff1a\u96c6\u6210 Clang \u7ebf\u7a0b\u5b89\u5168\u6ce8\u89e3</li> </ul>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#_3","title":"\u67b6\u6784\u8bbe\u8ba1","text":""},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#_4","title":"\u5e73\u53f0\u62bd\u8c61\u5c42","text":"<p>Ark Runtime \u7684\u9501\u5b9e\u73b0\u91c7\u7528\u4e24\u5c42\u67b6\u6784\uff1a</p> <pre><code>graph TB\n    subgraph \"\u7edf\u4e00\u63a5\u53e3\u5c42\"\n        A[libarkbase/os/mutex.h]\n        A --&gt; B[Mutex]\n        A --&gt; C[RecursiveMutex]\n        A --&gt; D[RWLock]\n        A --&gt; E[ConditionVariable]\n        A --&gt; F[Event]\n        A --&gt; G[LockHolder]\n        A --&gt; H[ScopedLock]\n    end\n\n    A --&gt; I{\u5e73\u53f0\u9009\u62e9}\n\n    subgraph \"Futex \u5b9e\u73b0 (Linux)\"\n        I --&gt;|PANDA_USE_FUTEX| J[platforms/unix/libarkbase/futex/]\n        J --&gt; J1[mutex.h]\n        J --&gt; J2[fmutex.h]\n        J --&gt; J3[fmutex.cpp]\n        J --&gt; J4[mutex.cpp]\n    end\n\n    subgraph \"pthread \u5b9e\u73b0 (\u5176\u4ed6\u5e73\u53f0)\"\n        I --&gt;|!PANDA_USE_FUTEX| K[libarkbase/os/mutex.cpp]\n        K --&gt; K1[pthread_mutex_t]\n        K --&gt; K2[pthread_rwlock_t]\n        K --&gt; K3[pthread_cond_t]\n    end</code></pre>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#_5","title":"\u6761\u4ef6\u7f16\u8bd1","text":"<p>\u6839\u636e <code>PANDA_USE_FUTEX</code> \u5b8f\u9009\u62e9\u5b9e\u73b0\uff1a</p> <pre><code>#if defined(PANDA_USE_FUTEX)\n    // \u4f7f\u7528\u57fa\u4e8e futex \u7684\u9ad8\u6027\u80fd\u5b9e\u73b0\n    using Mutex = ark::os::unix::memory::futex::Mutex;\n    using RecursiveMutex = ark::os::unix::memory::futex::RecursiveMutex;\n    using RWLock = ark::os::unix::memory::futex::RWLock;\n    using ConditionVariable = ark::os::unix::memory::futex::ConditionVariable;\n#else\n    // \u4f7f\u7528 pthread \u6807\u51c6\u5b9e\u73b0\n    class Mutex { /* pthread_mutex_t \u5305\u88c5 */ };\n    class RecursiveMutex : public Mutex { /* ... */ };\n    class RWLock { /* pthread_rwlock_t \u5305\u88c5 */ };\n    class ConditionVariable { /* pthread_cond_t \u5305\u88c5 */ };\n#endif\n</code></pre>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#_6","title":"\u9501\u7c7b\u578b\u8be6\u89e3","text":""},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#1-mutex","title":"1. Mutex\uff08\u4e92\u65a5\u9501\uff09","text":""},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#_7","title":"\u57fa\u672c\u7279\u6027","text":"<ul> <li>\u7c7b\u578b\uff1a\u975e\u9012\u5f52\u4e92\u65a5\u9501</li> <li>\u7528\u9014\uff1a\u4fdd\u62a4\u4e34\u754c\u533a\uff0c\u786e\u4fdd\u540c\u4e00\u65f6\u523b\u53ea\u6709\u4e00\u4e2a\u7ebf\u7a0b\u8bbf\u95ee</li> <li>\u5b9e\u73b0\uff1a\u57fa\u4e8e futex \u7684\u81ea\u5b9a\u4e49\u5b9e\u73b0\uff08Linux\uff09\u6216 pthread_mutex\uff08\u5176\u4ed6\u5e73\u53f0\uff09</li> </ul>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#_8","title":"\u7279\u6b8a\u529f\u80fd","text":"<p>LockForOther / UnlockForOther\uff1a - \u7528\u9014\uff1a\u7528\u4e8e Monitor \u7cfb\u7edf\uff0c\u5141\u8bb8\u4e3a\u5176\u4ed6\u7ebf\u7a0b\u52a0\u9501/\u89e3\u9501 - \u9650\u5236\uff1a\u4ec5\u7528\u4e8e\u65b0\u521b\u5efa\u7684\u3001\u5c1a\u672a\u4f7f\u7528\u7684 mutex - \u573a\u666f\uff1a\u5bf9\u8c61\u76d1\u89c6\u5668\u7684\u521d\u59cb\u5316\uff0c\u9700\u8981\u5c06\u9501\u8f6c\u79fb\u7ed9\u7279\u5b9a\u7ebf\u7a0b</p> <pre><code>// Monitor \u7cfb\u7edf\u4f7f\u7528\u793a\u4f8b\nvoid Monitor::LockForThread(MTManagedThread *thread) {\n    ASSERT(thread-&gt;GetStatus() != ThreadStatus::RUNNING);\n    lock_.LockForOther(thread-&gt;GetId());  // \u4e3a\u5176\u4ed6\u7ebf\u7a0b\u52a0\u9501\n}\n\nvoid Monitor::UnlockForThread(MTManagedThread *thread) {\n    ASSERT(thread-&gt;GetStatus() != ThreadStatus::RUNNING);\n    lock_.UnlockForOther(thread-&gt;GetId());  // \u4e3a\u5176\u4ed6\u7ebf\u7a0b\u89e3\u9501\n}\n</code></pre>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#futex","title":"Futex \u5b9e\u73b0\u6838\u5fc3\u6570\u636e\u7ed3\u6784","text":"<pre><code>struct fmutex {\n    // \u72b6\u6001\u548c\u7b49\u5f85\u8005\u8ba1\u6570\uff08\u4f4d\u7f16\u7801\uff09\n    // \u6700\u4f4e\u4f4d\uff1a0 = \u672a\u9501\u5b9a, 1 = \u5df2\u9501\u5b9a\n    // \u5176\u4ed6\u4f4d\uff1a\u7b49\u5f85\u8005\u6570\u91cf\n    ATOMIC_INT stateAndWaiters;\n\n    // \u72ec\u5360\u6240\u6709\u8005\u7ebf\u7a0b ID\n    ATOMIC(THREAD_ID) exclusiveOwner;\n\n    // \u9012\u5f52\u8ba1\u6570\uff08\u7528\u4e8e RecursiveMutex\uff09\n    int recursiveCount;\n\n    // \u662f\u5426\u4e3a\u9012\u5f52\u9501\n    bool recursiveMutex;\n};\n</code></pre>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#_9","title":"\u52a0\u9501\u6d41\u7a0b","text":"<pre><code>flowchart TD\n    Start[Lock] --&gt; CheckRecursive{\u68c0\u67e5\u662f\u5426\u4e3a\u9012\u5f52\u9501&lt;br/&gt;\u4e14\u5df2\u6301\u6709}\n    CheckRecursive --&gt;|\u662f| FastPath1[recursiveCount++&lt;br/&gt;\u76f4\u63a5\u8fd4\u56de&lt;br/&gt;\u5feb\u901f\u8def\u5f84]\n    CheckRecursive --&gt;|\u5426| TryCAS[\u5c1d\u8bd5 CAS \u83b7\u53d6\u9501]\n    TryCAS --&gt;|\u6210\u529f| SetOwner[\u8bbe\u7f6e exclusiveOwner&lt;br/&gt;\u8fd4\u56de]\n    TryCAS --&gt;|\u5931\u8d25| SpinWait[\u81ea\u65cb\u7b49\u5f85&lt;br/&gt;WaitBrieflyFor&lt;br/&gt;\u6700\u591a 50 \u6b21\u8fed\u4ee3&lt;br/&gt;\u5e26\u6307\u6570\u9000\u907f]\n    SpinWait --&gt;|\u6210\u529f| SetOwner\n    SpinWait --&gt;|\u5931\u8d25| FutexWait[\u8fdb\u5165 futex \u7b49\u5f85]\n    FutexWait --&gt; IncWaiters[IncrementWaiters]\n    IncWaiters --&gt; FutexCall[futex FUTEX_WAIT_PRIVATE]\n    FutexCall --&gt; DecWaiters[DecrementWaiters]\n    DecWaiters --&gt; TryCAS</code></pre>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#_10","title":"\u89e3\u9501\u6d41\u7a0b","text":"<pre><code>flowchart TD\n    Start[Unlock] --&gt; CheckOwner[\u68c0\u67e5\u7ebf\u7a0b\u6240\u6709\u6743]\n    CheckOwner --&gt; CheckRecursive{\u9012\u5f52\u9501\u4e14&lt;br/&gt;recursiveCount &gt; 0}\n    CheckRecursive --&gt;|\u662f| FastPath2[recursiveCount--&lt;br/&gt;\u76f4\u63a5\u8fd4\u56de&lt;br/&gt;\u5feb\u901f\u8def\u5f84]\n    CheckRecursive --&gt;|\u5426| ClearMask[\u6e05\u9664 HELD_MASK \u4f4d&lt;br/&gt;CAS]\n    ClearMask --&gt; CheckWaiters{\u662f\u5426\u6709\u7b49\u5f85\u8005}\n    CheckWaiters --&gt;|\u662f| WakeOne[futex FUTEX_WAKE_PRIVATE&lt;br/&gt;WAKE_ONE]\n    CheckWaiters --&gt;|\u5426| End[\u7ed3\u675f]\n    WakeOne --&gt; End</code></pre>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#_11","title":"\u5173\u952e\u4f18\u5316","text":"<ol> <li>\u5feb\u901f\u8def\u5f84\u4f18\u5316\uff1a\u65e0\u7ade\u4e89\u65f6\u4ec5\u9700\u4e00\u6b21 CAS \u64cd\u4f5c</li> <li>\u81ea\u65cb\u7b49\u5f85\uff1a\u77ed\u6682\u81ea\u65cb\u907f\u514d\u4e0d\u5fc5\u8981\u7684\u7cfb\u7edf\u8c03\u7528</li> <li>\u4f4d\u7f16\u7801\uff1a\u72b6\u6001\u548c\u7b49\u5f85\u8005\u8ba1\u6570\u5408\u5e76\uff0c\u51cf\u5c11\u5185\u5b58\u5360\u7528</li> <li>\u5185\u5b58\u5e8f\u4f18\u5316\uff1a\u4f7f\u7528 relaxed/acquire/release \u8bed\u4e49\uff0c\u51cf\u5c11\u5185\u5b58\u5c4f\u969c\u5f00\u9500</li> </ol>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#2-recursivemutex","title":"2. RecursiveMutex\uff08\u9012\u5f52\u4e92\u65a5\u9501\uff09","text":""},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#_12","title":"\u57fa\u672c\u7279\u6027","text":"<ul> <li>\u7c7b\u578b\uff1a\u9012\u5f52\u4e92\u65a5\u9501</li> <li>\u7528\u9014\uff1a\u5141\u8bb8\u540c\u4e00\u7ebf\u7a0b\u591a\u6b21\u52a0\u9501</li> <li>\u5b9e\u73b0\uff1a\u7ee7\u627f\u81ea Mutex\uff0c\u8bbe\u7f6e <code>recursiveMutex = true</code></li> </ul>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#_13","title":"\u5b9e\u73b0\u7ec6\u8282","text":"<pre><code>class RecursiveMutex : public Mutex {\npublic:\n    RecursiveMutex() : Mutex(true) {}  // \u8bbe\u7f6e recursiveMutex = true\n};\n</code></pre>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#_14","title":"\u9012\u5f52\u52a0\u9501\u6d41\u7a0b","text":"<pre><code>flowchart TD\n    Start[Lock \u5df2\u6301\u6709\u9501] --&gt; Check{\u68c0\u67e5 recursiveMutex&lt;br/&gt;&amp;&amp; IsHeld current_tid}\n    Check --&gt;|\u662f| RecursivePath[recursiveCount++&lt;br/&gt;\u76f4\u63a5\u8fd4\u56de&lt;br/&gt;\u5feb\u901f\u8def\u5f84]\n    Check --&gt;|\u5426| NormalPath[\u6267\u884c\u6b63\u5e38\u52a0\u9501\u6d41\u7a0b]</code></pre>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#_15","title":"\u4f7f\u7528\u573a\u666f","text":"<p>\u9012\u5f52\u9501\u9002\u7528\u4e8e\u4ee5\u4e0b\u573a\u666f\uff1a</p> <ol> <li>\u56de\u8c03\u51fd\u6570\uff1a\u5916\u90e8\u56de\u8c03\u53ef\u80fd\u89e6\u53d1\u9012\u5f52\u8c03\u7528</li> <li>\u865a\u51fd\u6570/\u63a5\u53e3\uff1a\u5b50\u7c7b\u5b9e\u73b0\u53ef\u80fd\u8c03\u7528\u57fa\u7c7b\u65b9\u6cd5</li> <li>\u7b2c\u4e09\u65b9\u5e93\u96c6\u6210\uff1a\u65e0\u6cd5\u63a7\u5236\u5916\u90e8\u4ee3\u7801\u7684\u8c03\u7528\u94fe</li> <li>\u5168\u5c40\u9501\uff1a\u590d\u6742\u8c03\u7528\u94fe\u4e2d\u96be\u4ee5\u907f\u514d\u9012\u5f52</li> </ol> <p>\u793a\u4f8b\uff1a <pre><code>class ClassLinkerExtension {\n    RecursiveMutex contextsLock_;\n\n    void EnumerateClasses(Callback cb) {\n        LockHolder lock(contextsLock_);\n        for (auto* ctx : contexts_) {\n            ctx-&gt;EnumerateClasses(cb);  // \u56de\u8c03\u53ef\u80fd\u518d\u6b21\u52a0\u9501\n        }\n    }\n};\n</code></pre></p>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#3-rwlock","title":"3. RWLock\uff08\u8bfb\u5199\u9501\uff09","text":""},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#_16","title":"\u57fa\u672c\u7279\u6027","text":"<ul> <li>\u7c7b\u578b\uff1a\u8bfb\u5199\u5206\u79bb\u9501</li> <li>\u7528\u9014\uff1a\u591a\u8bfb\u4e00\u5199\u573a\u666f\uff0c\u63d0\u9ad8\u5e76\u53d1\u6027\u80fd</li> <li>\u5b9e\u73b0\uff1a\u57fa\u4e8e\u539f\u5b50\u64cd\u4f5c\u548c futex \u7684\u81ea\u5b9a\u4e49\u5b9e\u73b0</li> </ul>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#_17","title":"\u6838\u5fc3\u6570\u636e\u7ed3\u6784","text":"<pre><code>class RWLock {\n    // \u72b6\u6001\u7f16\u7801\uff1a\n    // -1: \u5199\u9501\u5b9a\n    //  0: \u672a\u9501\u5b9a\n    // &gt;0: \u8bfb\u9501\u5b9a\uff08\u503c\u4e3a\u8bfb\u8005\u6570\u91cf\uff09\n    std::atomic_int32_t state_ {0};\n\n    // \u72ec\u5360\u6240\u6709\u8005\uff08\u5199\u9501\u6301\u6709\u8005\uff09\n    std::atomic&lt;ThreadId&gt; exclusiveOwner_ {0};\n\n    // \u7b49\u5f85\u8005\u6570\u91cf\n    std::atomic_uint32_t waiters_ {0};\n};\n</code></pre>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#_18","title":"\u8bfb\u9501\u6d41\u7a0b","text":"<pre><code>flowchart TD\n    Start[ReadLock] --&gt; CheckState{\u68c0\u67e5 state_ &gt;= 0&lt;br/&gt;\u672a\u5199\u9501\u5b9a}\n    CheckState --&gt;|\u662f| TryCAS[CAS: state_ = state_ + 1]\n    TryCAS --&gt;|\u6210\u529f| FastPath[\u8fd4\u56de&lt;br/&gt;\u5feb\u901f\u8def\u5f84]\n    TryCAS --&gt;|\u5931\u8d25| WaitWrite[\u7b49\u5f85\u5199\u9501\u91ca\u653e]\n    CheckState --&gt;|\u5426| WaitWrite\n    WaitWrite --&gt; Spin[\u81ea\u65cb\u7b49\u5f85]\n    Spin --&gt; FutexWait[futex \u7b49\u5f85]\n    FutexWait --&gt; CheckState</code></pre>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#_19","title":"\u5199\u9501\u6d41\u7a0b","text":"<pre><code>flowchart TD\n    Start[WriteLock] --&gt; CheckUnlocked{\u68c0\u67e5 state_ == 0&lt;br/&gt;\u672a\u9501\u5b9a}\n    CheckUnlocked --&gt;|\u662f| TryCAS[CAS: state_ = -1]\n    TryCAS --&gt;|\u6210\u529f| SetOwner[\u8bbe\u7f6e exclusiveOwner_&lt;br/&gt;\u8fd4\u56de]\n    TryCAS --&gt;|\u5931\u8d25| WaitAll[\u7b49\u5f85\u6240\u6709\u8bfb\u9501\u548c\u5199\u9501\u91ca\u653e]\n    CheckUnlocked --&gt;|\u5426| WaitAll\n    WaitAll --&gt; Spin[\u81ea\u65cb\u7b49\u5f85]\n    Spin --&gt; FutexWait[futex \u7b49\u5f85]\n    FutexWait --&gt; CheckUnlocked</code></pre>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#_20","title":"\u6027\u80fd\u7279\u70b9","text":"<ul> <li>\u8bfb\u591a\u5199\u5c11\u573a\u666f\uff1a\u663e\u8457\u63d0\u5347\u5e76\u53d1\u6027\u80fd</li> <li>\u5185\u8054\u4f18\u5316\uff1a<code>ReadLock()</code> \u548c <code>Unlock()</code> \u4f7f\u7528 <code>ALWAYS_INLINE</code></li> <li>\u5185\u5b58\u5bf9\u9f50\uff1a\u7ed3\u6784\u4f53\u5927\u5c0f\u56fa\u5b9a\u4e3a 16 \u5b57\u8282\uff0c\u4f18\u5316\u7f13\u5b58\u6027\u80fd</li> </ul>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#4-conditionvariable","title":"4. ConditionVariable\uff08\u6761\u4ef6\u53d8\u91cf\uff09","text":""},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#_21","title":"\u57fa\u672c\u7279\u6027","text":"<ul> <li>\u7c7b\u578b\uff1a\u6761\u4ef6\u53d8\u91cf</li> <li>\u7528\u9014\uff1a\u7ebf\u7a0b\u95f4\u6761\u4ef6\u7b49\u5f85\u548c\u901a\u77e5</li> <li>\u5b9e\u73b0\uff1a\u57fa\u4e8e futex \u7684\u81ea\u5b9a\u4e49\u5b9e\u73b0</li> </ul>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#_22","title":"\u6838\u5fc3\u6570\u636e\u7ed3\u6784","text":"<pre><code>struct CondVar {\n    // \u5173\u8054\u7684\u4e92\u65a5\u9501\u6307\u9488\n    alignas(alignof(uint64_t)) ATOMIC(struct fmutex *) mutexPtr;\n\n    // \u6761\u4ef6\u503c\uff08\u53d8\u5316\u5373\u89e6\u53d1\uff09\n    ATOMIC(int32_t) cond;\n\n    // \u7b49\u5f85\u8005\u6570\u91cf\n    ATOMIC(int32_t) waiters;\n};\n</code></pre>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#wait","title":"Wait \u6d41\u7a0b","text":"<pre><code>flowchart TD\n    Start[Wait mutex] --&gt; CheckHeld[\u68c0\u67e5 mutex \u662f\u5426\u5df2\u6301\u6709]\n    CheckHeld --&gt; SetMutexPtr[\u8bbe\u7f6e cond-&gt;mutexPtr = mutex]\n    SetMutexPtr --&gt; IncWaiters[IncrementWaiters mutex]\n    IncWaiters --&gt; UnlockMutex[MutexUnlock mutex&lt;br/&gt;\u539f\u5b50\u91ca\u653e\u9501]\n    UnlockMutex --&gt; FutexWait[futex FUTEX_WAIT_PRIVATE&lt;br/&gt;\u7b49\u5f85\u6761\u4ef6]\n    FutexWait --&gt; LockMutex[MutexLock mutex&lt;br/&gt;\u91cd\u65b0\u83b7\u53d6\u9501]\n    LockMutex --&gt; End[\u7ed3\u675f]</code></pre>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#signal","title":"Signal \u6d41\u7a0b","text":"<pre><code>flowchart TD\n    Start[Signal] --&gt; CheckWaiters{\u68c0\u67e5\u662f\u5426\u6709\u7b49\u5f85\u8005}\n    CheckWaiters --&gt;|\u5426| End1[\u7ed3\u675f]\n    CheckWaiters --&gt;|\u662f| IncCond[cond++&lt;br/&gt;\u89e6\u53d1\u6761\u4ef6\u53d8\u5316]\n    IncCond --&gt; CheckMutexHeld{\u5f53\u524d\u7ebf\u7a0b&lt;br/&gt;\u662f\u5426\u6301\u6709 mutex}\n    CheckMutexHeld --&gt;|\u662f| Requeue[futex FUTEX_REQUEUE_PRIVATE&lt;br/&gt;\u8f6c\u79fb\u5230 mutex \u7b49\u5f85\u961f\u5217]\n    CheckMutexHeld --&gt;|\u5426| Wake[futex FUTEX_WAKE_PRIVATE&lt;br/&gt;\u5524\u9192\u7b49\u5f85\u8005]\n    Requeue --&gt; End2[\u7ed3\u675f]\n    Wake --&gt; End2</code></pre>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#_23","title":"\u4f18\u5316\u7279\u6027","text":"<ul> <li>Requeue \u4f18\u5316\uff1a\u5982\u679c\u4fe1\u53f7\u53d1\u9001\u8005\u6301\u6709 mutex\uff0c\u76f4\u63a5\u5c06\u7b49\u5f85\u8005\u8f6c\u79fb\u5230 mutex \u961f\u5217\uff0c\u51cf\u5c11\u5524\u9192\u5ef6\u8fdf</li> <li>\u539f\u5b50\u64cd\u4f5c\uff1a\u4f7f\u7528\u539f\u5b50\u64cd\u4f5c\u4fdd\u8bc1\u7ebf\u7a0b\u5b89\u5168</li> </ul>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#5-event","title":"5. Event\uff08\u4e8b\u4ef6\uff09","text":""},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#_24","title":"\u57fa\u672c\u7279\u6027","text":"<ul> <li>\u7c7b\u578b\uff1a\u4e00\u6b21\u6027\u4e8b\u4ef6</li> <li>\u7528\u9014\uff1a\u7ebf\u7a0b\u95f4\u4e8b\u4ef6\u901a\u77e5</li> <li>\u5b9e\u73b0\uff1a\u57fa\u4e8e Mutex + ConditionVariable</li> </ul>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#_25","title":"\u5b9e\u73b0","text":"<pre><code>class Event {\n    bool happened_ = false;\n    Mutex lock_;\n    ConditionVariable cv_;\n\n    void Wait() {\n        LockHolder lh(lock_);\n        while (!happened_) {\n            cv_.Wait(&amp;lock_);\n        }\n    }\n\n    void Fire() {\n        LockHolder lh(lock_);\n        happened_ = true;\n        cv_.SignalAll();\n    }\n};\n</code></pre>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#6-dummylock","title":"6. DummyLock\uff08\u7a7a\u9501\uff09","text":""},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#_26","title":"\u57fa\u672c\u7279\u6027","text":"<ul> <li>\u7c7b\u578b\uff1a\u7a7a\u64cd\u4f5c\u9501</li> <li>\u7528\u9014\uff1a\u6a21\u677f\u4ee3\u7801\u4e2d\u7684\u5360\u4f4d\u7b26\uff0c\u63d0\u4f9b\u7edf\u4e00\u63a5\u53e3\u4f46\u4e0d\u5b9e\u9645\u52a0\u9501</li> <li>\u5b9e\u73b0\uff1a\u6240\u6709\u65b9\u6cd5\u90fd\u662f\u7a7a\u64cd\u4f5c</li> </ul>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#_27","title":"\u5b9e\u73b0","text":"<pre><code>class CAPABILITY(\"mutex\") DummyLock {\npublic:\n    void Lock() const ACQUIRE() {}\n    bool TryLock() const TRY_ACQUIRE(true) { return true; }\n    void Unlock() const RELEASE() {}\n    void ReadLock() const ACQUIRE_SHARED() {}\n    void WriteLock() const ACQUIRE() {}\n    // ... \u5176\u4ed6\u65b9\u6cd5\u90fd\u662f\u7a7a\u64cd\u4f5c\n};\n</code></pre>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#_28","title":"\u4f7f\u7528\u573a\u666f","text":"<ul> <li>\u6761\u4ef6\u7f16\u8bd1\uff1a\u67d0\u4e9b\u914d\u7f6e\u4e0b\u4e0d\u9700\u8981\u9501\u4fdd\u62a4</li> <li>\u6a21\u677f\u4ee3\u7801\uff1a\u7edf\u4e00\u63a5\u53e3\uff0c\u4f46\u67d0\u4e9b\u5b9e\u4f8b\u4e0d\u9700\u8981\u540c\u6b65</li> <li>\u6d4b\u8bd5\uff1a\u7b80\u5316\u6d4b\u8bd5\u4ee3\u7801</li> </ul> <p>\u793a\u4f8b\uff1a <pre><code>template &lt;bool NEED_SYNC&gt;\nclass Container {\n    using LockType = std::conditional_t&lt;NEED_SYNC, Mutex, DummyLock&gt;;\n    LockType lock_;\n\n    void Access() {\n        LockHolder lock(lock_);  // \u7edf\u4e00\u63a5\u53e3\n        // \u64cd\u4f5c\n    }\n};\n</code></pre></p>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#_29","title":"\u5e95\u5c42\u5b9e\u73b0\u673a\u5236","text":""},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#futex_1","title":"Futex \u7cfb\u7edf\u8c03\u7528","text":"<p>Futex\uff08Fast Userspace Mutex\uff09\u662f Linux \u63d0\u4f9b\u7684\u9ad8\u6548\u540c\u6b65\u539f\u8bed\uff1a</p> <pre><code>inline int futex(volatile int *uaddr, int op, int val, \n                 const struct timespec *timeout, \n                 volatile int *uaddr2, int val3) {\n    return syscall(SYS_futex, uaddr, op, val, timeout, uaddr2, val3);\n}\n</code></pre>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#_30","title":"\u4e3b\u8981\u64cd\u4f5c","text":"<ol> <li>FUTEX_WAIT_PRIVATE\uff1a\u7b49\u5f85\u5730\u5740\u503c\u53d8\u5316</li> <li>FUTEX_WAKE_PRIVATE\uff1a\u5524\u9192\u7b49\u5f85\u8005</li> <li>FUTEX_REQUEUE_PRIVATE\uff1a\u5c06\u7b49\u5f85\u8005\u8f6c\u79fb\u5230\u53e6\u4e00\u4e2a\u5730\u5740\u7684\u7b49\u5f85\u961f\u5217</li> <li>FUTEX_WAIT_BITSET_PRIVATE\uff1a\u652f\u6301\u8d85\u65f6\u7684\u7b49\u5f85</li> </ol>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#_31","title":"\u81ea\u65cb\u7b49\u5f85\u7b56\u7565","text":""},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#backoff","title":"BackOff \u7b97\u6cd5","text":"<pre><code>static void BackOff(uint32_t i) {\n    static constexpr uint32_t SPIN_MAX = 10;\n    if (i &lt;= SPIN_MAX) {\n        // \u77ed\u65f6\u95f4\uff1aCPU \u81ea\u65cb\n        volatile uint32_t x = 0;\n        const uint32_t spinCount = 10 * i;  // \u6307\u6570\u589e\u957f\n        for (uint32_t spin = 0; spin &lt; spinCount; spin++) {\n            ++x;\n        }\n    } else {\n        // \u957f\u65f6\u95f4\uff1a\u8ba9\u51fa CPU\n        ark::os::thread::Yield();\n    }\n}\n</code></pre>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#waitbrieflyfor","title":"WaitBrieflyFor","text":"<pre><code>static inline bool WaitBrieflyFor(ATOMIC_INT *addr) {\n    static constexpr uint32_t MAX_BACK_OFF = 10;\n    static constexpr uint32_t MAX_ITER = 50;\n\n    for (uint32_t i = 1; i &lt;= MAX_ITER; i++) {\n        BackOff(std::min(i, MAX_BACK_OFF));\n        int state = ATOMIC_LOAD(addr, memory_order_relaxed);\n        if ((state &amp; HELD_MASK) == 0) {\n            return true;  // \u9501\u5df2\u91ca\u653e\n        }\n    }\n    return false;  // \u8d85\u65f6\uff0c\u9700\u8981 futex \u7b49\u5f85\n}\n</code></pre>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#_32","title":"\u5185\u5b58\u5e8f\u8bed\u4e49","text":"<p>Ark Runtime \u7684\u9501\u5b9e\u73b0\u7cbe\u7ec6\u63a7\u5236\u5185\u5b58\u5e8f\uff1a</p> \u64cd\u4f5c \u5185\u5b58\u5e8f \u539f\u56e0 \u72b6\u6001\u8bfb\u53d6\uff08\u68c0\u67e5\uff09 <code>memory_order_relaxed</code> \u4ec5\u68c0\u67e5\u72b6\u6001\uff0c\u4e0d\u6d89\u53ca\u540c\u6b65 \u52a0\u9501\u6210\u529f <code>memory_order_acquire</code> \u5efa\u7acb acquire \u8bed\u4e49\uff0c\u4fdd\u8bc1\u540e\u7eed\u64cd\u4f5c\u53ef\u89c1 \u89e3\u9501 <code>memory_order_release</code> \u5efa\u7acb release \u8bed\u4e49\uff0c\u4fdd\u8bc1\u4e4b\u524d\u64cd\u4f5c\u53ef\u89c1 RWLock \u5199\u89e3\u9501 <code>memory_order_seq_cst</code> \u9700\u8981\u4e0e waiters_ \u7684\u8bfb\u53d6\u4fdd\u6301\u987a\u5e8f"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#raii","title":"RAII \u9501\u5305\u88c5\u5668","text":""},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#1-lockholder","title":"1. LockHolder\uff08\u5355\u9501\u5305\u88c5\u5668\uff09","text":""},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#_33","title":"\u57fa\u672c\u7528\u6cd5","text":"<pre><code>template &lt;class T, bool NEED_LOCK = true&gt;\nclass SCOPED_CAPABILITY LockHolder {\n    explicit LockHolder(T &amp;lock) ACQUIRE(lock) : lock_(lock) {\n        if constexpr (NEED_LOCK) {\n            lock_.Lock();\n        }\n    }\n\n    ~LockHolder() RELEASE() {\n        if constexpr (NEED_LOCK) {\n            lock_.Unlock();\n        }\n    }\n\nprivate:\n    T &amp;lock_;\n};\n</code></pre>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#_34","title":"\u4f7f\u7528\u793a\u4f8b","text":"<pre><code>void CriticalSection() {\n    LockHolder lock(mutex_);  // \u81ea\u52a8\u52a0\u9501\n    // \u4e34\u754c\u533a\u4ee3\u7801\n    // \u6790\u6784\u65f6\u81ea\u52a8\u89e3\u9501\n}\n</code></pre>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#2-scopedlock","title":"2. ScopedLock\uff08\u591a\u9501\u5305\u88c5\u5668\uff09","text":""},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#_35","title":"\u6b7b\u9501\u907f\u514d\u7b97\u6cd5","text":"<p><code>ScopedLock</code> \u5b9e\u73b0\u4e86\u81ea\u52a8\u6b7b\u9501\u907f\u514d\u7b97\u6cd5\uff1a</p> <pre><code>template &lt;bool NEED_LOCK = true, class... T&gt;\nclass ScopedLock {\n    explicit ScopedLock(T &amp;...locks) : locks_(std::tie(locks...)) {\n        if constexpr (NEED_LOCK) {\n            Lock&lt;LockType::LOCK&gt;(locks...);  // \u6b7b\u9501\u907f\u514d\u7b97\u6cd5\n        }\n    }\n};\n</code></pre>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#_36","title":"\u6b7b\u9501\u907f\u514d\u539f\u7406","text":"<pre><code>template &lt;LockType TYPE, class L0, class... L1&gt;\nvoid Lock(L0 &amp;lock0, L1 &amp;...rest) {\n    detail::LockMutex&lt;TYPE&gt;(lock0);  // \u5148\u9501\u7b2c\u4e00\u4e2a\n\n    int failedIndex = detail::TryLock&lt;TYPE&gt;(rest...);\n    if (failedIndex == -1) {\n        return;  // \u5168\u90e8\u6210\u529f\n    }\n\n    // \u5931\u8d25\uff1a\u91ca\u653e\u5df2\u6301\u6709\u7684\u9501\uff0c\u8ba9\u51fa CPU\uff0c\u91cd\u65b0\u5c1d\u8bd5\n    lock0.Unlock();\n    thread::Yield();\n    Lock&lt;TYPE&gt;(rest..., lock0);  // \u9012\u5f52\u8c03\u7528\uff0c\u6539\u53d8\u9501\u987a\u5e8f\n}\n</code></pre> <p>\u5173\u952e\u70b9\uff1a - \u6309\u987a\u5e8f\u5c1d\u8bd5\u52a0\u9501 - \u5931\u8d25\u65f6\u91ca\u653e\u6240\u6709\u5df2\u6301\u6709\u7684\u9501 - \u8ba9\u51fa CPU\uff0c\u6539\u53d8\u9501\u987a\u5e8f\u540e\u91cd\u8bd5 - \u907f\u514d\u5faa\u73af\u7b49\u5f85\u5bfc\u81f4\u7684\u6b7b\u9501</p>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#3-readlockholder-writelockholder","title":"3. ReadLockHolder / WriteLockHolder","text":"<p>\u7528\u4e8e RWLock \u7684\u4e13\u7528\u5305\u88c5\u5668\uff1a</p> <pre><code>ReadLockHolder readLock(rwlock_);   // \u8bfb\u9501\nWriteLockHolder writeLock(rwlock_);  // \u5199\u9501\n</code></pre>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#_37","title":"\u6b7b\u9501\u907f\u514d\u7b97\u6cd5","text":""},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#_38","title":"\u7b97\u6cd5\u6d41\u7a0b","text":"<pre><code>flowchart TD\n    Start[Lock lock0, lock1, lock2] --&gt; Lock0[Lock lock0&lt;br/&gt;\u6210\u529f]\n    Lock0 --&gt; TryLock1[TryLock lock1&lt;br/&gt;\u6210\u529f]\n    TryLock1 --&gt; TryLock2[TryLock lock2]\n    TryLock2 --&gt;|\u6210\u529f| AllLocked[\u5168\u90e8\u52a0\u9501\u6210\u529f]\n    TryLock2 --&gt;|\u5931\u8d25| Unlock1[Unlock lock1]\n    Unlock1 --&gt; Unlock0[Unlock lock0]\n    Unlock0 --&gt; Yield[Yield \u8ba9\u51fa CPU]\n    Yield --&gt; Retry[Lock lock1, lock2, lock0&lt;br/&gt;\u6539\u53d8\u987a\u5e8f\u91cd\u8bd5]\n    Retry --&gt; Start</code></pre>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#_39","title":"\u7b97\u6cd5\u7279\u70b9","text":"<ol> <li>\u975e\u963b\u585e\uff1a\u4e0d\u4f1a\u6c38\u4e45\u963b\u585e</li> <li>\u516c\u5e73\u6027\uff1a\u901a\u8fc7\u6539\u53d8\u9501\u987a\u5e8f\u907f\u514d\u9965\u997f</li> <li>\u6548\u7387\uff1a\u5728\u4f4e\u7ade\u4e89\u573a\u666f\u4e0b\u51e0\u4e4e\u65e0\u5f00\u9500</li> </ol>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#_40","title":"\u4f7f\u7528\u5efa\u8bae","text":"<ul> <li>\u56fa\u5b9a\u987a\u5e8f\uff1a\u5982\u679c\u53ef\u80fd\uff0c\u59cb\u7ec8\u6309\u76f8\u540c\u987a\u5e8f\u52a0\u9501</li> <li>\u6700\u5c0f\u5316\u9501\u6570\u91cf\uff1a\u51cf\u5c11\u9700\u8981\u540c\u65f6\u6301\u6709\u7684\u9501\u6570\u91cf</li> <li>\u4f7f\u7528 ScopedLock\uff1a\u81ea\u52a8\u5904\u7406\u6b7b\u9501\u907f\u514d</li> </ul>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#_41","title":"\u6027\u80fd\u4f18\u5316\u7b56\u7565","text":""},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#1","title":"1. \u5feb\u901f\u8def\u5f84\u4f18\u5316","text":""},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#mutex","title":"Mutex \u5feb\u901f\u8def\u5f84","text":"<pre><code>// \u65e0\u7ade\u4e89\u65f6\u7684\u5feb\u901f\u8def\u5f84\nauto curState = ATOMIC_LOAD(&amp;m-&gt;stateAndWaiters, memory_order_relaxed);\nif (LIKELY((curState &amp; HELD_MASK) == 0)) {\n    auto newState = curState | HELD_MASK;\n    if (CAS_WEAK(&amp;m-&gt;stateAndWaiters, curState, newState, \n                 memory_order_acquire, memory_order_relaxed)) {\n        // \u6210\u529f\uff01\u4ec5\u9700\u4e00\u6b21 CAS\n        return;\n    }\n}\n</code></pre> <p>\u6027\u80fd\uff1a\u65e0\u7ade\u4e89\u65f6\u4ec5\u9700 1 \u6b21\u539f\u5b50\u64cd\u4f5c</p>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#2","title":"2. \u81ea\u65cb\u7b49\u5f85\u4f18\u5316","text":"<ul> <li>\u77ed\u65f6\u95f4\u81ea\u65cb\uff1a\u907f\u514d\u4e0d\u5fc5\u8981\u7684\u7cfb\u7edf\u8c03\u7528</li> <li>\u6307\u6570\u9000\u907f\uff1a\u51cf\u5c11 CPU \u5360\u7528</li> <li>\u81ea\u9002\u5e94\uff1a\u6839\u636e\u7b49\u5f85\u65f6\u95f4\u8c03\u6574\u7b56\u7565</li> </ul>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#3","title":"3. \u5185\u8054\u4f18\u5316","text":"<p>\u5173\u952e\u8def\u5f84\u51fd\u6570\u4f7f\u7528 <code>ALWAYS_INLINE</code>\uff1a</p> <pre><code>ALWAYS_INLINE void ReadLock() ACQUIRE_SHARED() {\n    // \u5185\u8054\u5b9e\u73b0\uff0c\u51cf\u5c11\u51fd\u6570\u8c03\u7528\u5f00\u9500\n}\n</code></pre>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#4","title":"4. \u5185\u5b58\u5e03\u5c40\u4f18\u5316","text":"<ul> <li>\u7d27\u51d1\u7f16\u7801\uff1a\u72b6\u6001\u548c\u7b49\u5f85\u8005\u8ba1\u6570\u5408\u5e76</li> <li>\u7f13\u5b58\u5bf9\u9f50\uff1aRWLock \u56fa\u5b9a 16 \u5b57\u8282\uff0c\u4f18\u5316\u7f13\u5b58\u6027\u80fd</li> <li>\u65e0\u9501\u539f\u5b50\uff1a\u4f7f\u7528 lock-free \u539f\u5b50\u64cd\u4f5c</li> </ul>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#5","title":"5. \u5185\u5b58\u5e8f\u4f18\u5316","text":"<ul> <li>\u6700\u5c0f\u5316\u5c4f\u969c\uff1a\u4ec5\u5728\u5fc5\u8981\u65f6\u4f7f\u7528\u5f3a\u5185\u5b58\u5e8f</li> <li>Relaxed \u8bed\u4e49\uff1a\u5185\u90e8\u72b6\u6001\u68c0\u67e5\u4f7f\u7528 relaxed</li> <li>Acquire/Release\uff1a\u4ec5\u5728\u540c\u6b65\u70b9\u4f7f\u7528</li> </ul>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#_42","title":"\u4f7f\u7528\u573a\u666f\u548c\u6700\u4f73\u5b9e\u8df5","text":""},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#_43","title":"\u4f7f\u7528\u573a\u666f\u7edf\u8ba1","text":"<p>\u6839\u636e\u4ee3\u7801\u5e93\u5206\u6790\uff08577 \u5904 LockHolder \u4f7f\u7528\uff0c93 \u4e2a\u6587\u4ef6\uff09\uff0c\u9501\u7684\u4e3b\u8981\u4f7f\u7528\u573a\u666f\uff1a</p> \u6a21\u5757 \u9501\u7c7b\u578b \u4f7f\u7528\u573a\u666f \u6587\u4ef6\u6570 \u7c7b\u94fe\u63a5\u5668 <code>RecursiveMutex</code> \u56de\u8c03\u51fd\u6570\u573a\u666f\uff0c\u7c7b\u52a0\u8f7d\u4fdd\u62a4 ~10 \u7ebf\u7a0b\u7ba1\u7406 <code>Mutex</code> \u7ebf\u7a0b\u5217\u8868\u3001\u7ebf\u7a0b\u72b6\u6001\u4fdd\u62a4 ~15 \u5185\u5b58\u7ba1\u7406 <code>RWLock</code> / <code>Mutex</code> GC \u64cd\u4f5c\u3001\u5185\u5b58\u5206\u914d\u5668 ~30 \u76d1\u63a7\u5668 <code>Mutex</code> \u5bf9\u8c61\u540c\u6b65\u3001Monitor \u6c60 ~5 \u534f\u7a0b\u7ba1\u7406 <code>RecursiveMutex</code> \u534f\u7a0b\u5de5\u4f5c\u7ebf\u7a0b\u3001\u590d\u6742\u8c03\u7528\u94fe ~8 \u5de5\u5177\u94fe <code>Mutex</code> \u8c03\u8bd5\u5668\u3001\u91c7\u6837\u5668\u3001\u68c0\u67e5\u5668 ~20 \u5176\u4ed6 \u5404\u79cd\u7c7b\u578b \u5b57\u7b26\u4e32\u8868\u3001\u5b9a\u65f6\u5668\u7b49 ~5"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#_44","title":"\u5178\u578b\u4f7f\u7528\u6a21\u5f0f","text":"<p>\u6a21\u5f0f 1\uff1a\u7b80\u5355\u4e34\u754c\u533a\u4fdd\u62a4 <pre><code>class ThreadSafeCounter {\n    Mutex mutex_;\n    int count_ GUARDED_BY(mutex_);\n\npublic:\n    void Increment() {\n        LockHolder lock(mutex_);\n        count_++;\n    }\n};\n</code></pre></p> <p>\u6a21\u5f0f 2\uff1a\u8bfb\u591a\u5199\u5c11\u573a\u666f <pre><code>class SharedData {\n    RWLock rwlock_;\n    Data data_ GUARDED_BY(rwlock_);\n\npublic:\n    Data Read() {\n        ReadLockHolder lock(rwlock_);\n        return data_;\n    }\n\n    void Write(const Data&amp; d) {\n        WriteLockHolder lock(rwlock_);\n        data_ = d;\n    }\n};\n</code></pre></p> <p>\u6a21\u5f0f 3\uff1a\u56de\u8c03\u573a\u666f\uff08\u9700\u8981\u9012\u5f52\u9501\uff09 <pre><code>class ClassLinkerExtension {\n    RecursiveMutex contextsLock_;\n    Vector&lt;Context*&gt; contexts_ GUARDED_BY(contextsLock_);\n\n    void EnumerateClasses(Callback cb) {\n        LockHolder lock(contextsLock_);\n        for (auto* ctx : contexts_) {\n            cb(ctx);  // \u56de\u8c03\u53ef\u80fd\u518d\u6b21\u8c03\u7528 EnumerateClasses\n        }\n    }\n};\n</code></pre></p>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#_45","title":"\u6700\u4f73\u5b9e\u8df5","text":""},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#1_1","title":"1. \u9009\u62e9\u5408\u9002\u7684\u9501\u7c7b\u578b","text":"<pre><code>// \u2705 \u7b80\u5355\u4e34\u754c\u533a\nMutex mutex_;\n\n// \u2705 \u9700\u8981\u9012\u5f52\u52a0\u9501\uff08\u56de\u8c03\u3001\u865a\u51fd\u6570\uff09\nRecursiveMutex recursiveMutex_;\n\n// \u2705 \u8bfb\u591a\u5199\u5c11\nRWLock rwlock_;\n\n// \u2705 \u6761\u4ef6\u7b49\u5f85\nConditionVariable cv_;\nMutex mutex_;\n</code></pre>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#2-raii","title":"2. \u4f7f\u7528 RAII \u5305\u88c5\u5668","text":"<pre><code>// \u2705 \u63a8\u8350\uff1a\u81ea\u52a8\u7ba1\u7406\u9501\u751f\u547d\u5468\u671f\n{\n    LockHolder lock(mutex_);\n    // \u4e34\u754c\u533a\n}\n\n// \u274c \u4e0d\u63a8\u8350\uff1a\u624b\u52a8\u7ba1\u7406\nmutex_.Lock();\n// \u4e34\u754c\u533a\nmutex_.Unlock();  // \u53ef\u80fd\u5fd8\u8bb0\u89e3\u9501\n</code></pre>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#3_1","title":"3. \u907f\u514d\u9012\u5f52\u52a0\u9501\uff08\u5982\u53ef\u80fd\uff09","text":"<pre><code>// \u274c \u9700\u8981\u9012\u5f52\u9501\nclass MyClass {\n    RecursiveMutex mutex_;\n    void PublicMethod() {\n        LockHolder lock(mutex_);\n        PrivateMethod();  // \u5185\u90e8\u518d\u6b21\u52a0\u9501\n    }\n    void PrivateMethod() {\n        LockHolder lock(mutex_);  // \u9012\u5f52\u52a0\u9501\n    }\n};\n\n// \u2705 \u4f18\u5316\uff1a\u6d88\u9664\u9012\u5f52\nclass MyClass {\n    Mutex mutex_;\n    void PublicMethod() {\n        LockHolder lock(mutex_);\n        PrivateMethodImpl();  // \u5185\u90e8\u5b9e\u73b0\uff0c\u4e0d\u52a0\u9501\n    }\nprivate:\n    inline void PrivateMethodImpl() {  // \u5047\u8bbe\u5df2\u6301\u6709\u9501\n        // \u5b9e\u73b0\u903b\u8f91\n    }\n    void PrivateMethod() {  // \u516c\u5f00\u63a5\u53e3\n        LockHolder lock(mutex_);\n        PrivateMethodImpl();\n    }\n};\n</code></pre>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#4-scopedlock","title":"4. \u591a\u9501\u573a\u666f\u4f7f\u7528 ScopedLock","text":"<pre><code>// \u2705 \u63a8\u8350\uff1a\u81ea\u52a8\u6b7b\u9501\u907f\u514d\nScopedLock lock(mutex1_, mutex2_, mutex3_);\n\n// \u274c \u5371\u9669\uff1a\u53ef\u80fd\u6b7b\u9501\nLockHolder lock1(mutex1_);\nLockHolder lock2(mutex2_);\nLockHolder lock3(mutex3_);\n</code></pre>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#5_1","title":"5. \u6700\u5c0f\u5316\u9501\u7c92\u5ea6","text":"<pre><code>// \u274c \u9501\u7c92\u5ea6\u592a\u5927\nvoid ProcessData() {\n    LockHolder lock(mutex_);\n    // \u5927\u91cf\u8ba1\u7b97\uff08\u4e0d\u9700\u8981\u9501\u4fdd\u62a4\uff09\n    // \u5c11\u91cf\u5171\u4eab\u6570\u636e\u8bbf\u95ee\n}\n\n// \u2705 \u9501\u7c92\u5ea6\u5c0f\nvoid ProcessData() {\n    // \u5927\u91cf\u8ba1\u7b97\uff08\u65e0\u9501\uff09\n    {\n        LockHolder lock(mutex_);\n        // \u4ec5\u4fdd\u62a4\u5171\u4eab\u6570\u636e\u8bbf\u95ee\n    }\n}\n</code></pre>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#_46","title":"\u7ebf\u7a0b\u5b89\u5168\u6ce8\u89e3","text":"<p>Ark Runtime \u4f7f\u7528 Clang \u7ebf\u7a0b\u5b89\u5168\u6ce8\u89e3\u8fdb\u884c\u9759\u6001\u5206\u6790\uff1a</p>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#_47","title":"\u6ce8\u89e3\u7c7b\u578b","text":"\u6ce8\u89e3 \u542b\u4e49 \u793a\u4f8b <code>ACQUIRE(lock)</code> \u51fd\u6570\u83b7\u53d6\u9501 <code>void Lock() ACQUIRE();</code> <code>RELEASE(lock)</code> \u51fd\u6570\u91ca\u653e\u9501 <code>void Unlock() RELEASE();</code> <code>TRY_ACQUIRE(true, lock)</code> \u5c1d\u8bd5\u83b7\u53d6\u9501 <code>bool TryLock() TRY_ACQUIRE(true);</code> <code>GUARDED_BY(lock)</code> \u53d8\u91cf\u53d7\u9501\u4fdd\u62a4 <code>int data_ GUARDED_BY(mutex_);</code> <code>SCOPED_CAPABILITY</code> RAII \u9501\u5305\u88c5\u5668 <code>class LockHolder SCOPED_CAPABILITY</code>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#_48","title":"\u4f7f\u7528\u793a\u4f8b","text":"<pre><code>class ThreadSafeCounter {\n    Mutex mutex_;\n    int count_ GUARDED_BY(mutex_);\n\npublic:\n    void Increment() {\n        LockHolder lock(mutex_);  // \u81ea\u52a8\u5206\u6790\n        count_++;  // \u2705 \u6b63\u786e\uff1a\u5728\u9501\u4fdd\u62a4\u4e0b\n    }\n\n    int GetCount() {\n        // count_;  // \u274c \u9519\u8bef\uff1a\u672a\u6301\u6709\u9501\n        LockHolder lock(mutex_);\n        return count_;  // \u2705 \u6b63\u786e\n    }\n};\n</code></pre>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#_49","title":"\u7279\u6b8a\u529f\u80fd","text":""},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#lockforother-unlockforother","title":"LockForOther / UnlockForOther","text":"<p>\u8fd9\u4e24\u4e2a\u65b9\u6cd5\u7528\u4e8e Monitor \u7cfb\u7edf\uff0c\u5141\u8bb8\u4e3a\u5176\u4ed6\u7ebf\u7a0b\u52a0\u9501/\u89e3\u9501\uff1a</p> <pre><code>// \u4e3a\u6307\u5b9a\u7ebf\u7a0b\u52a0\u9501\uff08\u4ec5\u7528\u4e8e\u65b0\u521b\u5efa\u7684 mutex\uff09\nvoid LockForOther(ThreadId thread);\n\n// \u4e3a\u6307\u5b9a\u7ebf\u7a0b\u89e3\u9501\nvoid UnlockForOther(ThreadId thread);\n</code></pre> <p>\u4f7f\u7528\u573a\u666f\uff1a - Monitor \u5bf9\u8c61\u521d\u59cb\u5316\u65f6\uff0c\u9700\u8981\u5c06\u9501\u8f6c\u79fb\u7ed9\u7279\u5b9a\u7ebf\u7a0b - \u7ebf\u7a0b\u72b6\u6001\u8f6c\u6362\u65f6\u7684\u9501\u6240\u6709\u6743\u8f6c\u79fb</p> <p>\u6ce8\u610f\u4e8b\u9879\uff1a - \u4ec5\u7528\u4e8e\u65b0\u521b\u5efa\u7684\u3001\u5c1a\u672a\u4f7f\u7528\u7684 mutex - \u5fc5\u987b\u786e\u4fdd\u76ee\u6807\u7ebf\u7a0b\u5904\u4e8e\u975e\u8fd0\u884c\u72b6\u6001 - \u4e3b\u8981\u7528\u4e8e\u8fd0\u884c\u65f6\u5185\u90e8\uff0c\u4e0d\u5efa\u8bae\u7528\u6237\u4ee3\u7801\u4f7f\u7528</p>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#trylockwithspinning","title":"TryLockWithSpinning","text":"<p>\u5e26\u81ea\u65cb\u7684\u5c1d\u8bd5\u52a0\u9501\uff1a</p> <pre><code>bool TryLockWithSpinning();\n</code></pre> <p>\u5b9e\u73b0\uff1a\u6700\u591a\u5c1d\u8bd5 10 \u6b21\uff0c\u6bcf\u6b21\u5c1d\u8bd5\u4e4b\u95f4\u8fdb\u884c\u77ed\u6682\u81ea\u65cb\u7b49\u5f85\u3002</p> <p>\u7528\u9014\uff1a\u5728\u9884\u671f\u9501\u5f88\u5feb\u91ca\u653e\u7684\u573a\u666f\u4e0b\uff0c\u907f\u514d\u7acb\u5373\u5931\u8d25\u3002</p>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#_50","title":"\u5e38\u89c1\u95ee\u9898\u548c\u89e3\u51b3\u65b9\u6848","text":""},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#1-vs","title":"1. \u9012\u5f52\u9501 vs \u666e\u901a\u9501","text":"<p>\u95ee\u9898\uff1a\u4f55\u65f6\u4f7f\u7528 RecursiveMutex\uff1f</p> <p>\u7b54\u6848\uff1a - \u9700\u8981\u9012\u5f52\u9501\uff1a\u56de\u8c03\u51fd\u6570\u3001\u865a\u51fd\u6570\u3001\u7b2c\u4e09\u65b9\u5e93\u96c6\u6210 - \u53ef\u4ee5\u4f18\u5316\uff1a\u7b80\u5355\u7c7b\u5185\u90e8\u65b9\u6cd5\uff0c\u901a\u8fc7\u91cd\u6784\u6d88\u9664\u9012\u5f52</p> <p>\u6027\u80fd\u5f71\u54cd\uff1a\u975e\u9012\u5f52\u573a\u666f\u4e0b\u6027\u80fd\u5dee\u5f02 &lt; 5%</p>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#2_1","title":"2. \u6b7b\u9501\u95ee\u9898","text":"<p>\u95ee\u9898\uff1a\u5982\u4f55\u907f\u514d\u6b7b\u9501\uff1f</p> <p>\u89e3\u51b3\u65b9\u6848\uff1a 1. \u4f7f\u7528 <code>ScopedLock</code> \u81ea\u52a8\u907f\u514d\u6b7b\u9501 2. \u56fa\u5b9a\u9501\u7684\u83b7\u53d6\u987a\u5e8f 3. \u6700\u5c0f\u5316\u540c\u65f6\u6301\u6709\u7684\u9501\u6570\u91cf 4. \u4f7f\u7528\u8d85\u65f6\u673a\u5236\uff08<code>TryLock</code>\uff09</p>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#3_2","title":"3. \u6027\u80fd\u4f18\u5316","text":"<p>\u95ee\u9898\uff1a\u5982\u4f55\u63d0\u5347\u9501\u6027\u80fd\uff1f</p> <p>\u5efa\u8bae\uff1a 1. \u51cf\u5c11\u9501\u7ade\u4e89\uff1a\u7f29\u5c0f\u4e34\u754c\u533a 2. \u4f7f\u7528 RWLock\uff1a\u8bfb\u591a\u5199\u5c11\u573a\u666f 3. \u907f\u514d\u4e0d\u5fc5\u8981\u7684\u9012\u5f52\u9501 4. \u4f7f\u7528\u5185\u8054\u51fd\u6570\uff1a\u51cf\u5c11\u8c03\u7528\u5f00\u9500</p>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#4_1","title":"4. \u8c03\u8bd5\u6280\u5de7","text":"<p>\u95ee\u9898\uff1a\u5982\u4f55\u8c03\u8bd5\u9501\u76f8\u5173\u95ee\u9898\uff1f</p> <p>\u5de5\u5177\uff1a 1. \u7ebf\u7a0b\u5b89\u5168\u5206\u6790\uff1a\u542f\u7528 Clang \u7ebf\u7a0b\u5b89\u5168\u6ce8\u89e3 2. \u6b7b\u9501\u68c0\u6d4b\uff1a\u4f7f\u7528 <code>DoNotCheckOnTerminationLoop()</code> \u8c03\u8bd5 3. \u6027\u80fd\u5206\u6790\uff1a\u4f7f\u7528 profiler \u5206\u6790\u9501\u7ade\u4e89</p>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#_51","title":"\u5b9e\u73b0\u7ec6\u8282\u53c2\u8003","text":""},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#_52","title":"\u5173\u952e\u6587\u4ef6","text":"<ul> <li>\u7edf\u4e00\u63a5\u53e3\uff1a<code>libarkbase/os/mutex.h</code> - \u63d0\u4f9b\u7edf\u4e00\u7684\u9501\u63a5\u53e3\u548c RAII \u5305\u88c5\u5668</li> <li>Futex \u5b9e\u73b0\uff1a</li> <li><code>platforms/unix/libarkbase/futex/mutex.h</code> - Mutex/RWLock/ConditionVariable \u7c7b\u5b9a\u4e49</li> <li><code>platforms/unix/libarkbase/futex/fmutex.h</code> - \u5e95\u5c42 fmutex \u7ed3\u6784\u5b9a\u4e49</li> <li><code>platforms/unix/libarkbase/futex/fmutex.cpp</code> - \u6838\u5fc3\u5b9e\u73b0\u903b\u8f91</li> <li><code>platforms/unix/libarkbase/futex/mutex.cpp</code> - \u7c7b\u65b9\u6cd5\u5b9e\u73b0</li> <li>pthread \u5b9e\u73b0\uff1a<code>libarkbase/os/mutex.cpp</code> - \u975e Linux \u5e73\u53f0\u7684 pthread \u5305\u88c5\u5b9e\u73b0</li> </ul>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#_53","title":"\u5173\u952e\u5e38\u91cf","text":"<pre><code>// Futex \u64cd\u4f5c\nstatic constexpr int WAKE_ONE = 1;\nstatic constexpr int WAKE_ALL = INT_MAX;\n\n// \u72b6\u6001\u7f16\u7801\nstatic constexpr int32_t HELD_MASK = 1;           // \u9501\u5b9a\u4f4d\nstatic constexpr int32_t WAITER_SHIFT = 1;        // \u7b49\u5f85\u8005\u8ba1\u6570\u504f\u79fb\nstatic constexpr int32_t WAITER_INCREMENT = 1 &lt;&lt; WAITER_SHIFT;\n\n// RWLock \u72b6\u6001\nstatic constexpr int32_t WRITE_LOCKED = -1;\nstatic constexpr int32_t UNLOCKED = 0;\nstatic constexpr int32_t READ_INCREMENT = 1;\n</code></pre>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#_54","title":"\u7ebf\u7a0b\u672c\u5730\u5b58\u50a8","text":"<pre><code>// \u907f\u514d\u91cd\u590d\u8c03\u7528 GetCurrentThreadId\nthread_local ark::os::thread::ThreadId current_tid {0};\n</code></pre> <p>\u4f18\u5316\u539f\u56e0\uff1a<code>GetCurrentThreadId()</code> \u53ef\u80fd\u6d89\u53ca\u7cfb\u7edf\u8c03\u7528\uff0c\u4f7f\u7528 TLS \u7f13\u5b58\u53ef\u4ee5\u663e\u8457\u63d0\u5347\u6027\u80fd\u3002</p> <p>Fork \u5904\u7406\uff1a<code>PostFork()</code> \u51fd\u6570\u5728 fork \u540e\u66f4\u65b0 TLS\uff0c\u786e\u4fdd\u7ebf\u7a0b ID \u6b63\u786e\u3002</p>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#_55","title":"\u603b\u7ed3","text":"<p>Ark Runtime \u7684\u9501\u5b9e\u73b0\u5177\u6709\u4ee5\u4e0b\u7279\u70b9\uff1a</p> <ol> <li>\u9ad8\u6027\u80fd\uff1a\u57fa\u4e8e futex \u7684\u4f18\u5316\u5b9e\u73b0\uff0c\u5feb\u901f\u8def\u5f84\u4ec5\u9700\u4e00\u6b21 CAS</li> <li>\u5185\u5b58\u9ad8\u6548\uff1a\u7d27\u51d1\u7684\u6570\u636e\u7ed3\u6784\uff0c\u6700\u5c0f\u5316\u5185\u5b58\u5360\u7528</li> <li>\u529f\u80fd\u5b8c\u6574\uff1a\u652f\u6301 Mutex\u3001RecursiveMutex\u3001RWLock\u3001ConditionVariable</li> <li>\u6613\u4e8e\u4f7f\u7528\uff1a\u4e30\u5bcc\u7684 RAII \u5305\u88c5\u5668\u548c\u6b7b\u9501\u907f\u514d\u7b97\u6cd5</li> <li>\u7c7b\u578b\u5b89\u5168\uff1a\u96c6\u6210 Clang \u7ebf\u7a0b\u5b89\u5168\u6ce8\u89e3</li> </ol>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#_56","title":"\u6027\u80fd\u5bf9\u6bd4","text":""},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#_57","title":"\u64cd\u4f5c\u6027\u80fd\u5bf9\u6bd4","text":"\u64cd\u4f5c Mutex RecursiveMutex RWLock (\u8bfb) RWLock (\u5199) \u65e0\u7ade\u4e89\u52a0\u9501 1 CAS (~10ns) 1 CAS + 1 \u68c0\u67e5 (~12ns) 1 CAS (~10ns) 1 CAS (~10ns) \u9012\u5f52\u52a0\u9501 \u6b7b\u9501 2 \u6b21\u5185\u5b58\u64cd\u4f5c (~5ns) N/A N/A \u6709\u7ade\u4e89\u52a0\u9501 \u81ea\u65cb + futex \u81ea\u65cb + futex \u81ea\u65cb + futex \u81ea\u65cb + futex \u89e3\u9501 1 CAS + \u6761\u4ef6\u5524\u9192 1 CAS + \u6761\u4ef6\u5524\u9192 1 CAS + \u6761\u4ef6\u5524\u9192 1 CAS + \u6279\u91cf\u5524\u9192 \u5185\u5b58\u5360\u7528 16 \u5b57\u8282 16 \u5b57\u8282 16 \u5b57\u8282 16 \u5b57\u8282"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#_58","title":"\u573a\u666f\u6027\u80fd\u5bf9\u6bd4","text":"\u573a\u666f Mutex RecursiveMutex RWLock \u63a8\u8350 \u65e0\u7ade\u4e89 1 CAS 1 CAS + \u68c0\u67e5 1 CAS Mutex \u9012\u5f52\u52a0\u9501 \u6b7b\u9501 \u274c \u5feb\u901f\u8def\u5f84 \u2705 N/A RecursiveMutex \u8bfb\u591a\u5199\u5c11 \u4e32\u884c \u4e32\u884c \u5e76\u884c\u8bfb\u53d6 \u2705 RWLock \u5199\u591a\u8bfb\u5c11 \u4e32\u884c \u4e32\u884c \u4e32\u884c Mutex \u9ad8\u7ade\u4e89 \u81ea\u65cb + futex \u81ea\u65cb + futex \u81ea\u65cb + futex \u76f8\u540c"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#_59","title":"\u6027\u80fd\u4f18\u5316\u6548\u679c","text":"<ul> <li>\u5feb\u901f\u8def\u5f84\uff1a\u65e0\u7ade\u4e89\u65f6\u6027\u80fd\u63d0\u5347 10-100 \u500d\uff08\u907f\u514d\u7cfb\u7edf\u8c03\u7528\uff09</li> <li>\u81ea\u65cb\u7b49\u5f85\uff1a\u77ed\u65f6\u95f4\u7b49\u5f85\u6027\u80fd\u63d0\u5347 2-5 \u500d\uff08\u907f\u514d\u4e0a\u4e0b\u6587\u5207\u6362\uff09</li> <li>RWLock\uff1a\u8bfb\u591a\u5199\u5c11\u573a\u666f\u6027\u80fd\u63d0\u5347 N \u500d\uff08N = \u8bfb\u8005\u6570\u91cf\uff09</li> <li>\u5185\u8054\u4f18\u5316\uff1a\u5173\u952e\u8def\u5f84\u6027\u80fd\u63d0\u5347 5-10%\uff08\u51cf\u5c11\u51fd\u6570\u8c03\u7528\u5f00\u9500\uff09</li> </ul>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#_60","title":"\u8bbe\u8ba1\u539f\u5219","text":"<ol> <li>\u6027\u80fd\u4f18\u5148\uff1a\u5feb\u901f\u8def\u5f84\u4f18\u5316\uff0c\u6700\u5c0f\u5316\u7cfb\u7edf\u8c03\u7528</li> <li>\u5b89\u5168\u6027\uff1a\u6b7b\u9501\u907f\u514d\uff0c\u7ebf\u7a0b\u5b89\u5168\u6ce8\u89e3</li> <li>\u6613\u7528\u6027\uff1aRAII \u5305\u88c5\u5668\uff0c\u81ea\u52a8\u8d44\u6e90\u7ba1\u7406</li> <li>\u53ef\u7ef4\u62a4\u6027\uff1a\u6e05\u6670\u7684\u4ee3\u7801\u7ed3\u6784\uff0c\u5b8c\u5584\u7684\u6ce8\u91ca</li> </ol>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#_61","title":"\u9644\u5f55","text":""},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#a","title":"A. \u6027\u80fd\u57fa\u51c6\u6d4b\u8bd5\u5efa\u8bae","text":"<ol> <li>\u65e0\u7ade\u4e89\u573a\u666f\uff1a\u6d4b\u8bd5\u5feb\u901f\u8def\u5f84\u6027\u80fd</li> <li>\u9ad8\u7ade\u4e89\u573a\u666f\uff1a\u6d4b\u8bd5\u81ea\u65cb\u548c futex \u7b49\u5f85\u6027\u80fd</li> <li>\u9012\u5f52\u52a0\u9501\uff1a\u5bf9\u6bd4 RecursiveMutex \u548c Mutex \u7684\u6027\u80fd\u5dee\u5f02</li> <li>\u8bfb\u591a\u5199\u5c11\uff1a\u6d4b\u8bd5 RWLock \u76f8\u6bd4 Mutex \u7684\u6027\u80fd\u63d0\u5347</li> </ol>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#b","title":"B. \u4ee3\u7801\u5ba1\u67e5\u68c0\u67e5\u6e05\u5355","text":"<ul> <li>[ ] \u662f\u5426\u4f7f\u7528\u4e86\u5408\u9002\u7684\u9501\u7c7b\u578b\uff1f</li> <li>[ ] \u662f\u5426\u4f7f\u7528\u4e86 RAII \u5305\u88c5\u5668\uff1f</li> <li>[ ] \u591a\u9501\u573a\u666f\u662f\u5426\u4f7f\u7528\u4e86 ScopedLock\uff1f</li> <li>[ ] \u662f\u5426\u6dfb\u52a0\u4e86\u7ebf\u7a0b\u5b89\u5168\u6ce8\u89e3\uff1f</li> <li>[ ] \u9501\u7c92\u5ea6\u662f\u5426\u8db3\u591f\u5c0f\uff1f</li> <li>[ ] \u662f\u5426\u907f\u514d\u4e86\u4e0d\u5fc5\u8981\u7684\u9012\u5f52\u9501\uff1f</li> </ul>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#c","title":"C. \u5b9e\u9645\u4ee3\u7801\u793a\u4f8b","text":""},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#1_2","title":"\u793a\u4f8b 1\uff1a\u7c7b\u94fe\u63a5\u5668\u4e2d\u7684\u9012\u5f52\u9501\u4f7f\u7528","text":"<pre><code>// runtime/include/class_linker_extension.h\nclass ClassLinkerExtension {\n    RecursiveMutex contextsLock_;\n    PandaVector&lt;ClassLinkerContext *&gt; contexts_ GUARDED_BY(contextsLock_);\n\n    bool EnumerateClasses(Callback cb) {\n        // \u7b2c\u4e00\u6b21\u52a0\u9501\n        {\n            LockHolder lock(contextsLock_);\n            for (auto *ctx : contexts_) {\n                // \u56de\u8c03\u53ef\u80fd\u518d\u6b21\u8c03\u7528 EnumerateClasses\uff0c\u9700\u8981\u9012\u5f52\u9501\n                if (!ctx-&gt;EnumerateClasses(cb)) {\n                    return false;\n                }\n            }\n        }\n        return true;\n    }\n};\n</code></pre>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#2_2","title":"\u793a\u4f8b 2\uff1a\u5185\u5b58\u7ba1\u7406\u4e2d\u7684\u8bfb\u5199\u9501","text":"<pre><code>// runtime/mem/rem_set.h\nclass RemSet {\n    using CommonLock = os::memory::RecursiveMutex;  // \u6216 RWLock\n\n    void AddReference(ObjectHeader *from, ObjectHeader *to) {\n        WriteLockHolder lock(lock_);  // \u5199\u9501\n        // \u6dfb\u52a0\u5f15\u7528\n    }\n\n    void VisitReferences(Visitor visitor) {\n        ReadLockHolder lock(lock_);  // \u8bfb\u9501\uff0c\u5141\u8bb8\u591a\u4e2a\u8bfb\u8005\n        // \u904d\u5386\u5f15\u7528\n    }\n};\n</code></pre>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#3_3","title":"\u793a\u4f8b 3\uff1a\u591a\u9501\u573a\u666f\u7684\u6b7b\u9501\u907f\u514d","text":"<pre><code>void TransferFunds(Account &amp;from, Account &amp;to, int amount) {\n    // \u81ea\u52a8\u6b7b\u9501\u907f\u514d\uff1a\u6309\u5730\u5740\u6392\u5e8f\u52a0\u9501\n    ScopedLock lock(from.mutex_, to.mutex_);\n\n    from.balance_ -= amount;\n    to.balance_ += amount;\n    // \u6790\u6784\u65f6\u81ea\u52a8\u6309\u76f8\u53cd\u987a\u5e8f\u89e3\u9501\n}\n</code></pre>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#4_2","title":"\u793a\u4f8b 4\uff1a\u6761\u4ef6\u53d8\u91cf\u4f7f\u7528","text":"<pre><code>class ProducerConsumer {\n    Mutex mutex_;\n    ConditionVariable cv_;\n    Queue queue_ GUARDED_BY(mutex_);\n\n    void Produce(Item item) {\n        LockHolder lock(mutex_);\n        queue_.push(item);\n        cv_.Signal();  // \u901a\u77e5\u6d88\u8d39\u8005\n    }\n\n    Item Consume() {\n        LockHolder lock(mutex_);\n        while (queue_.empty()) {\n            cv_.Wait(&amp;mutex_);  // \u7b49\u5f85\u6761\u4ef6\n        }\n        Item item = queue_.front();\n        queue_.pop();\n        return item;\n    }\n};\n</code></pre>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#d","title":"D. \u76f8\u5173\u8d44\u6e90","text":"<ul> <li>Linux Futex \u6587\u6863\uff1a<code>man 2 futex</code></li> <li>Clang \u7ebf\u7a0b\u5b89\u5168\u6ce8\u89e3\uff1ahttps://clang.llvm.org/docs/ThreadSafetyAnalysis.html</li> <li>\u5185\u5b58\u5e8f\u8bed\u4e49\uff1aC++11 \u5185\u5b58\u6a21\u578b</li> <li>Futex \u8bba\u6587\uff1aFutexes Are Tricky (Ulrich Drepper)</li> </ul> <p>\u6587\u6863\u7248\u672c\uff1a1.0 \u6700\u540e\u66f4\u65b0\uff1a2025-01-XX \u7ef4\u62a4\u8005\uff1aArk Runtime Team</p>"},{"location":"arkcompiler/TRACE_COMPLETE_GUIDE/","title":"ARK Runtime Trace \u5b8c\u6574\u6307\u5357","text":"<p>\u672c\u6587\u6863\u6db5\u76d6 Trace \u7cfb\u7edf\u7684\u5b9e\u73b0\u539f\u7406\u3001\u4f7f\u7528\u65b9\u6cd5\u3001\u53ef\u89c6\u5316\u5de5\u5177\u548c\u9ad8\u7ea7\u6280\u5de7</p>"},{"location":"arkcompiler/TRACE_COMPLETE_GUIDE/#1-trace","title":"1. Trace \u7cfb\u7edf\u67b6\u6784","text":""},{"location":"arkcompiler/TRACE_COMPLETE_GUIDE/#11","title":"1.1 \u4e09\u5c42\u67b6\u6784","text":"<p>ARK \u7684 Trace \u7cfb\u7edf\u91c7\u7528\u4e09\u5c42\u67b6\u6784\uff1a</p> <pre><code>graph TD\n    A[\"\u5e94\u7528\u5c42: ark::Tracer&lt;br&gt;Tracer::Start('name')&lt;br&gt;Tracer::Finish()\"]\n    B[\"C\u63a5\u53e3\u5c42: StartTrace/FinishTrace&lt;br&gt;(\u6761\u4ef6\u7f16\u8bd1: HiTrace \u6216 ftrace)\"]\n    C[\"\u5b9e\u73b0\u5c42: ark::trace&lt;br&gt;BeginTracePoint/EndTracePoint&lt;br&gt;\u2192 /sys/kernel/debug/tracing/\"]\n\n    A --&gt; B\n    B --&gt; C</code></pre>"},{"location":"arkcompiler/TRACE_COMPLETE_GUIDE/#12","title":"1.2 \u6838\u5fc3\u6587\u4ef6","text":"\u6587\u4ef6 \u4f5c\u7528 <code>runtime/trace.h</code> Tracer \u7c7b\u5b9a\u4e49\uff0c\u6761\u4ef6\u7f16\u8bd1\u9009\u62e9\u5b9e\u73b0 <code>libarkbase/trace/trace.h</code> ark::trace \u547d\u540d\u7a7a\u95f4 API <code>platforms/unix/libarkbase/trace.cpp</code> ftrace \u5b9e\u73b0\uff08Linux\uff09"},{"location":"arkcompiler/TRACE_COMPLETE_GUIDE/#13","title":"1.3 \u5173\u952e\u5b9e\u73b0\u7ec6\u8282","text":""},{"location":"arkcompiler/TRACE_COMPLETE_GUIDE/#tracer-runtimetraceh","title":"Tracer \u7c7b\uff08runtime/trace.h\uff09","text":"<pre><code>namespace ark {\nclass Tracer {\npublic:\n    static void Start(const std::string &amp;name, float limit = -1) {\n        StartTrace(TRACER_TAG, name, limit);\n    }\n\n    static void Finish() {\n        FinishTrace(TRACER_TAG);\n    }\n\n    static void Count(const std::string &amp;name, int64_t count) {\n        CountTrace(TRACER_TAG, name, count);\n    }\n};\n}\n</code></pre>"},{"location":"arkcompiler/TRACE_COMPLETE_GUIDE/#_1","title":"\u6761\u4ef6\u7f16\u8bd1\u903b\u8f91","text":"<p>\u5f53\u672a\u5b9a\u4e49 <code>PANDA_USE_HITRACE</code> \u65f6\uff08Linux \u9ed8\u8ba4\uff09\uff1a</p> <pre><code>// runtime/trace.h\n#include \"libarkbase/trace/trace.h\"\n\ninline void StartTrace(uint64_t tag, const std::string &amp;name, float limit = -1) {\n    ark::trace::BeginTracePoint(name.c_str());  // \u8c03\u7528 ftrace\n}\n\ninline void FinishTrace(uint64_t tag) {\n    ark::trace::EndTracePoint();  // \u8c03\u7528 ftrace\n}\n</code></pre> <p>\u5f53\u5b9a\u4e49 <code>PANDA_USE_HITRACE</code> \u65f6\uff08HarmonyOS\uff09\uff1a</p> <pre><code>#include \"hitrace_meter/hitrace_meter.h\"\n// \u4f7f\u7528 HiTrace API\n</code></pre>"},{"location":"arkcompiler/TRACE_COMPLETE_GUIDE/#ftrace-platformsunixlibarkbasetracecpp","title":"ftrace \u5b9e\u73b0\uff08platforms/unix/libarkbase/trace.cpp\uff09","text":"<pre><code>// \u521d\u59cb\u5316\uff1a\u68c0\u67e5\u73af\u5883\u53d8\u91cf\nbool DoInit() {\n    const char *pandaTraceVal = std::getenv(\"PANDA_TRACE\");\n    if (pandaTraceVal == nullptr || strcmp(pandaTraceVal, \"1\") != 0) {\n        return false;\n    }\n\n    g_traceMarkerFd = open(\"/sys/kernel/debug/tracing/trace_marker\", O_WRONLY);\n    return g_traceMarkerFd != -1;\n}\n\n// \u5199\u5165 trace \u70b9\nvoid DoBeginTracePoint(const char *str) {\n    dprintf(g_traceMarkerFd, \"B|%d|%s\", getpid(), str);\n}\n\nvoid DoEndTracePoint() {\n    dprintf(g_traceMarkerFd, \"E|\");\n}\n</code></pre>"},{"location":"arkcompiler/TRACE_COMPLETE_GUIDE/#14-trace","title":"1.4 Trace \u683c\u5f0f","text":"<p>ftrace \u4f7f\u7528\u6807\u51c6\u683c\u5f0f\uff1a</p> <ul> <li>Begin: <code>B|&lt;pid&gt;|&lt;name&gt;</code> - \u5f00\u59cb\u4e00\u4e2a trace \u70b9</li> <li>End: <code>E|</code> - \u7ed3\u675f\u5f53\u524d trace \u70b9\uff08LIFO \u6808\u7ed3\u6784\uff09</li> <li>Counter: <code>C|&lt;pid&gt;|&lt;name&gt;|&lt;value&gt;</code> - \u8ba1\u6570\u5668\u7c7b\u578b</li> </ul> <p>\u5173\u952e\u7279\u6027\uff1a - \u2705 \u652f\u6301\u5d4c\u5957\uff1aftrace \u4f7f\u7528\u6808\u7ed3\u6784\uff0c\u5b8c\u5168\u652f\u6301\u5d4c\u5957\u7684 Begin/End \u5bf9 - \u2705 \u7ebf\u7a0b\u5b89\u5168\uff1a\u6bcf\u4e2a\u8fdb\u7a0b\u72ec\u7acb\uff0c\u901a\u8fc7 PID \u533a\u5206 - \u2705 \u9ad8\u6027\u80fd\uff1a\u5199\u5165\u5185\u5b58 ring buffer\uff0c\u7eb3\u79d2\u7ea7\u5ef6\u8fdf</p>"},{"location":"arkcompiler/TRACE_COMPLETE_GUIDE/#15-trace","title":"1.5 \u5d4c\u5957 Trace \u793a\u4f8b","text":"<pre><code>void MyFunction() {\n    Tracer::Start(\"MyFunction\");        // Begin \"MyFunction\"\n\n    Tracer::Start(\"Step1\");            // Begin \"Step1\"\n    DoStep1();\n    Tracer::Finish();                  // End \"Step1\"\n\n    Tracer::Start(\"Step2\");            // Begin \"Step2\"\n    DoStep2();\n    Tracer::Finish();                  // End \"Step2\"\n\n    Tracer::Finish();                  // End \"MyFunction\"\n}\n</code></pre> <p>\u8f93\u51fa\u5230 ftrace\uff1a <pre><code>B|1234|MyFunction\nB|1234|Step1\nE|\nB|1234|Step2\nE|\nE|\n</code></pre></p> <p>\u53ef\u89c6\u5316\u6548\u679c\uff08Perfetto\uff09\uff1a <pre><code>MyFunction \u2503 \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\n  Step1    \u2503    \u2588\u2588\u2588\u2588\n  Step2    \u2503        \u2588\u2588\u2588\u2588\u2588\u2588\n</code></pre></p>"},{"location":"arkcompiler/TRACE_COMPLETE_GUIDE/#2-linux-trace","title":"2. \u5728 Linux \u4e0a\u6293\u53d6 Trace","text":""},{"location":"arkcompiler/TRACE_COMPLETE_GUIDE/#21","title":"2.1 \u524d\u7f6e\u6761\u4ef6","text":"<ol> <li>WSL2/Linux \u73af\u5883</li> <li>Root \u6743\u9650\uff08\u8bbf\u95ee <code>/sys/kernel/debug/tracing</code>\uff09</li> <li>ftrace \u5df2\u542f\u7528\uff08WSL2 \u9ed8\u8ba4\u542f\u7528\uff09</li> </ol>"},{"location":"arkcompiler/TRACE_COMPLETE_GUIDE/#22","title":"2.2 \u5b8c\u6574\u6d41\u7a0b","text":""},{"location":"arkcompiler/TRACE_COMPLETE_GUIDE/#1-ftrace-1","title":"\u6b65\u9aa41\uff1a\u542f\u52a8 ftrace \u6536\u96c6\uff08\u7ec8\u7aef1\uff09","text":"<pre><code># \u4f7f\u7528\u63d0\u4f9b\u7684\u811a\u672c\uff08WSL2 \u517c\u5bb9\uff09\nsudo /path/to/scripts/trace_enable_wsl2.sh output.trace 60 8192\n\n# \u53c2\u6570\u8bf4\u660e\uff1a\n#   output.trace - \u8f93\u51fa\u6587\u4ef6\u540d\n#   60 - \u8ddf\u8e2a\u65f6\u957f\uff08\u79d2\uff09\uff0c\u53ef\u968f\u65f6 Ctrl+C \u63d0\u524d\u7ed3\u675f\n#   8192 - \u7f13\u51b2\u533a\u5927\u5c0f\uff08KB\uff09\uff0c\u9ed8\u8ba4 8MB\n</code></pre>"},{"location":"arkcompiler/TRACE_COMPLETE_GUIDE/#22_1","title":"\u6b65\u9aa42\uff1a\u8fd0\u884c\u7a0b\u5e8f\uff08\u7ec8\u7aef2\uff09","text":"<pre><code># \u5173\u952e\uff1a\u5fc5\u987b\u8bbe\u7f6e\u73af\u5883\u53d8\u91cf PANDA_TRACE=1\nPANDA_TRACE=1 sudo -E ./your_program\n\n# \u6ce8\u610f\uff1a\n# - \u4f7f\u7528 sudo -E \u4fdd\u7559\u73af\u5883\u53d8\u91cf\n# - \u6216\u8005\u76f4\u63a5\u5728 root shell \u4e2d\uff1a\nsudo su\nexport PANDA_TRACE=1\n./your_program\n</code></pre>"},{"location":"arkcompiler/TRACE_COMPLETE_GUIDE/#3","title":"\u6b65\u9aa43\uff1a\u67e5\u770b\u7ed3\u679c","text":"<p>\u65b9\u6cd51\uff1aPerfetto UI\uff08\u63a8\u8350\uff09 1. \u8bbf\u95ee\uff1ahttps://ui.perfetto.dev/ 2. \u70b9\u51fb \"Open trace file\" 3. \u9009\u62e9 <code>output.trace</code> 4. \u67e5\u770b\u53ef\u89c6\u5316\u65f6\u95f4\u7ebf</p> <p>\u65b9\u6cd52\uff1aChrome Tracing 1. \u8f6c\u6362\u683c\u5f0f\uff08\u5982\u9700\u8981\uff09\uff1a    <pre><code>python3 ftrace_to_json.py output.trace output.json\n</code></pre> 2. \u6253\u5f00 <code>chrome://tracing</code> 3. \u52a0\u8f7d <code>output.json</code></p>"},{"location":"arkcompiler/TRACE_COMPLETE_GUIDE/#23-wsl2","title":"2.3 WSL2 \u7279\u6b8a\u8bf4\u660e","text":"<p>\u5728 WSL2 \u4e2d\uff0c<code>/sys/kernel/debug/tracing</code> \u76ee\u5f55\u6743\u9650\u65e0\u6cd5\u901a\u8fc7 <code>chmod</code> \u4fee\u6539\uff0c\u4f46\uff1a - \u2705 \u4ee5 root \u8eab\u4efd\u53ef\u4ee5\u76f4\u63a5\u8bbf\u95ee - \u2705 <code>trace_marker</code> \u6587\u4ef6\u672c\u8eab\u662f\u53ef\u5199\u7684 - \u2705 \u4f7f\u7528\u63d0\u4f9b\u7684 <code>trace_enable_wsl2.sh</code> \u811a\u672c\uff08\u8df3\u8fc7\u6743\u9650\u8bbe\u7f6e\uff09</p>"},{"location":"arkcompiler/TRACE_COMPLETE_GUIDE/#24-trace","title":"2.4 \u9a8c\u8bc1 Trace \u662f\u5426\u751f\u6548","text":"<pre><code># \u68c0\u67e5 trace \u6587\u4ef6\u4e2d\u662f\u5426\u6709\u60a8\u7684\u6807\u8bb0\ngrep \"fzw::GetClass\" output.trace\n\n# \u68c0\u67e5\u662f\u5426\u6709 trace_marker \u5199\u5165\ngrep \"tracing_mark_write\" output.trace\n\n# \u5982\u679c\u90fd\u6ca1\u6709\uff0c\u68c0\u67e5\uff1a\n# 1. \u662f\u5426\u8bbe\u7f6e\u4e86 PANDA_TRACE=1\n# 2. \u7a0b\u5e8f\u662f\u5426\u771f\u7684\u8c03\u7528\u4e86 Tracer::Start/Finish\n# 3. \u662f\u5426\u6709 root \u6743\u9650\n</code></pre>"},{"location":"arkcompiler/TRACE_COMPLETE_GUIDE/#3-perf-vs-trace","title":"3. Perf vs Trace \u539f\u7406\u5bf9\u6bd4","text":""},{"location":"arkcompiler/TRACE_COMPLETE_GUIDE/#31-perf","title":"3.1 Perf\uff08\u91c7\u6837\uff09","text":""},{"location":"arkcompiler/TRACE_COMPLETE_GUIDE/#_2","title":"\u539f\u7406","text":"<pre><code>\u65f6\u95f4\u8f74 \u2192\n\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\n     \u2193      \u2193      \u2193      \u2193      \u2193\n   \u91c7\u68371   \u91c7\u68372   \u91c7\u68373   \u91c7\u68374   \u91c7\u68375\n\n\u6bcf\u6b21\u91c7\u6837\u65f6\uff1a\n1. \u5185\u6838\u6536\u5230\u65f6\u949f\u4e2d\u65ad\uff08timer interrupt\uff09\n2. \u8bfb\u53d6 CPU \u5bc4\u5b58\u5668\uff08RIP/EIP - \u6307\u4ee4\u6307\u9488\uff09\n3. \u904d\u5386\u6808\u5e27\uff08stack unwinding\uff09\n4. \u8bb0\u5f55\u5b8c\u6574\u8c03\u7528\u6808\n</code></pre>"},{"location":"arkcompiler/TRACE_COMPLETE_GUIDE/#_3","title":"\u6570\u636e\u6765\u6e90","text":"<ul> <li>\u5bc4\u5b58\u5668\uff1aRIP/EIP\uff08\u5f53\u524d\u6267\u884c\u4f4d\u7f6e\uff09\u3001RSP/ESP\uff08\u6808\u6307\u9488\uff09</li> <li>\u6808\u5185\u5b58\uff1a\u8fd4\u56de\u5730\u5740\u94fe</li> <li>\u7b26\u53f7\u8868\uff1a\u5c06\u5730\u5740\u8f6c\u6362\u4e3a\u51fd\u6570\u540d</li> <li>\u6027\u80fd\u8ba1\u6570\u5668\uff08PMU\uff09\uff1aCPU cycles\u3001cache miss \u7b49</li> </ul>"},{"location":"arkcompiler/TRACE_COMPLETE_GUIDE/#_4","title":"\u7279\u70b9","text":"\u7279\u6027 \u8bf4\u660e \u7c7b\u578b \u88ab\u52a8\u91c7\u6837\uff08\u57fa\u4e8e\u4e2d\u65ad\uff09 \u7cbe\u786e\u5ea6 \u7edf\u8ba1\u6027\u8d28\uff08\u6982\u7387\uff09 \u5f00\u9500 \u4f4e\uff081-3% CPU\uff09 \u65f6\u5e8f \u65e0\uff08\u53ea\u6709\u91c7\u6837\u70b9\uff09 \u56e0\u679c\u5173\u7cfb \u4e0d\u6e05\u695a \u77ed\u51fd\u6570 \u53ef\u80fd\u4e22\u5931 \u4fb5\u5165\u6027 \u65e0\u9700\u6539\u4ee3\u7801 \u9002\u7528\u573a\u666f \u627e\u70ed\u70b9\u3001CPU \u5206\u6790"},{"location":"arkcompiler/TRACE_COMPLETE_GUIDE/#32-trace","title":"3.2 Trace\uff08\u63d2\u6869\uff09","text":""},{"location":"arkcompiler/TRACE_COMPLETE_GUIDE/#_5","title":"\u539f\u7406","text":"<pre><code>// \u5e94\u7528\u5c42\u5199\u5165\nwrite(fd, \"B|1234|FunctionName\", ...);\n\n// \u5185\u6838\u5c42\u5904\u7406\n1. \u63a5\u6536\u5199\u5165\u8bf7\u6c42\n2. \u4e0d\u843d\u76d8\uff0c\u76f4\u63a5\u5199\u5165 ring buffer\uff08\u5185\u5b58\u4e2d\uff09\n3. Ring buffer \u662f\u65e0\u9501\u7684 per-CPU \u7f13\u51b2\u533a\n4. \u6781\u4f4e\u5f00\u9500\uff08\u7eb3\u79d2\u7ea7\uff09\n</code></pre>"},{"location":"arkcompiler/TRACE_COMPLETE_GUIDE/#ring-buffer","title":"Ring Buffer \u7ed3\u6784","text":"<pre><code>Per-CPU Ring Buffers\uff08\u6bcf\u4e2aCPU\u4e00\u4e2a\uff0c\u907f\u514d\u7ade\u4e89\uff09:\n\nCPU0: [Event1][Event2][Event3]... \u2192 \u5faa\u73af\u8986\u76d6\nCPU1: [Event1][Event2][Event3]... \u2192 \u5faa\u73af\u8986\u76d6\nCPU2: [Event1][Event2][Event3]... \u2192 \u5faa\u73af\u8986\u76d6\n...\n\n\u7279\u70b9\uff1a\n- \u65e0\u9501\uff08lock-free\uff09\n- \u5185\u5b58\u9884\u5206\u914d\n- \u5faa\u73af\u8986\u76d6\uff08\u53ef\u914d\u7f6e\u4e0d\u8986\u76d6\uff09\n- \u6bcf\u4e2a CPU \u72ec\u7acb\uff0c\u65e0\u7ade\u4e89\n</code></pre>"},{"location":"arkcompiler/TRACE_COMPLETE_GUIDE/#_6","title":"\u6027\u80fd\u5bf9\u6bd4","text":"\u64cd\u4f5c \u5ef6\u8fdf \u666e\u901a <code>printf</code> ~1-10 \u00b5s\uff08\u5fae\u79d2\uff09 \u6587\u4ef6 <code>write</code> ~1-5 \u00b5s ftrace marker ~50-200 ns\uff08\u7eb3\u79d2\uff09 \u5dee\u8ddd \u5feb 10-100 \u500d\uff01"},{"location":"arkcompiler/TRACE_COMPLETE_GUIDE/#_7","title":"\u7279\u70b9","text":"\u7279\u6027 \u8bf4\u660e \u7c7b\u578b \u4e3b\u52a8\u8bb0\u5f55\uff08\u51fd\u6570\u8c03\u7528\u65f6\uff09 \u7cbe\u786e\u5ea6 \u7cbe\u786e\uff08\u6bcf\u6b21\u8c03\u7528\uff09 \u5f00\u9500 \u4e2d\uff085-20%\uff0c\u53d6\u51b3\u4e8e\u9891\u7387\uff09 \u65f6\u5e8f \u5b8c\u6574\uff08\u7cbe\u786e\u987a\u5e8f\uff09 \u56e0\u679c\u5173\u7cfb \u6e05\u695a\uff08\u5d4c\u5957\u5173\u7cfb\uff09 \u77ed\u51fd\u6570 \u4e0d\u4f1a\u4e22\u5931 \u4fb5\u5165\u6027 \u9700\u8981\u63d2\u6869 \u9002\u7528\u573a\u666f \u627e\u987a\u5e8f\u3001\u5ef6\u8fdf\u5206\u6790"},{"location":"arkcompiler/TRACE_COMPLETE_GUIDE/#33","title":"3.3 \u5bf9\u6bd4\u603b\u7ed3","text":"\u7ef4\u5ea6 Perf\uff08\u91c7\u6837\uff09 Trace\uff08\u63d2\u6869\uff09 \u539f\u7406 \u88ab\u52a8\u91c7\u6837 \u4e3b\u52a8\u8bb0\u5f55 \u7cbe\u786e\u5ea6 \u7edf\u8ba1\uff08\u6982\u7387\uff09 \u7cbe\u786e\uff08\u6bcf\u6b21\uff09 \u5f00\u9500 \u4f4e\uff081-3%\uff09 \u4e2d\uff085-20%\uff09 \u65f6\u5e8f \u65e0 \u5b8c\u6574 \u56e0\u679c\u5173\u7cfb \u4e0d\u6e05\u695a \u6e05\u695a \u77ed\u51fd\u6570 \u53ef\u80fd\u4e22\u5931 \u4e0d\u4f1a\u4e22\u5931 \u4fb5\u5165\u6027 \u65e0\u9700\u6539\u4ee3\u7801 \u9700\u8981\u63d2\u6869 \u9002\u7528\u573a\u666f \u627e\u70ed\u70b9\u3001CPU\u5206\u6790 \u627e\u987a\u5e8f\u3001\u5ef6\u8fdf\u5206\u6790 \u6570\u636e\u91cf \u5c0f \u5927"},{"location":"arkcompiler/TRACE_COMPLETE_GUIDE/#34","title":"3.4 \u6700\u4f73\u5b9e\u8df5\uff1a\u7ec4\u5408\u4f7f\u7528","text":"<pre><code># \u7b2c\u4e00\u6b65\uff1a\u7528 Perf \u627e\u70ed\u70b9\nperf record -g ./your_program\nperf report --stdio\n# \u53d1\u73b0\uff1aGetClass() \u5360\u7528 40% CPU\n\n# \u7b2c\u4e8c\u6b65\uff1a\u7528 Trace \u770b\u7ec6\u8282\n# \u5728 GetClass() \u4e2d\u52a0 trace \u70b9\nTracer::Start(\"GetClass\");\n  Tracer::Start(\"LoadFromCache\");\n  Tracer::Finish();\n  Tracer::Start(\"LoadFromDisk\");\n  Tracer::Finish();\nTracer::Finish();\n\n# \u53d1\u73b0\uff1aLoadFromDisk \u5f88\u6162\uff0c\u9700\u8981\u4f18\u5316\n</code></pre>"},{"location":"arkcompiler/TRACE_COMPLETE_GUIDE/#4","title":"4. \u81ea\u52a8\u63d2\u6869\u65b9\u6848","text":""},{"location":"arkcompiler/TRACE_COMPLETE_GUIDE/#41","title":"4.1 \u9700\u6c42\u573a\u666f","text":"<ul> <li>\u2705 \u5b66\u4e60\u4ee3\u7801\u65f6\uff0c\u60f3\u5b8c\u6574\u770b\u5230\u6267\u884c\u8fc7\u7a0b</li> <li>\u2705 \u4e0d\u60f3\u624b\u52a8\u5728\u6bcf\u4e2a\u51fd\u6570\u52a0 Trace Start/Finish</li> <li>\u2705 \u5e0c\u671b\u81ea\u52a8\u63d2\u6869\u6240\u6709\u51fd\u6570</li> <li>\u2705 \u51fd\u6570\u540d\u81ea\u52a8\u4f5c\u4e3a trace \u540d\u79f0</li> <li>\u2705 \u53ef\u9009\u5730\u5728\u67d0\u4e9b\u51fd\u6570\u9644\u52a0\u66f4\u591a\u4fe1\u606f\uff08\u53c2\u6570\u3001\u68c0\u67e5\u70b9\uff09</li> </ul>"},{"location":"arkcompiler/TRACE_COMPLETE_GUIDE/#42-gccclang-finstrument-functions","title":"4.2 \u89e3\u51b3\u65b9\u6848\uff1aGCC/Clang <code>-finstrument-functions</code>","text":""},{"location":"arkcompiler/TRACE_COMPLETE_GUIDE/#_8","title":"\u539f\u7406","text":"<p>\u7f16\u8bd1\u5668\u4f1a\u5728\u6bcf\u4e2a\u51fd\u6570\u7684\u5f00\u5934\u548c\u7ed3\u5c3e\u81ea\u52a8\u63d2\u5165\u5bf9\u94a9\u5b50\u51fd\u6570\u7684\u8c03\u7528\uff1a</p> <pre><code>// \u6e90\u4ee3\u7801\nvoid my_function(int x) {\n    printf(\"x = %d\\n\", x);\n}\n\n// \u7f16\u8bd1\u5668\u81ea\u52a8\u8f6c\u6362\u4e3a\uff08\u6982\u5ff5\u4e0a\uff09\nvoid my_function(int x) {\n    __cyg_profile_func_enter(my_function_addr, caller_addr);\n    printf(\"x = %d\\n\", x);\n    __cyg_profile_func_exit(my_function_addr, caller_addr);\n}\n</code></pre>"},{"location":"arkcompiler/TRACE_COMPLETE_GUIDE/#_9","title":"\u5b9e\u73b0\u94a9\u5b50\u51fd\u6570","text":"<pre><code>extern \"C\" {\n    // \u51fd\u6570\u8fdb\u5165\u94a9\u5b50\n    void __cyg_profile_func_enter(void *this_fn, void *call_site) {\n        const char* func_name = GetFunctionName(this_fn);\n        WriteTrace(\"B|%d|%s\", getpid(), func_name);\n    }\n\n    // \u51fd\u6570\u9000\u51fa\u94a9\u5b50\n    void __cyg_profile_func_exit(void *this_fn, void *call_site) {\n        WriteTrace(\"E|\");\n    }\n}\n</code></pre>"},{"location":"arkcompiler/TRACE_COMPLETE_GUIDE/#_10","title":"\u7f16\u8bd1\u9009\u9879","text":"<pre><code># \u57fa\u672c\u7528\u6cd5\ng++ -finstrument-functions your_code.cpp\n\n# \u9700\u8981\u7b26\u53f7\u89e3\u6790\uff08\u83b7\u53d6\u51fd\u6570\u540d\uff09\ng++ -finstrument-functions -rdynamic -ldl your_code.cpp\n\n# \u6392\u9664\u67d0\u4e9b\u51fd\u6570\uff08\u907f\u514d\u9012\u5f52\uff09\ng++ -finstrument-functions \\\n    -finstrument-functions-exclude-file-list=trace.cpp \\\n    -finstrument-functions-exclude-function-list=__cyg_profile_func_enter\n</code></pre>"},{"location":"arkcompiler/TRACE_COMPLETE_GUIDE/#_11","title":"\u63a7\u5236\u7c92\u5ea6","text":"<pre><code>// \u6392\u9664\u7279\u5b9a\u51fd\u6570\nvoid my_hot_function() __attribute__((no_instrument_function));\n\n// \u6392\u9664\u7279\u5b9a\u6587\u4ef6\n#pragma GCC optimize(\"no-instrument-functions\")\n</code></pre>"},{"location":"arkcompiler/TRACE_COMPLETE_GUIDE/#43","title":"4.3 \u589e\u5f3a\u529f\u80fd\uff1a\u8bb0\u5f55\u53c2\u6570\u548c\u68c0\u67e5\u70b9","text":"<pre><code>// \u63d0\u4f9b\u5b8f\u7528\u4e8e\u8bb0\u5f55\u989d\u5916\u4fe1\u606f\n#define TRACE_ARGS(fmt, ...) \\\n    do { \\\n        char buf[512]; \\\n        snprintf(buf, sizeof(buf), fmt, ##__VA_ARGS__); \\\n        TraceHelper::LogArgs(__func__, buf); \\\n    } while(0)\n\n#define TRACE_CHECKPOINT(msg) \\\n    TraceHelper::LogCheckpoint(__func__, msg)\n\n// \u4f7f\u7528\u793a\u4f8b\nvoid ClassLinker::GetClass(const File&amp; pf, EntityId id) {\n    // \u51fd\u6570\u5165\u53e3/\u9000\u51fa\u7531\u7f16\u8bd1\u5668\u81ea\u52a8\u5904\u7406\n\n    // \u8bb0\u5f55\u5173\u952e\u53c2\u6570\uff08\u53ef\u9009\uff09\n    TRACE_ARGS(\"file=%s, id=%x\", pf.GetFilename(), id.GetOffset());\n\n    Class *cls = pf.GetCache()-&gt;GetClass(id);\n    if (cls != nullptr) {\n        TRACE_CHECKPOINT(\"cache hit\");  // \u53ef\u9009\uff1a\u8bb0\u5f55\u68c0\u67e5\u70b9\n        return cls;\n    }\n\n    TRACE_CHECKPOINT(\"cache miss\");\n    cls = LoadClass(...);\n    return cls;\n}\n</code></pre>"},{"location":"arkcompiler/TRACE_COMPLETE_GUIDE/#44-ark","title":"4.4 \u96c6\u6210\u5230 ARK \u9879\u76ee","text":""},{"location":"arkcompiler/TRACE_COMPLETE_GUIDE/#cmakeliststxt","title":"CMakeLists.txt \u914d\u7f6e","text":"<pre><code># \u6dfb\u52a0\u81ea\u52a8\u63d2\u6869\u9009\u9879\noption(ENABLE_AUTO_TRACE \"Enable automatic function tracing\" OFF)\n\nif(ENABLE_AUTO_TRACE)\n    # \u6dfb\u52a0\u7f16\u8bd1\u9009\u9879\n    add_compile_options(-finstrument-functions)\n\n    # \u6392\u9664 trace \u7cfb\u7edf\u672c\u8eab\n    set_source_files_properties(\n        libarkbase/trace/auto_trace.cpp\n        libarkbase/trace/trace.cpp\n        PROPERTIES COMPILE_FLAGS \"-fno-instrument-functions\"\n    )\n\n    # \u6dfb\u52a0\u94fe\u63a5\u9009\u9879\n    add_link_options(-rdynamic -ldl)\n\n    # \u5b9a\u4e49\u5b8f\n    add_definitions(-DENABLE_AUTO_TRACE)\nendif()\n</code></pre>"},{"location":"arkcompiler/TRACE_COMPLETE_GUIDE/#_12","title":"\u7f16\u8bd1\u548c\u8fd0\u884c","text":"<pre><code># \u7f16\u8bd1\uff08\u542f\u7528\u81ea\u52a8\u63d2\u6869\uff09\ncmake -DENABLE_AUTO_TRACE=ON build\ncmake --build build\n\n# \u8fd0\u884c\uff08\u542f\u7528 trace\uff09\nPANDA_TRACE=1 sudo -E ./build/bin/ark your_program.abc\n</code></pre>"},{"location":"arkcompiler/TRACE_COMPLETE_GUIDE/#45","title":"4.5 \u914d\u7f6e\u9009\u9879","text":"\u73af\u5883\u53d8\u91cf \u8bf4\u660e \u9ed8\u8ba4\u503c \u793a\u4f8b <code>PANDA_TRACE</code> \u542f\u7528 trace - <code>PANDA_TRACE=1</code> <code>TRACE_MAX_DEPTH</code> \u6700\u5927\u8ffd\u8e2a\u6df1\u5ea6 20 <code>TRACE_MAX_DEPTH=10</code> <code>TRACE_WHITELIST</code> \u767d\u540d\u5355\uff08\u53ea\u8ffd\u8e2a\u5339\u914d\u7684\uff09 - <code>TRACE_WHITELIST=ClassLinker,LoadClass</code> <code>TRACE_BLACKLIST</code> \u9ed1\u540d\u5355\uff08\u4e0d\u8ffd\u8e2a\u5339\u914d\u7684\uff09 - <code>TRACE_BLACKLIST=mutex,lock</code>"},{"location":"arkcompiler/TRACE_COMPLETE_GUIDE/#46","title":"4.6 \u4f18\u7f3a\u70b9\u5bf9\u6bd4","text":"\u65b9\u9762 \u624b\u52a8\u63d2\u6869 \u81ea\u52a8\u63d2\u6869 \u4ee3\u7801\u6539\u52a8 \u6bcf\u4e2a\u51fd\u6570\u90fd\u8981\u52a0 \u96f6\u6539\u52a8 \u8986\u76d6\u7387 \u5bb9\u6613\u9057\u6f0f 100% \u8986\u76d6 \u7ef4\u62a4\u6210\u672c \u9ad8 \u96f6\u7ef4\u62a4 \u7075\u6d3b\u6027 \u53ef\u4ee5\u7cbe\u786e\u63a7\u5236 \u901a\u8fc7\u767d\u540d\u5355\u63a7\u5236 \u53c2\u6570\u8bb0\u5f55 \u5bb9\u6613 \u9700\u8981\u5b8f\u8f85\u52a9 \u6027\u80fd\u5f00\u9500 \u53ef\u63a7\uff08\u53ea\u63d2\u9700\u8981\u7684\uff09 \u8f83\u5927\uff08\u4f46\u53ef\u8fc7\u6ee4\uff09"},{"location":"arkcompiler/TRACE_COMPLETE_GUIDE/#5-trace","title":"5. Trace \u53ef\u89c6\u5316","text":""},{"location":"arkcompiler/TRACE_COMPLETE_GUIDE/#51-perfetto-ui","title":"5.1 Perfetto UI\uff08\u63a8\u8350\uff09\u2b50\u2b50\u2b50","text":"<p>\u8bbf\u95ee\u5730\u5740\uff1ahttps://ui.perfetto.dev/</p> <p>\u4f18\u52bf\uff1a - \u2705 \u76f4\u63a5\u652f\u6301 ftrace \u683c\u5f0f\uff08\u65e0\u9700\u8f6c\u6362\uff09 - \u2705 \u73b0\u4ee3\u5316 UI \u754c\u9762 - \u2705 \u5f3a\u5927\u7684\u5206\u6790\u529f\u80fd - \u2705 SQL \u67e5\u8be2\u652f\u6301 - \u2705 \u66f4\u597d\u7684\u5927\u6587\u4ef6\u5904\u7406\u80fd\u529b</p> <p>\u4f7f\u7528\u65b9\u6cd5\uff1a 1. \u8bbf\u95ee https://ui.perfetto.dev/ 2. \u70b9\u51fb \"Open trace file\" 3. \u9009\u62e9\u60a8\u7684 trace \u6587\u4ef6 4. \u67e5\u770b\u53ef\u89c6\u5316\u65f6\u95f4\u7ebf</p>"},{"location":"arkcompiler/TRACE_COMPLETE_GUIDE/#52-chrome-tracing","title":"5.2 Chrome Tracing","text":"<p>\u8bbf\u95ee\u5730\u5740\uff1a<code>chrome://tracing</code></p> <p>\u4f7f\u7528\u65b9\u6cd5\uff1a 1. \u8f6c\u6362\u683c\u5f0f\uff08\u5982\u9700\u8981\uff09\uff1a    <pre><code>python3 ftrace_to_json.py output.trace output.json\n</code></pre> 2. \u6253\u5f00 Chrome \u6d4f\u89c8\u5668 3. \u5730\u5740\u680f\u8f93\u5165\uff1a<code>chrome://tracing</code> 4. \u70b9\u51fb \"Load\" \u6309\u94ae 5. \u9009\u62e9 <code>output.json</code></p> <p>\u5feb\u6377\u952e\uff1a - <code>W/A/S/D</code> - \u5e73\u79fb\u548c\u7f29\u653e - <code>1/2/3/4</code> - \u9009\u62e9\u5de5\u5177 - <code>/</code> - \u641c\u7d22\u4e8b\u4ef6 - <code>?</code> - \u663e\u793a\u5e2e\u52a9</p>"},{"location":"arkcompiler/TRACE_COMPLETE_GUIDE/#53","title":"5.3 \u53ef\u89c6\u5316\u6548\u679c\u793a\u4f8b","text":"<pre><code>\u65f6\u95f4\u8f74 \u2192\n\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\n\u7ebf\u7a0b1 \u2503 \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588 fzw::GetClass::panda_file \u2588\u2588\u2588\u2588\n      \u2503    \u2588\u2588\u2588 LoadClass \u2588\u2588\u2588\n      \u2503        \u2588\u2588 LinkMethods \u2588\u2588\n\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\n\u7ebf\u7a0b2 \u2503     \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588 AnotherEvent \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\n\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\uff1a - \u2705 \u6bcf\u4e2a\u4e8b\u4ef6\u7684\u5f00\u59cb\u548c\u7ed3\u675f\u65f6\u95f4 - \u2705 \u4e8b\u4ef6\u4e4b\u95f4\u7684\u8c03\u7528\u5173\u7cfb\uff08\u5d4c\u5957\uff09 - \u2705 \u4e0d\u540c\u7ebf\u7a0b\u7684\u5e76\u884c\u6267\u884c\u60c5\u51b5 - \u2705 \u70ed\u70b9\u5206\u6790\uff08\u54ea\u4e2a\u51fd\u6570\u6700\u8017\u65f6\uff09</p>"},{"location":"arkcompiler/TRACE_COMPLETE_GUIDE/#6","title":"6. \u5e38\u89c1\u95ee\u9898","text":""},{"location":"arkcompiler/TRACE_COMPLETE_GUIDE/#61-trace","title":"6.1 Trace \u6ca1\u6709\u8f93\u51fa","text":"<p>\u68c0\u67e5\u6e05\u5355\uff1a 1. \u2705 \u662f\u5426\u8bbe\u7f6e\u4e86 <code>PANDA_TRACE=1</code> \u73af\u5883\u53d8\u91cf\uff1f 2. \u2705 \u662f\u5426\u6709 root \u6743\u9650\uff1f\uff08\u9700\u8981\u8bbf\u95ee <code>/sys/kernel/debug/tracing/trace_marker</code>\uff09 3. \u2705 \u662f\u5426\u542f\u7528\u4e86 ftrace tracing\uff1f\uff08\u8fd0\u884c trace_enable_wsl2.sh\uff09 4. \u2705 \u7a0b\u5e8f\u662f\u5426\u771f\u7684\u8c03\u7528\u4e86 <code>Tracer::Start/Finish</code>\uff1f 5. \u2705 \u7f16\u8bd1\u65f6\u662f\u5426\u542f\u7528\u4e86 <code>-DENABLE_AUTO_TRACE=ON</code>\uff08\u5982\u679c\u4f7f\u7528\u81ea\u52a8\u63d2\u6869\uff09\uff1f</p> <p>\u9a8c\u8bc1\u65b9\u6cd5\uff1a <pre><code># \u68c0\u67e5 trace \u6587\u4ef6\u4e2d\u662f\u5426\u6709\u60a8\u7684\u6807\u8bb0\ngrep \"fzw::GetClass\" output.trace\n\n# \u68c0\u67e5\u662f\u5426\u6709 trace_marker \u5199\u5165\ngrep \"tracing_mark_write\" output.trace\n</code></pre></p>"},{"location":"arkcompiler/TRACE_COMPLETE_GUIDE/#62-undefined-reference","title":"6.2 \u7f16\u8bd1\u9519\u8bef\uff1aundefined reference","text":"<p>\u9519\u8bef\uff1a <pre><code>undefined reference to `ark::trace::internal::DoInt64TracePoint'\n</code></pre></p> <p>\u89e3\u51b3\uff1a - \u786e\u4fdd <code>DoIntTracePoint</code> \u548c <code>DoInt64TracePoint</code> \u51fd\u6570\u6709 <code>PANDA_PUBLIC_API</code> \u6807\u8bb0 - \u68c0\u67e5\u94fe\u63a5\u4e86 <code>libarkbase.so</code></p>"},{"location":"arkcompiler/TRACE_COMPLETE_GUIDE/#63-wsl2","title":"6.3 WSL2 \u6743\u9650\u95ee\u9898","text":"<p>\u9519\u8bef\uff1a <pre><code>chmod: changing permissions of '/sys/kernel/debug/tracing': Operation not permitted\n</code></pre></p> <p>\u89e3\u51b3\uff1a - \u8fd9\u662f WSL2 \u7684\u6b63\u5e38\u884c\u4e3a\uff0c\u4e0d\u5f71\u54cd\u4f7f\u7528 - \u4f7f\u7528 <code>trace_enable_wsl2.sh</code> \u811a\u672c\uff08\u8df3\u8fc7\u6743\u9650\u8bbe\u7f6e\uff09 - \u4ee5 root \u8eab\u4efd\u8fd0\u884c\u5373\u53ef\u76f4\u63a5\u8bbf\u95ee</p>"},{"location":"arkcompiler/TRACE_COMPLETE_GUIDE/#64","title":"6.4 \u6027\u80fd\u5f71\u54cd\u592a\u5927","text":"<p>\u4f18\u5316\u65b9\u6848\uff1a 1. \u4f7f\u7528\u767d\u540d\u5355\uff1a<code>TRACE_WHITELIST=\"ClassLinker\"</code> 2. \u9650\u5236\u6df1\u5ea6\uff1a<code>TRACE_MAX_DEPTH=5</code> 3. \u6392\u9664\u70ed\u8def\u5f84\uff1a\u5728\u51fd\u6570\u524d\u52a0 <code>__attribute__((no_instrument_function))</code> 4. \u53ea\u5728\u9700\u8981\u65f6\u542f\u7528\uff1a\u5f00\u53d1/\u5b66\u4e60\u65f6\u5f00\u542f\uff0c\u751f\u4ea7\u73af\u5883\u5173\u95ed</p>"},{"location":"arkcompiler/TRACE_COMPLETE_GUIDE/#65-trace","title":"6.5 Trace \u6587\u4ef6\u592a\u5927","text":"<p>\u89e3\u51b3\u65b9\u6848\uff1a 1. \u4f7f\u7528 Perfetto UI\uff08\u5904\u7406\u5927\u6587\u4ef6\u80fd\u529b\u66f4\u5f3a\uff09 2. \u4f7f\u7528\u767d\u540d\u5355/\u9ed1\u540d\u5355\u8fc7\u6ee4 3. \u9650\u5236\u8ffd\u8e2a\u6df1\u5ea6 4. \u7f29\u77ed\u8ffd\u8e2a\u65f6\u95f4</p>"},{"location":"arkcompiler/TRACE_COMPLETE_GUIDE/#66-trace","title":"6.6 \u5d4c\u5957 Trace \u662f\u5426\u652f\u6301\uff1f","text":"<p>\u7b54\u6848\uff1a\u5b8c\u5168\u652f\u6301\uff01</p> <p>ftrace \u4f7f\u7528\u6808\u7ed3\u6784\uff08LIFO\uff09\u5904\u7406\u5d4c\u5957\u7684 Begin/End \u5bf9\uff1a</p> <pre><code>Tracer::Start(\"A\");      // Begin A\nTracer::Start(\"B\");      // Begin B\nTracer::Finish();        // End B\nTracer::Finish();        // End A\n</code></pre> <p>\u8f93\u51fa\uff1a <pre><code>B|pid|A\nB|pid|B\nE|\nE|\n</code></pre></p> <p>\u53ef\u89c6\u5316\uff1a <pre><code>A \u2503 \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\nB \u2503    \u2588\u2588\u2588\u2588\n</code></pre></p>"},{"location":"arkcompiler/TRACE_COMPLETE_GUIDE/#7","title":"7. \u5feb\u901f\u53c2\u8003","text":""},{"location":"arkcompiler/TRACE_COMPLETE_GUIDE/#71","title":"7.1 \u57fa\u672c\u4f7f\u7528","text":"<pre><code>// \u5728\u4ee3\u7801\u4e2d\u6dfb\u52a0 trace\nTracer::Start(\"MyFunction\");\n// ... \u4e1a\u52a1\u903b\u8f91 ...\nTracer::Finish();\n</code></pre> <pre><code># \u6293\u53d6 trace\nsudo ./scripts/trace_enable_wsl2.sh output.trace 60 8192\nPANDA_TRACE=1 sudo -E ./your_program\n\n# \u67e5\u770b\u7ed3\u679c\n# https://ui.perfetto.dev/ -&gt; \u6253\u5f00 output.trace\n</code></pre>"},{"location":"arkcompiler/TRACE_COMPLETE_GUIDE/#72","title":"7.2 \u81ea\u52a8\u63d2\u6869","text":"<pre><code># \u7f16\u8bd1\ncmake -DENABLE_AUTO_TRACE=ON build\ncmake --build build\n\n# \u8fd0\u884c\nPANDA_TRACE=1 TRACE_WHITELIST=\"ClassLinker\" sudo -E ./build/bin/ark app.abc\n</code></pre>"},{"location":"arkcompiler/TRACE_COMPLETE_GUIDE/#73","title":"7.3 \u5173\u952e\u6587\u4ef6\u4f4d\u7f6e","text":"\u6587\u4ef6 \u8def\u5f84 Tracer \u7c7b\u5b9a\u4e49 <code>runtime/trace.h</code> ftrace \u5b9e\u73b0 <code>platforms/unix/libarkbase/trace.cpp</code> trace API <code>libarkbase/trace/trace.h</code> trace \u811a\u672c <code>scripts/trace_enable_wsl2.sh</code>"},{"location":"arkcompiler/TRACE_COMPLETE_GUIDE/#74","title":"7.4 \u73af\u5883\u53d8\u91cf\u901f\u67e5","text":"\u53d8\u91cf \u4f5c\u7528 <code>PANDA_TRACE=1</code> \u542f\u7528 trace\uff08\u5fc5\u9700\uff09 <code>TRACE_MAX_DEPTH=N</code> \u9650\u5236\u8ffd\u8e2a\u6df1\u5ea6 <code>TRACE_WHITELIST=\"...\"</code> \u53ea\u8ffd\u8e2a\u5339\u914d\u7684\u51fd\u6570 <code>TRACE_BLACKLIST=\"...\"</code> \u4e0d\u8ffd\u8e2a\u5339\u914d\u7684\u51fd\u6570"},{"location":"arkcompiler/TRACE_COMPLETE_GUIDE/#8","title":"8. \u603b\u7ed3","text":""},{"location":"arkcompiler/TRACE_COMPLETE_GUIDE/#_13","title":"\u6838\u5fc3\u8981\u70b9","text":"<ol> <li>Trace \u7cfb\u7edf\u67b6\u6784\uff1a\u4e09\u5c42\u67b6\u6784\uff0c\u6761\u4ef6\u7f16\u8bd1\u9009\u62e9\u5b9e\u73b0\uff08HiTrace \u6216 ftrace\uff09</li> <li>\u5d4c\u5957\u652f\u6301\uff1a\u5b8c\u5168\u652f\u6301\uff0cftrace \u4f7f\u7528\u6808\u7ed3\u6784</li> <li>\u6293\u53d6\u65b9\u6cd5\uff1a\u8bbe\u7f6e <code>PANDA_TRACE=1</code> + root \u6743\u9650 + ftrace \u811a\u672c</li> <li>\u53ef\u89c6\u5316\u5de5\u5177\uff1a\u63a8\u8350 Perfetto UI\uff08https://ui.perfetto.dev/\uff09</li> <li>\u81ea\u52a8\u63d2\u6869\uff1a\u4f7f\u7528 <code>-finstrument-functions</code> \u7f16\u8bd1\u9009\u9879</li> <li>\u6027\u80fd\u8003\u8651\uff1a\u53ef\u901a\u8fc7\u767d\u540d\u5355/\u9ed1\u540d\u5355/\u6df1\u5ea6\u9650\u5236\u63a7\u5236\u5f00\u9500</li> </ol>"},{"location":"arkcompiler/TRACE_COMPLETE_GUIDE/#_14","title":"\u9002\u7528\u573a\u666f","text":"<ul> <li>\u5b66\u4e60\u4ee3\u7801\uff1a\u4f7f\u7528\u81ea\u52a8\u63d2\u6869\uff0c\u5b8c\u6574\u8ffd\u8e2a\u6267\u884c\u6d41\u7a0b</li> <li>\u6027\u80fd\u5206\u6790\uff1a\u5148\u7528 Perf \u627e\u70ed\u70b9\uff0c\u518d\u7528 Trace \u770b\u7ec6\u8282</li> <li>\u8c03\u8bd5\u95ee\u9898\uff1a\u4f7f\u7528 Trace \u67e5\u770b\u7cbe\u786e\u7684\u8c03\u7528\u987a\u5e8f\u548c\u65f6\u95f4</li> <li>\u751f\u4ea7\u73af\u5883\uff1a\u5173\u95ed Trace \u6216\u4f7f\u7528\u767d\u540d\u5355\u9650\u5236</li> </ul>"},{"location":"arkcompiler/arena_allocator_testing_guide/","title":"ArenaAllocator \u4f18\u5316\u6d4b\u8bd5\u6307\u5357","text":"<p>\u672c\u6587\u6863\u63cf\u8ff0\u4e86\u5982\u4f55\u7f16\u8bd1\u548c\u8fd0\u884c\u4e0e ArenaAllocator \u4f18\u5316\uff08Reset \u529f\u80fd\u548c\u7ebf\u7a0b\u672c\u5730\u6c60\uff09\u76f8\u5173\u7684\u6d4b\u8bd5\u5957\u4ef6\u3002</p>"},{"location":"arkcompiler/arena_allocator_testing_guide/#1","title":"1. \u6d4b\u8bd5\u4f4d\u7f6e","text":"<ul> <li>\u5355\u5143\u6d4b\u8bd5: <code>libarkbase/tests/arena_allocator_test.cpp</code><ul> <li>\u6d4b\u8bd5\u7528\u4f8b: <code>ArenaAllocatorTest.ResetTest</code>, <code>ArenaAllocatorTest.ResetMultiArenaTest</code></li> </ul> </li> <li>\u96c6\u6210\u6d4b\u8bd5: <code>runtime/tests/class_linker_test.cpp</code><ul> <li>\u6d4b\u8bd5\u7528\u4f8b: <code>ClassLinkerTest.ThreadLocalAllocatorReuse</code></li> </ul> </li> </ul>"},{"location":"arkcompiler/arena_allocator_testing_guide/#2","title":"2. \u7f16\u8bd1","text":"<p>\u6d4b\u8bd5\u5206\u4e3a\u4e24\u4e2a\u7f16\u8bd1\u76ee\u6807\uff1a<code>arkbase_tests</code>\uff08\u7528\u4e8e\u57fa\u7840\u5e93\u6d4b\u8bd5\uff09\u548c <code>arkruntime_interpreter_test</code>\uff08\u7528\u4e8e\u8fd0\u884c\u65f6\u96c6\u6210\u6d4b\u8bd5\uff09\u3002</p>"},{"location":"arkcompiler/arena_allocator_testing_guide/#_1","title":"\u7f16\u8bd1\u5355\u5143\u6d4b\u8bd5","text":"<pre><code>cmake --build build --target arkbase_tests\n</code></pre>"},{"location":"arkcompiler/arena_allocator_testing_guide/#_2","title":"\u7f16\u8bd1\u96c6\u6210\u6d4b\u8bd5","text":"<pre><code>cmake --build build --target arkruntime_interpreter_test\n</code></pre> <p>\u6ce8\u610f: \u8bf7\u786e\u4fdd\u60a8\u7684\u6784\u5efa\u76ee\u5f55\u5df2\u914d\u7f6e\u597d\uff08\u4f8b\u5982 <code>build</code>\uff09\u3002</p>"},{"location":"arkcompiler/arena_allocator_testing_guide/#3","title":"3. \u8fd0\u884c\u6d4b\u8bd5","text":"<p>\u7f16\u8bd1\u540e\u7684\u6d4b\u8bd5\u4e8c\u8fdb\u5236\u6587\u4ef6\u4f4d\u4e8e <code>build/bin-gtests/</code>\u3002\u4f7f\u7528 <code>--gtest_filter</code> \u6765\u8fd0\u884c\u7279\u5b9a\u7684\u6d4b\u8bd5\u7528\u4f8b\u3002</p>"},{"location":"arkcompiler/arena_allocator_testing_guide/#arenaallocator_1","title":"\u8fd0\u884c ArenaAllocator \u5355\u5143\u6d4b\u8bd5","text":"<p>\u9a8c\u8bc1 <code>Reset()</code> \u529f\u80fd\uff1a</p> <pre><code>./build/bin-gtests/arkbase_tests --gtest_filter=\"ArenaAllocatorTest.Reset*\"\n</code></pre> <p>\u9884\u671f\u8f93\u51fa: <pre><code>[ RUN      ] ArenaAllocatorTest.ResetTest\n[       OK ] ArenaAllocatorTest.ResetTest (1 ms)\n[ RUN      ] ArenaAllocatorTest.ResetMultiArenaTest\n[       OK ] ArenaAllocatorTest.ResetMultiArenaTest (1 ms)\n</code></pre></p>"},{"location":"arkcompiler/arena_allocator_testing_guide/#classlinker","title":"\u8fd0\u884c ClassLinker \u96c6\u6210\u6d4b\u8bd5","text":"<p>\u9a8c\u8bc1\u7ebf\u7a0b\u672c\u5730\u5206\u914d\u5668\u6c60\u5316\u548c\u91cd\u7528\uff1a</p> <pre><code>./build/bin-gtests/arkruntime_interpreter_test --gtest_filter=\"ClassLinkerTest.ThreadLocalAllocatorReuse\"\n</code></pre> <p>\u9884\u671f\u8f93\u51fa: <pre><code>[ RUN      ] ClassLinkerTest.ThreadLocalAllocatorReuse\n[       OK ] ClassLinkerTest.ThreadLocalAllocatorReuse (7 ms)\n</code></pre></p>"},{"location":"arkcompiler/arena_allocator_testing_guide/#4","title":"4. \u6545\u969c\u6392\u9664","text":"<ul> <li>\u6784\u5efa\u5931\u8d25: \u5982\u679c\u60a8\u4fee\u6539\u4e86 <code>arena_allocator.h</code> \u6216 <code>.cpp</code>\uff0c\u5fc5\u987b\u91cd\u5efa \u4e24\u4e2a \u76ee\u6807\uff0c\u4ee5\u786e\u4fdd\u66f4\u6539\u4f20\u64ad\u5230\u8fd0\u884c\u65f6\u6d4b\u8bd5\u4e2d\u3002</li> <li>\u672a\u627e\u5230\u76ee\u6807: \u5982\u679c\u672a\u627e\u5230 <code>arkruntime_interpreter_test</code>\uff0c\u8bf7\u9a8c\u8bc1\u60a8\u662f\u5426\u5728 <code>build</code> \u76ee\u5f55\u4e2d\u4e3a\u6b63\u786e\u7684\u67b6\u6784/\u5e73\u53f0\u914d\u7f6e\u8fdb\u884c\u4e86\u7f16\u8bd1\u3002</li> </ul>"},{"location":"arkcompiler/build_guide/","title":"ArkCompiler \u7f16\u8bd1\u6307\u5357","text":"<p>\u672c\u6587\u6863\u6c47\u603b\u4e86 ArkCompiler \u7684 CMake \u7f16\u8bd1\u547d\u4ee4\u4ee5\u53ca Device LLVM \u7684\u6784\u5efa\u6b65\u9aa4\u3002</p>"},{"location":"arkcompiler/build_guide/#1","title":"1. \u7f16\u8bd1\u73af\u5883\u51c6\u5907","text":"<p>\u5728\u5f00\u59cb\u7f16\u8bd1\u4e4b\u524d\uff0c\u8bf7\u786e\u4fdd\u5df2\u5b89\u88c5\u6240\u6709\u5fc5\u8981\u7684\u4f9d\u8d56\u9879\u3002</p> <pre><code>cd static_core/tools\nln -s ../../../arkcompiler_ets_frontend/ets2panda es2panda\n\ncd ..\nsudo ./scripts/install-deps-ubuntu -i=dev -i=test\nsudo apt install gdb\n./scripts/install-third-party --force-clone\n</code></pre>"},{"location":"arkcompiler/build_guide/#2-cmake-host","title":"2. CMake \u7f16\u8bd1 (Host)","text":""},{"location":"arkcompiler/build_guide/#release","title":"Release \u7248\u672c","text":"<pre><code>cmake -B build -DCMAKE_BUILD_TYPE=Release -DCMAKE_TOOLCHAIN_FILE=./cmake/toolchain/host_clang_default.cmake -GNinja .\ncmake --build build\n</code></pre>"},{"location":"arkcompiler/build_guide/#debug","title":"Debug \u7248\u672c","text":"<pre><code>cmake -B build -DCMAKE_BUILD_TYPE=Debug -DCMAKE_TOOLCHAIN_FILE=./cmake/toolchain/host_clang_default.cmake -GNinja .\ncmake --build build\n</code></pre>"},{"location":"arkcompiler/build_guide/#3-llvm-device-ohos-arm64","title":"3. LLVM Device \u7f16\u8bd1 (OHOS ARM64)","text":""},{"location":"arkcompiler/build_guide/#_1","title":"\u5b89\u88c5\u4f9d\u8d56","text":"<pre><code>sudo ./scripts/install-deps-ubuntu -i=llvm-prebuilts\n</code></pre>"},{"location":"arkcompiler/build_guide/#sdk","title":"\u6784\u5efa SDK","text":"<pre><code>cd /home/fanzewei/code/fzw_arkc_0805/arkcompiler_runtime_core/static_core/scripts/sdk\n./build_sdk.sh build-sdk --build_type=Release --ohos_arm64 --ets_std_lib --linux_tools\n</code></pre>"},{"location":"arkcompiler/build_guide/#_2","title":"\u90e8\u7f72\u4ea7\u7269","text":"<p>\u5c06\u7f16\u8bd1\u751f\u6210\u7684\u4e8c\u8fdb\u5236\u6587\u4ef6\u548c\u5e93\u6587\u4ef6\u590d\u5236\u5230\u6307\u5b9a\u76ee\u5f55\uff1a</p> <pre><code># \u590d\u5236\u4e8c\u8fdb\u5236\u6587\u4ef6\ncp ./ohos_arm64/bin/ark /home/fanzewei/code/fzw_arkc_0805/0821_llvm_out/\ncp ./ohos_arm64/bin/ark_aot /home/fanzewei/code/fzw_arkc_0805/0821_llvm_out/\n\n# \u590d\u5236\u5e93\u6587\u4ef6\ncp -r ./ohos_arm64/lib /home/fanzewei/code/fzw_arkc_0805/0821_llvm_out\n\n# \u590d\u5236\u6807\u51c6\u5e93 abc \u6587\u4ef6\ncp ./sdk/ets/etsstdlib.abc /home/fanzewei/code/fzw_arkc_0805/0821_llvm_out\n</code></pre>"},{"location":"arkcompiler/es2panda-developer-guide/","title":"es2panda Developer Guide","text":"<p>\u672c\u6587\u6863\u6c47\u603b\u5e76\u8865\u5145 <code>es2panda</code> \u5728\u7f16\u8bd1 ArkTS (<code>.ets</code>) \u65f6\u5e38\u89c1\u914d\u7f6e\u4e0e\u5b9e\u8df5\uff0c\u91cd\u70b9\u8986\u76d6\uff1a\u58f0\u660e\u4f9d\u8d56\uff08<code>.d.ets</code>\uff09\u3001<code>arktsconfig.json</code>\u3001\u6807\u51c6\u5e93\u4f7f\u7528\u3001\u4ee5\u53ca\u5bfc\u5165\u8def\u5f84\u89e3\u6790\u7684\u5173\u952e\u89c4\u5219\u3002</p>"},{"location":"arkcompiler/es2panda-developer-guide/#1-dets","title":"1. \u7f16\u8bd1\u5305\u542b\u58f0\u660e\u4f9d\u8d56\uff08<code>.d.ets</code>\uff09","text":"<p>\u5f53\u4ee3\u7801\u4f9d\u8d56\u7b2c\u4e09\u65b9\u58f0\u660e\uff08<code>.d.ets</code>\uff09\u6216\u62c6\u5206\u6a21\u5757\u65f6\uff0c\u6709\u4e24\u79cd\u4e3b\u8981\u65b9\u5f0f\u8ba9\u7f16\u8bd1\u5668\u89e3\u6790\u4f9d\u8d56\u3002</p>"},{"location":"arkcompiler/es2panda-developer-guide/#a-arktsconfigjson","title":"\u65b9\u6cd5 A\uff1a\u4f7f\u7528 <code>arktsconfig.json</code>\uff08\u63a8\u8350\uff09","text":"<p>\u5efa\u8bae\u5728\u771f\u5b9e\u5de5\u7a0b\u6216\u590d\u6742\u4f9d\u8d56\u4e2d\u4f7f\u7528 <code>arktsconfig.json</code>\uff0c\u901a\u8fc7 <code>compilerOptions.paths</code> \u663e\u5f0f\u6620\u5c04\u6a21\u5757\u8def\u5f84\u3002</p> <p>\u547d\u4ee4\uff1a <pre><code>./build/bin/es2panda --arktsconfig path/to/arktsconfig.json source_file.ets\n</code></pre></p> <p>\u914d\u7f6e\u7ed3\u6784\uff1a - \u5fc5\u987b\u5305\u542b\u6807\u51c6\u5e93\u8def\u5f84 <code>std</code> \u4e0e <code>escompat</code>\uff0c\u5426\u5219\u57fa\u7840\u7c7b\u578b\uff08\u5982 <code>string</code>\u3001<code>Object</code>\u3001<code>console</code>\uff09\u65e0\u6cd5\u89e3\u6790\u3002 - \u53ef\u9009\u6dfb\u52a0 <code>api</code> \u4e0e <code>arkts</code>\uff0c\u7528\u4e8e\u5f15\u5165 SDK API \u4e0e ArkTS \u6269\u5c55\u63a5\u53e3\uff08\u4e0e\u6784\u5efa\u65f6\u9ed8\u8ba4\u914d\u7f6e\u4fdd\u6301\u4e00\u81f4\uff09\u3002</p> <pre><code>{\n  \"compilerOptions\": {\n    \"baseUrl\": \".\",\n    \"paths\": {\n      \"std\": [\"/path/to/arkcompiler/runtime_core/static_core/plugins/ets/stdlib/std\"],\n      \"escompat\": [\"/path/to/arkcompiler/runtime_core/static_core/plugins/ets/stdlib/escompat\"],\n      \"api\": [\"/path/to/arkcompiler/runtime_core/static_core/plugins/ets/sdk/api\"],\n      \"arkts\": [\"/path/to/arkcompiler/runtime_core/static_core/plugins/ets/sdk/arkts\"],\n      \"dependency\": [\"./path/to/your/lib.d.ets\"]\n    }\n  }\n}\n</code></pre> <p>\u4f9d\u8d56\u5143\u4fe1\u606f\uff08\u53ef\u9009\uff09\uff1a<code>compilerOptions.dependencies</code></p> <p><code>dependencies</code> \u53ef\u4e3a\u67d0\u4e9b\u5bfc\u5165\u8def\u5f84\u6807\u6ce8\u8bed\u8a00\u7c7b\u578b\u4e0e\u58f0\u660e\u6587\u4ef6\u4f4d\u7f6e\u3002\u82e5\u672a\u6307\u5b9a\uff0c\u8bed\u8a00\u7531\u540e\u7f00\u63a8\u65ad\uff0c<code>hasDecl</code> \u9ed8\u8ba4\u4e3a <code>true</code>\u3002</p> <pre><code>{\n  \"compilerOptions\": {\n    \"baseUrl\": \".\",\n    \"paths\": {\n      \"std\": [\".../stdlib/std\"],\n      \"escompat\": [\".../stdlib/escompat\"]\n    },\n    \"dependencies\": {\n      \"dynamic_js_import_tests\": { \"language\": \"js\" },\n      \"path/to/ets/dynamic_import_tests\": {\n        \"language\": \"js\",\n        \"path\": \"path/to/ets/declaration\"\n      }\n    }\n  }\n}\n</code></pre>"},{"location":"arkcompiler/es2panda-developer-guide/#b","title":"\u65b9\u6cd5 B\uff1a\u76f8\u5bf9\u8def\u5f84\u5f15\u7528\uff08\u7b80\u5355\u5feb\u901f\uff09","text":"<p>\u7528\u4e8e\u5c0f\u578b\u9a8c\u8bc1\u6216\u4e34\u65f6\u6d4b\u8bd5\uff0c\u53ef\u76f4\u63a5\u628a <code>.d.ets</code> \u653e\u5728\u540c\u76ee\u5f55\u6216\u76f8\u5bf9\u76ee\u5f55\u4e2d\uff0c\u901a\u8fc7\u76f8\u5bf9\u8def\u5f84\u5bfc\u5165\u3002</p> <p>\u7ed3\u6784\u793a\u4f8b\uff1a <pre><code>project/\n  \u251c\u2500\u2500 Main.ets\n  \u2514\u2500\u2500 Lib.d.ets\n</code></pre></p> <p>\u4f7f\u7528\u65b9\u5f0f\uff1a <pre><code>// Main.ets\nimport { foo } from \"./Lib\";   // \u53ef\u7701\u7565\u6269\u5c55\u540d\n// \u6216\nimport { foo } from \"./Lib.d\"; // \u5e38\u89c1\u4e8e\u6d4b\u8bd5\u7528\u4f8b\n</code></pre></p> <p>\u547d\u4ee4\uff1a <pre><code>./build/bin/es2panda project/Main.ets\n</code></pre></p> <p>\u8bf4\u660e\uff1a\u5bfc\u5165\u8def\u5f84\u53ef\u4ee5\u662f\u76f8\u5bf9\u6216\u7edd\u5bf9\u8def\u5f84\uff1b\u53ef\u5e26\u6216\u4e0d\u5e26\u6269\u5c55\u540d\u3002\u4e5f\u53ef\u6307\u5411\u5305\u76ee\u5f55\uff08\u542b <code>index.ets</code>/<code>index.ts</code>\uff09\u6216\u5305\u6a21\u5757\u8def\u5f84\u3002</p>"},{"location":"arkcompiler/es2panda-developer-guide/#2-dets","title":"2. \u7f16\u5199\u5408\u6cd5\u7684 <code>.d.ets</code> \u58f0\u660e\u6587\u4ef6","text":"<p>\u9876\u5c42\u5bfc\u51fa\u5e94\u4f7f\u7528 <code>declare</code>\uff0c\u4f8b\u5982\uff1a</p> <pre><code>export declare function foo(): void;\nexport declare class Bar {\n    public static id(): string;\n}\n</code></pre> <p>\u5728 <code>export declare namespace</code> \u5185\u90e8\uff0c\u6210\u5458\u53ef\u4ee5\u76f4\u63a5 <code>export function</code> / <code>export class</code>\uff0c\u4e0d\u9700\u8981\u518d\u52a0 <code>declare</code>\uff1a</p> <pre><code>export declare namespace MixedNamespace {\n    export const constantValue: number;\n    export function someFunction(): void;\n    export interface SomeInterface {\n        id: number;\n    }\n    export class SomeClass {\n        prop: string;\n    }\n}\n</code></pre> <p>\u5efa\u8bae\uff1a\u82e5\u672a\u4f7f\u7528 <code>declare</code>\uff0c\u53ef\u80fd\u89e6\u53d1\u8bed\u4e49\u9519\u8bef\u6216\u7c7b\u578b\u68c0\u67e5\u5931\u8d25\u3002\u4e3a\u51cf\u5c11\u6b67\u4e49\uff0c\u5c3d\u91cf\u5728\u9876\u5c42\u4f7f\u7528 <code>export declare</code>\u3002</p>"},{"location":"arkcompiler/es2panda-developer-guide/#3","title":"3. \u6807\u51c6\u5e93\u4e0e\u9690\u5f0f\u5bfc\u5165","text":""},{"location":"arkcompiler/es2panda-developer-guide/#chrononanonow","title":"\u9ad8\u7cbe\u5ea6\u8ba1\u65f6\uff08<code>Chrono.nanoNow()</code>\uff09","text":"<p>\u63a8\u8350\u4ece\u5305\u8def\u5f84\u5bfc\u5165\uff1a</p> <pre><code>import { Chrono } from \"std/time\";\n\nfunction main() {\n    let t: long = Chrono.nanoNow();\n    console.log(t);\n}\n</code></pre> <p>API \u7ec6\u8282\uff1a - Package: <code>std.time</code> - Class: <code>Chrono</code>\uff08<code>final</code>\uff09 - Method: <code>public static native nanoNow(): long;</code></p>"},{"location":"arkcompiler/es2panda-developer-guide/#_1","title":"\u9690\u5f0f\u6807\u51c6\u5e93\u5bfc\u5165","text":"<p>\u7f16\u8bd1\u5668\u4f1a\u4e3a\u6bcf\u4e2a\u6a21\u5757\u9690\u5f0f\u5bfc\u5165\u4e00\u90e8\u5206\u6838\u5fc3\u6807\u51c6\u5e93\u5305\uff08\u4f8b\u5982 <code>std/core</code>\u3001<code>std/math</code>\uff09\uff0c\u56e0\u6b64 <code>console</code> \u7b49\u7b26\u53f7\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528\u3002\u8be5\u884c\u4e3a\u7531\u5185\u90e8\u9ed8\u8ba4\u5bfc\u5165\u6587\u4ef6\u5b9e\u73b0\uff0c\u5e38\u89c4\u9879\u76ee\u65e0\u9700\u663e\u5f0f\u914d\u7f6e\u3002</p>"},{"location":"arkcompiler/es2panda-developer-guide/#4-vs","title":"4. \u5bfc\u5165\u98ce\u683c\uff1a\u5305\u5bfc\u5165 vs \u6587\u4ef6\u5bfc\u5165","text":"\u5bfc\u5165\u65b9\u5f0f \u793a\u4f8b \u884c\u4e3a \u5efa\u8bae \u5305\u5bfc\u5165 <code>import { Chrono } from \"std/time\";</code> \u6309\u5305\u8def\u5f84\u805a\u5408\u5bfc\u51fa\uff0c\u7a33\u5b9a\u53ef\u9760 \u63a8\u8350 \u6587\u4ef6\u5bfc\u5165 <code>import { Chrono } from \"std/time/Chrono\";</code> \u76f4\u63a5\u6307\u5411\u7269\u7406\u6587\u4ef6\uff0c\u5bb9\u6613\u56e0\u6587\u4ef6\u79fb\u52a8\u800c\u5931\u6548 \u4e0d\u63a8\u8350 <p>\u7ed3\u8bba\uff1a\u4f18\u5148\u4f7f\u7528\u5305\u8def\u5f84\uff08\u5982 <code>std/time</code>\uff09\uff0c\u9664\u975e\u6709\u660e\u786e\u7406\u7531\u5fc5\u987b\u7ed1\u5b9a\u5177\u4f53\u6587\u4ef6\u3002</p>"},{"location":"arkcompiler/es2panda-developer-guide/#5-arktsconfigjson","title":"5. <code>arktsconfig.json</code> \u901f\u67e5\u4e0e\u5e38\u7528\u6a21\u677f","text":""},{"location":"arkcompiler/es2panda-developer-guide/#_2","title":"\u6700\u5c0f\u53ef\u7528\u6a21\u677f","text":"<pre><code>{\n  \"compilerOptions\": {\n    \"baseUrl\": \".\",\n    \"paths\": {\n      \"std\": [\"../lib/stdlib/std\"],\n      \"escompat\": [\"../lib/stdlib/escompat\"]\n    }\n  }\n}\n</code></pre>"},{"location":"arkcompiler/es2panda-developer-guide/#sdk-files","title":"SDK \u793a\u4f8b\uff08\u542b <code>files</code>\uff09","text":"<pre><code>{\n  \"compilerOptions\": {\n    \"baseUrl\": \"../../\",\n    \"paths\": {\n      \"std\": [\"ets/stdlib/std\"],\n      \"escompat\": [\"ets/stdlib/escompat\"]\n    },\n    \"outDir\": \"../cache\"\n  },\n  \"files\": [\n    \"./api/@ohos.buffer.ets\",\n    \"./arkts/@arkts.math.Decimal.ets\"\n  ]\n}\n</code></pre> <p>\u53c2\u8003\u4f4d\u7f6e\uff1a<code>plugins/ets/stdlib/stdconfig.json</code> \u4e0e <code>plugins/ets/sdk/arktsconfig.json</code>\u3002</p>"},{"location":"arkcompiler/es2panda-developer-guide/#_3","title":"\u6784\u5efa\u65f6\u751f\u6210\u7684\u9ed8\u8ba4\u914d\u7f6e","text":"<p>\u6784\u5efa\u7cfb\u7edf\u4f1a\u751f\u6210 <code>arktsconfig.json</code>\uff0c\u5176\u5185\u5bb9\u901a\u5e38\u5305\u542b <code>std</code>\u3001<code>escompat</code>\u3001<code>api</code>\u3001<code>arkts</code> \u7b49\u8def\u5f84\u3002\u53ef\u7528\u4e8e\u6838\u5bf9\u8def\u5f84\u8bbe\u7f6e\u662f\u5426\u4e00\u81f4\u3002</p>"},{"location":"arkcompiler/es2panda-developer-guide/#6-import-type","title":"6. \u8865\u5145\uff1a<code>import type</code> \u4e0e\u503c\u5bfc\u5165","text":"<p>ArkTS \u652f\u6301 <code>import type</code> \u53ea\u5bfc\u5165\u7c7b\u578b\uff1a</p> <pre><code>import type { A } from \"./types\";\nimport { AImpl } from \"./impl\";\n</code></pre> <ul> <li><code>import type</code> \u4ec5\u5f15\u5165\u7c7b\u578b\uff0c\u4e0d\u5f15\u5165\u503c\uff1b</li> <li>\u666e\u901a <code>import</code> \u540c\u65f6\u5f15\u5165\u7c7b\u578b\u4e0e\u8fd0\u884c\u65f6\u503c\u3002</li> </ul>"},{"location":"arkcompiler/es2panda-developer-guide/#7","title":"7. \u5e38\u89c1\u6392\u9519\u63d0\u793a","text":"<ul> <li>\u57fa\u7840\u7c7b\u578b/console \u672a\u89e3\u6790\uff1a\u591a\u534a\u662f <code>std</code> / <code>escompat</code> \u6620\u5c04\u7f3a\u5931\u3002</li> <li>\u4f9d\u8d56 JS \u6a21\u5757\u89e3\u6790\u5931\u8d25\uff1a\u8003\u8651\u5728 <code>dependencies</code> \u4e2d\u58f0\u660e <code>language</code> \u6216 <code>path</code>\u3002</li> <li>\u58f0\u660e\u6587\u4ef6\u7f16\u8bd1\u5931\u8d25\uff1a\u68c0\u67e5\u9876\u5c42\u662f\u5426\u6b63\u786e\u4f7f\u7528 <code>export declare</code>\u3002</li> </ul>"},{"location":"leetcode/cpp_binary_search_guide/","title":"C++ STL \u4e8c\u5206\u67e5\u627e\u7b97\u6cd5\u5168\u666f\u6307\u5357","text":"<p>\u672c\u6587\u6863\u6574\u7406\u4e86 C++ \u6807\u51c6\u5e93 (<code>&lt;algorithm&gt;</code>) \u4e2d\u6240\u6709\u57fa\u4e8e\u4e8c\u5206\u67e5\u627e\u539f\u7406\u7684\u7b97\u6cd5\uff0c\u4ee5\u53ca\u73b0\u4ee3 C++ (C++11/20) \u4e2d\u7684\u8fdb\u9636\u7528\u6cd5\u548c\u6027\u80fd\u9677\u9631\u3002</p>"},{"location":"leetcode/cpp_binary_search_guide/#1","title":"1. \u6838\u5fc3\u7b97\u6cd5\u6982\u89c8","text":"<p>\u6240\u6709\u8fd9\u4e9b\u7b97\u6cd5\u7684\u524d\u63d0\u6761\u4ef6\uff1a\u5e8f\u5217\u5fc5\u987b\u5bf9\u4e8e\u6bd4\u8f83\u64cd\u4f5c\u662f\u5df2\u6392\u5e8f\uff08\u6216\u5df2\u5206\u533a\uff09\u7684\u3002</p> \u51fd\u6570\u540d \u8fd4\u56de\u503c \u8bed\u4e49/\u4f5c\u7528 \u590d\u6742\u5ea6 <code>std::binary_search</code> <code>bool</code> \u53ea\u56de\u7b54\u201c\u5728\u4e0d\u5728\u201d\u3002\u4e0d\u8fd4\u56de\u4f4d\u7f6e\u3002 $O(\\log n)$ <code>std::lower_bound</code> <code>iterator</code> \u627e\u7b2c\u4e00\u4e2a $\\ge$ val \u7684\u4f4d\u7f6e\u3002\u5e38\u7528\u4e8e\u67e5\u627e\u63d2\u5165\u4f4d\u7f6e\u3002 $O(\\log n)$ <code>std::upper_bound</code> <code>iterator</code> \u627e\u7b2c\u4e00\u4e2a $&gt;$ val \u7684\u4f4d\u7f6e\u3002\u5e38\u7528\u4e8e\u786e\u5b9a\u8303\u56f4\u7ec8\u70b9\u3002 $O(\\log n)$ <code>std::equal_range</code> <code>pair&lt;iter, iter&gt;</code> \u540c\u65f6\u8fd4\u56de <code>lower_bound</code> \u548c <code>upper_bound</code>\u3002 $O(\\log n)$ <code>std::partition_point</code> <code>iterator</code> (C++11) \u627e\u7b2c\u4e00\u4e2a\u4e0d\u6ee1\u8db3\u8c13\u8bcd\u7684\u5143\u7d20\u4f4d\u7f6e\u3002 $O(\\log n)$"},{"location":"leetcode/cpp_binary_search_guide/#2","title":"2. \u8be6\u7ec6\u89e3\u6790","text":""},{"location":"leetcode/cpp_binary_search_guide/#21","title":"2.1 \u57fa\u7840\u68c0\u67e5","text":""},{"location":"leetcode/cpp_binary_search_guide/#stdbinary_search","title":"<code>std::binary_search</code>","text":"<ul> <li>\u7528\u9014\uff1a\u4ec5\u68c0\u67e5\u5143\u7d20\u662f\u5426\u5b58\u5728\u3002</li> <li>\u6ce8\u610f\uff1a\u5982\u679c\u4f60\u4e4b\u540e\u9700\u8981\u8bbf\u95ee\u8be5\u5143\u7d20\uff0c\u4e0d\u8981\u7528\u8fd9\u4e2a\u3002\u7528 <code>lower_bound</code> \u4ee3\u66ff\uff0c\u5426\u5219\u4f1a\u8fdb\u884c\u4e24\u6b21 $O(\\log n)$ \u67e5\u627e\u3002</li> </ul>"},{"location":"leetcode/cpp_binary_search_guide/#22-the-big-three","title":"2.2 \u5b9a\u4f4d\u4f4d\u7f6e (The \"Big Three\")","text":"<ul> <li><code>lower_bound(begin, end, val)</code>: \u95ed\u533a\u95f4\u8d77\u70b9 <code>[</code>\u3002</li> <li><code>upper_bound(begin, end, val)</code>: \u5f00\u533a\u95f4\u7ec8\u70b9 <code>)</code>\u3002</li> <li><code>equal_range(begin, end, val)</code>: \u8fd4\u56de <code>{first, second}</code>\uff0c\u5373 <code>[lower_bound, upper_bound)</code>\u3002\u533a\u95f4\u957f\u5ea6\u5373\u4e3a\u7b49\u4e8e <code>val</code> \u7684\u5143\u7d20\u4e2a\u6570\u3002</li> </ul>"},{"location":"leetcode/cpp_binary_search_guide/#23","title":"2.3 \u5e7f\u4e49\u4e8c\u5206\u67e5\u627e (\u9690\u85cf\u7684\u795e\u5668)","text":""},{"location":"leetcode/cpp_binary_search_guide/#stdpartition_point-c11","title":"<code>std::partition_point</code> (C++11)","text":"<p>\u8fd9\u662f\u4e8c\u5206\u67e5\u627e\u7684\u901a\u7528\u5f62\u5f0f\u3002\u5b83\u4e0d\u6bd4\u8f83\u5177\u4f53\u7684\u503c\uff0c\u800c\u662f\u6839\u636e\u4e00\u4e2a\u5e03\u5c14\u8c13\u8bcd (Predicate) \u8fdb\u884c\u4e8c\u5206\u3002 * \u524d\u63d0\uff1a\u6570\u7ec4\u5fc5\u987b\u662f\u6839\u636e\u8be5\u8c13\u8bcd\u201c\u5df2\u5206\u533a\u201d\u7684\uff08\u6240\u6709 <code>true</code> \u5728\u524d\uff0c\u6240\u6709 <code>false</code> \u5728\u540e\uff09\u3002 * \u8fd4\u56de\u503c\uff1a\u8fd4\u56de\u7b2c\u4e00\u4e2a\u8ba9\u8c13\u8bcd\u4e3a <code>false</code> \u7684\u5143\u7d20\u3002 * \u573a\u666f\uff1a\u4e8c\u5206\u7b54\u6848 (Binary Search on Answer)\u3002\u4f8b\u5982\uff0c\u201c\u627e\u5230\u7b2c\u4e00\u4e2a\u5927\u4e8e X \u7684\u6570\u201d\u672c\u8d28\u4e0a\u5c31\u662f <code>partition_point</code>\u3002</p> <pre><code>std::vector&lt;int&gt; v = {1, 2, 3, 4, 5, 6, 7};\n// \u67e5\u627e\u7b2c\u4e00\u4e2a\u5927\u4e8e 4 \u7684\u6570 (\u5373\u4f7f\u6570\u7ec4\u6ca1\u6392\u5e8f\uff0c\u53ea\u8981\u6ee1\u8db3\u5206\u533a\u6027\u8d28\u5373\u53ef)\nauto it = std::partition_point(v.begin(), v.end(), [](int i) {\n    return i &lt;= 4; // \u524d\u534a\u90e8\u5206\u6ee1\u8db3 &lt;= 4 (True)\uff0c\u540e\u534a\u90e8\u5206\u4e0d\u6ee1\u8db3 (False)\n});\n// it \u6307\u5411 5\n</code></pre>"},{"location":"leetcode/cpp_binary_search_guide/#3","title":"3. \u9644\u5f55","text":"<pre><code>graph TD\n    %% \u5b9a\u4e49\u6837\u5f0f\n    classDef target fill:#d4edda,stroke:#28a745,stroke-width:2px;\n    classDef other fill:#f8f9fa,stroke:#6c757d,stroke-width:1px;\n    classDef ptr fill:#fff3cd,stroke:#ffc107,stroke-width:2px,stroke-dasharray: 5 5;\n\n    %% \u6570\u7ec4\u8282\u70b9\n    subgraph Array [std::vector v]\n        direction LR\n        N0[10&lt;br/&gt;idx:0]:::other\n        N1[20&lt;br/&gt;idx:1]:::other\n        N2[30&lt;br/&gt;idx:2]:::target\n        N3[30&lt;br/&gt;idx:3]:::target\n        N4[30&lt;br/&gt;idx:4]:::target\n        N5[40&lt;br/&gt;idx:5]:::other\n        N6[50&lt;br/&gt;idx:6]:::other\n\n        N0 --- N1 --- N2 --- N3 --- N4 --- N5 --- N6\n    end\n\n    %% \u6307\u9488\u8282\u70b9\n    LB(lower_bound&lt;br/&gt;\u6307\u5411\u7b2c\u4e00\u4e2a &gt;= 30):::ptr\n    UB(upper_bound&lt;br/&gt;\u6307\u5411\u7b2c\u4e00\u4e2a &gt; 30):::ptr\n\n    %% \u8fde\u63a5\u5173\u7cfb\n    LB --&gt; N2\n    UB --&gt; N5\n\n    %% \u8303\u56f4\u6807\u6ce8\n    subgraph Range [std::equal_range \u8fd4\u56de\u7684\u533a\u95f4 Pair]\n        direction TB\n        %% \u4fee\u6b63\u70b9\uff1a\u4f7f\u7528\u5f15\u53f7\u5305\u88f9\u542b\u6709\u7279\u6b8a\u7b26\u53f7\u7684\u6587\u672c\n        Note1[\"\u533a\u95f4\u8303\u56f4: [first, last)\"]\n        Note2[\"\u5305\u542b idx 2, 3, 4\"]\n    end</code></pre>"},{"location":"en/","title":"Welcome to Fanzewei's Wiki","text":"<p>Welcome! This is my personal knowledge base where I document my learning journey and technical notes.</p> <p>The content is primarily focused on system software and algorithms.</p>"},{"location":"en/#key-topics","title":"\ud83d\udcda Key Topics","text":""},{"location":"en/#arkcompiler","title":"ArkCompiler","text":"<p>Deep dives into the ArkCompiler usage, source code analysis, and build systems. - Build Guide: How to compile ArkCompiler and Device LLVM. - Arena Allocator: Testing guide for memory management optimization. - Trace Complete Guide: (Chinese) Comprehensive guide on Trace system, visualization, and auto-instrumentation. - es2panda Developer Guide: (Chinese) Common configurations, dependency management, and standard library usage. - Lock Implementation Analysis: (Chinese) Deep dive into Ark Runtime lock mechanisms, including Futex, deadlock avoidance, and performance optimizations.</p>"},{"location":"en/#leetcode","title":"LeetCode","text":"<p>Algorithm study notes and problem-solving patterns. - Binary Search: C++ templates and edge case analysis.</p>"},{"location":"en/#about-this-site","title":"\ud83d\udee0\ufe0f About This Site","text":"<p>This site is built with MkDocs and hosted on GitHub Pages. It supports: - \ud83d\udcdd Markdown-based content - \ud83c\udf13 Dark/Light mode automatic switching - \u270f\ufe0f Direct GitHub edition - \ud83d\udd0d Full-text search</p> <p>[!TIP] Use the search bar at the top (or press <code>s</code>) to quickly find any topic.</p>"},{"location":"en/arkcompiler/arena_allocator_testing_guide/","title":"ArenaAllocator Optimization Testing Guide","text":"<p>This document describes how to compile and run the test suites associated with the ArenaAllocator optimization (Reset functionality and Thread-local pooling).</p>"},{"location":"en/arkcompiler/arena_allocator_testing_guide/#1-test-locations","title":"1. Test Locations","text":"<ul> <li>Unit Tests: <code>libarkbase/tests/arena_allocator_test.cpp</code><ul> <li>Tests: <code>ArenaAllocatorTest.ResetTest</code>, <code>ArenaAllocatorTest.ResetMultiArenaTest</code></li> </ul> </li> <li>Integration Tests: <code>runtime/tests/class_linker_test.cpp</code><ul> <li>Tests: <code>ClassLinkerTest.ThreadLocalAllocatorReuse</code></li> </ul> </li> </ul>"},{"location":"en/arkcompiler/arena_allocator_testing_guide/#2-compilation","title":"2. Compilation","text":"<p>The tests are split into two compilation targets: <code>arkbase_tests</code> (for base library tests) and <code>arkruntime_interpreter_test</code> (for runtime integration tests).</p>"},{"location":"en/arkcompiler/arena_allocator_testing_guide/#compile-unit-tests","title":"Compile Unit Tests","text":"<pre><code>cmake --build build --target arkbase_tests\n</code></pre>"},{"location":"en/arkcompiler/arena_allocator_testing_guide/#compile-integration-tests","title":"Compile Integration Tests","text":"<pre><code>cmake --build build --target arkruntime_interpreter_test\n</code></pre> <p>Note: Ensure your build directory is configured (e.g., <code>build</code>).</p>"},{"location":"en/arkcompiler/arena_allocator_testing_guide/#3-running-tests","title":"3. Running Tests","text":"<p>The compiled test binaries are located in <code>build/bin-gtests/</code>. Use <code>--gtest_filter</code> to run specific test cases.</p>"},{"location":"en/arkcompiler/arena_allocator_testing_guide/#run-arenaallocator-unit-tests","title":"Run ArenaAllocator Unit Tests","text":"<p>To verify the <code>Reset()</code> functionality:</p> <pre><code>./build/bin-gtests/arkbase_tests --gtest_filter=\"ArenaAllocatorTest.Reset*\"\n</code></pre> <p>Expected Output: <pre><code>[ RUN      ] ArenaAllocatorTest.ResetTest\n[       OK ] ArenaAllocatorTest.ResetTest (1 ms)\n[ RUN      ] ArenaAllocatorTest.ResetMultiArenaTest\n[       OK ] ArenaAllocatorTest.ResetMultiArenaTest (1 ms)\n</code></pre></p>"},{"location":"en/arkcompiler/arena_allocator_testing_guide/#run-classlinker-integration-tests","title":"Run ClassLinker Integration Tests","text":"<p>To verify the thread-local allocator pooling and reuse:</p> <pre><code>./build/bin-gtests/arkruntime_interpreter_test --gtest_filter=\"ClassLinkerTest.ThreadLocalAllocatorReuse\"\n</code></pre> <p>Expected Output: <pre><code>[ RUN      ] ClassLinkerTest.ThreadLocalAllocatorReuse\n[       OK ] ClassLinkerTest.ThreadLocalAllocatorReuse (7 ms)\n</code></pre></p>"},{"location":"en/arkcompiler/arena_allocator_testing_guide/#4-troubleshooting","title":"4. Troubleshooting","text":"<ul> <li>Build Failures: If you modify <code>arena_allocator.h</code> or <code>.cpp</code>, you must rebuild both targets to ensure changes propagate to the runtime tests.</li> <li>Target Not Found: If <code>arkruntime_interpreter_test</code> is not found, verify that you are compiling for the correct architecture/platform configuration in your <code>build</code> directory.</li> </ul>"},{"location":"en/arkcompiler/build_guide/","title":"ArkCompiler Build Guide","text":"<p>This document consolidates the CMake build commands and Device LLVM build steps for ArkCompiler.</p>"},{"location":"en/arkcompiler/build_guide/#1-environment-preparation","title":"1. Environment Preparation","text":"<p>Ensure all necessary dependencies are installed before building.</p> <pre><code>cd static_core/tools\nln -s ../../../arkcompiler_ets_frontend/ets2panda es2panda\n\ncd ..\nsudo ./scripts/install-deps-ubuntu -i=dev -i=test\nsudo apt install gdb\n./scripts/install-third-party --force-clone\n</code></pre>"},{"location":"en/arkcompiler/build_guide/#2-cmake-build-host","title":"2. CMake Build (Host)","text":""},{"location":"en/arkcompiler/build_guide/#release-build","title":"Release Build","text":"<pre><code>cmake -B build -DCMAKE_BUILD_TYPE=Release -DCMAKE_TOOLCHAIN_FILE=./cmake/toolchain/host_clang_default.cmake -GNinja .\ncmake --build build\n</code></pre>"},{"location":"en/arkcompiler/build_guide/#debug-build","title":"Debug Build","text":"<pre><code>cmake -B build -DCMAKE_BUILD_TYPE=Debug -DCMAKE_TOOLCHAIN_FILE=./cmake/toolchain/host_clang_default.cmake -GNinja .\ncmake --build build\n</code></pre>"},{"location":"en/arkcompiler/build_guide/#3-llvm-device-build-ohos-arm64","title":"3. LLVM Device Build (OHOS ARM64)","text":""},{"location":"en/arkcompiler/build_guide/#install-dependencies","title":"Install Dependencies","text":"<pre><code>sudo ./scripts/install-deps-ubuntu -i=llvm-prebuilts\n</code></pre>"},{"location":"en/arkcompiler/build_guide/#build-sdk","title":"Build SDK","text":"<pre><code>cd /home/fanzewei/code/fzw_arkc_0805/arkcompiler_runtime_core/static_core/scripts/sdk\n./build_sdk.sh build-sdk --build_type=Release --ohos_arm64 --ets_std_lib --linux_tools\n</code></pre>"},{"location":"en/arkcompiler/build_guide/#deploy-artifacts","title":"Deploy Artifacts","text":"<p>Copy the compiled binaries and libraries to the target directory:</p> <pre><code># Copy binaries\ncp ./ohos_arm64/bin/ark /home/fanzewei/code/fzw_arkc_0805/0821_llvm_out/\ncp ./ohos_arm64/bin/ark_aot /home/fanzewei/code/fzw_arkc_0805/0821_llvm_out/\n\n# Copy libraries\ncp -r ./ohos_arm64/lib /home/fanzewei/code/fzw_arkc_0805/0821_llvm_out\n\n# Copy stdlib abc file\ncp ./sdk/ets/etsstdlib.abc /home/fanzewei/code/fzw_arkc_0805/0821_llvm_out\n</code></pre>"},{"location":"","title":"\u6b22\u8fce\u6765\u5230 Fanzewei \u7684 Wiki","text":"<p>\u6b22\u8fce\uff01\u8fd9\u662f\u6211\u7684\u4e2a\u4eba\u77e5\u8bc6\u5e93\uff0c\u7528\u4e8e\u8bb0\u5f55\u6211\u7684\u5b66\u4e60\u65c5\u7a0b\u548c\u6280\u672f\u7b14\u8bb0\u3002</p> <p>\u5185\u5bb9\u4e3b\u8981\u96c6\u4e2d\u5728 \u7cfb\u7edf\u8f6f\u4ef6 \u548c \u7b97\u6cd5 \u65b9\u9762\u3002</p>"},{"location":"#_1","title":"\ud83d\udcda \u4e3b\u8981\u5185\u5bb9","text":""},{"location":"#arkcompiler","title":"ArkCompiler","text":"<p>\u6df1\u5165\u63a2\u8ba8 ArkCompiler \u7684\u4f7f\u7528\u3001\u6e90\u7801\u5206\u6790\u548c\u6784\u5efa\u7cfb\u7edf\u3002 - \u7f16\u8bd1\u6307\u5357: \u5982\u4f55\u7f16\u8bd1 ArkCompiler \u548c Device LLVM\u3002 - Arena \u5206\u914d\u5668: \u5185\u5b58\u7ba1\u7406\u4f18\u5316\u7684\u6d4b\u8bd5\u6307\u5357\u3002 - Trace \u5b8c\u6574\u6307\u5357: \u8986\u76d6 Trace \u539f\u7406\u3001\u4f7f\u7528\u65b9\u6cd5\u3001\u53ef\u89c6\u5316\u548c\u81ea\u52a8\u63d2\u6869\u3002 - es2panda \u5f00\u53d1\u6307\u5357: \u5e38\u89c1\u914d\u7f6e\u3001\u4f9d\u8d56\u7ba1\u7406\u4e0e\u6807\u51c6\u5e93\u4f7f\u7528\u5b9e\u8df5\u3002 - \u9501\u5b9e\u73b0\u5b8c\u6574\u5206\u6790: Ark Runtime \u9501\u673a\u5236 Deep Dive\uff0c\u5305\u542b Futex\u3001\u6b7b\u9501\u907f\u514d\u548c\u6027\u80fd\u4f18\u5316\u3002</p>"},{"location":"#leetcode","title":"LeetCode","text":"<p>\u7b97\u6cd5\u5b66\u4e60\u7b14\u8bb0\u548c\u89e3\u9898\u6a21\u5f0f\u3002 - \u4e8c\u5206\u67e5\u627e: C++ \u6a21\u677f\u548c\u8fb9\u754c\u60c5\u51b5\u5206\u6790\u3002</p>"},{"location":"#_2","title":"\ud83d\udee0\ufe0f \u5173\u4e8e\u672c\u7ad9","text":"<p>\u672c\u7ad9\u57fa\u4e8e MkDocs \u6784\u5efa\u5e76\u6258\u7ba1\u4e8e GitHub Pages\u3002\u652f\u6301\uff1a - \ud83d\udcdd \u57fa\u4e8e Markdown \u7684\u5185\u5bb9 - \ud83c\udf13 \u6df1\u8272/\u6d45\u8272\u6a21\u5f0f\u81ea\u52a8\u5207\u6362 - \u270f\ufe0f \u76f4\u63a5\u5728 GitHub \u4e0a\u7f16\u8f91 - \ud83d\udd0d \u5168\u6587\u641c\u7d22</p> <p>[!TIP] \u4f7f\u7528\u9876\u90e8\u7684 \u641c\u7d22\u680f\uff08\u6216\u6309 <code>s</code>\uff09\u5feb\u901f\u67e5\u627e\u4efb\u4f55\u4e3b\u9898\u3002</p>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/","title":"Ark Runtime \u9501\u5b9e\u73b0\u5b8c\u6574\u5206\u6790","text":""},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#_1","title":"\u6982\u8ff0","text":"<p>Ark Runtime \u5b9e\u73b0\u4e86\u4e00\u5957\u57fa\u4e8e Linux futex \u7684\u9ad8\u6027\u80fd\u540c\u6b65\u539f\u8bed\u7cfb\u7edf\uff0c\u63d0\u4f9b\u4e86\u591a\u79cd\u9501\u7c7b\u578b\u548c RAII \u5305\u88c5\u5668\uff0c\u7528\u4e8e\u4fdd\u8bc1\u591a\u7ebf\u7a0b\u73af\u5883\u4e0b\u7684\u6570\u636e\u5b89\u5168\u3002</p>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#_2","title":"\u6838\u5fc3\u7279\u6027","text":"<ul> <li>\u57fa\u4e8e Futex \u7684\u9ad8\u6027\u80fd\u5b9e\u73b0\uff1a\u5728 Linux \u5e73\u53f0\u4e0a\u4f7f\u7528 futex \u7cfb\u7edf\u8c03\u7528\uff0c\u51cf\u5c11\u5185\u6838\u6001\u5207\u6362</li> <li>\u6df7\u5408\u7b49\u5f85\u7b56\u7565\uff1a\u5feb\u901f\u8def\u5f84 + \u81ea\u65cb\u7b49\u5f85 + futex \u7b49\u5f85</li> <li>\u5185\u5b58\u9ad8\u6548\uff1a\u7d27\u51d1\u7684\u6570\u636e\u7ed3\u6784\u8bbe\u8ba1\uff0c\u6700\u5c0f\u5316\u5185\u5b58\u5360\u7528</li> <li>\u6b7b\u9501\u907f\u514d\uff1a\u591a\u9501\u573a\u666f\u4e0b\u7684\u81ea\u52a8\u6b7b\u9501\u907f\u514d\u7b97\u6cd5</li> <li>\u7ebf\u7a0b\u5b89\u5168\u5206\u6790\u652f\u6301\uff1a\u96c6\u6210 Clang \u7ebf\u7a0b\u5b89\u5168\u6ce8\u89e3</li> </ul>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#_3","title":"\u67b6\u6784\u8bbe\u8ba1","text":""},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#_4","title":"\u5e73\u53f0\u62bd\u8c61\u5c42","text":"<p>Ark Runtime \u7684\u9501\u5b9e\u73b0\u91c7\u7528\u4e24\u5c42\u67b6\u6784\uff1a</p> <pre><code>graph TB\n    subgraph \"\u7edf\u4e00\u63a5\u53e3\u5c42\"\n        A[libarkbase/os/mutex.h]\n        A --&gt; B[Mutex]\n        A --&gt; C[RecursiveMutex]\n        A --&gt; D[RWLock]\n        A --&gt; E[ConditionVariable]\n        A --&gt; F[Event]\n        A --&gt; G[LockHolder]\n        A --&gt; H[ScopedLock]\n    end\n\n    A --&gt; I{\u5e73\u53f0\u9009\u62e9}\n\n    subgraph \"Futex \u5b9e\u73b0 (Linux)\"\n        I --&gt;|PANDA_USE_FUTEX| J[platforms/unix/libarkbase/futex/]\n        J --&gt; J1[mutex.h]\n        J --&gt; J2[fmutex.h]\n        J --&gt; J3[fmutex.cpp]\n        J --&gt; J4[mutex.cpp]\n    end\n\n    subgraph \"pthread \u5b9e\u73b0 (\u5176\u4ed6\u5e73\u53f0)\"\n        I --&gt;|!PANDA_USE_FUTEX| K[libarkbase/os/mutex.cpp]\n        K --&gt; K1[pthread_mutex_t]\n        K --&gt; K2[pthread_rwlock_t]\n        K --&gt; K3[pthread_cond_t]\n    end</code></pre>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#_5","title":"\u6761\u4ef6\u7f16\u8bd1","text":"<p>\u6839\u636e <code>PANDA_USE_FUTEX</code> \u5b8f\u9009\u62e9\u5b9e\u73b0\uff1a</p> <pre><code>#if defined(PANDA_USE_FUTEX)\n    // \u4f7f\u7528\u57fa\u4e8e futex \u7684\u9ad8\u6027\u80fd\u5b9e\u73b0\n    using Mutex = ark::os::unix::memory::futex::Mutex;\n    using RecursiveMutex = ark::os::unix::memory::futex::RecursiveMutex;\n    using RWLock = ark::os::unix::memory::futex::RWLock;\n    using ConditionVariable = ark::os::unix::memory::futex::ConditionVariable;\n#else\n    // \u4f7f\u7528 pthread \u6807\u51c6\u5b9e\u73b0\n    class Mutex { /* pthread_mutex_t \u5305\u88c5 */ };\n    class RecursiveMutex : public Mutex { /* ... */ };\n    class RWLock { /* pthread_rwlock_t \u5305\u88c5 */ };\n    class ConditionVariable { /* pthread_cond_t \u5305\u88c5 */ };\n#endif\n</code></pre>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#_6","title":"\u9501\u7c7b\u578b\u8be6\u89e3","text":""},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#1-mutex","title":"1. Mutex\uff08\u4e92\u65a5\u9501\uff09","text":""},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#_7","title":"\u57fa\u672c\u7279\u6027","text":"<ul> <li>\u7c7b\u578b\uff1a\u975e\u9012\u5f52\u4e92\u65a5\u9501</li> <li>\u7528\u9014\uff1a\u4fdd\u62a4\u4e34\u754c\u533a\uff0c\u786e\u4fdd\u540c\u4e00\u65f6\u523b\u53ea\u6709\u4e00\u4e2a\u7ebf\u7a0b\u8bbf\u95ee</li> <li>\u5b9e\u73b0\uff1a\u57fa\u4e8e futex \u7684\u81ea\u5b9a\u4e49\u5b9e\u73b0\uff08Linux\uff09\u6216 pthread_mutex\uff08\u5176\u4ed6\u5e73\u53f0\uff09</li> </ul>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#_8","title":"\u7279\u6b8a\u529f\u80fd","text":"<p>LockForOther / UnlockForOther\uff1a - \u7528\u9014\uff1a\u7528\u4e8e Monitor \u7cfb\u7edf\uff0c\u5141\u8bb8\u4e3a\u5176\u4ed6\u7ebf\u7a0b\u52a0\u9501/\u89e3\u9501 - \u9650\u5236\uff1a\u4ec5\u7528\u4e8e\u65b0\u521b\u5efa\u7684\u3001\u5c1a\u672a\u4f7f\u7528\u7684 mutex - \u573a\u666f\uff1a\u5bf9\u8c61\u76d1\u89c6\u5668\u7684\u521d\u59cb\u5316\uff0c\u9700\u8981\u5c06\u9501\u8f6c\u79fb\u7ed9\u7279\u5b9a\u7ebf\u7a0b</p> <pre><code>// Monitor \u7cfb\u7edf\u4f7f\u7528\u793a\u4f8b\nvoid Monitor::LockForThread(MTManagedThread *thread) {\n    ASSERT(thread-&gt;GetStatus() != ThreadStatus::RUNNING);\n    lock_.LockForOther(thread-&gt;GetId());  // \u4e3a\u5176\u4ed6\u7ebf\u7a0b\u52a0\u9501\n}\n\nvoid Monitor::UnlockForThread(MTManagedThread *thread) {\n    ASSERT(thread-&gt;GetStatus() != ThreadStatus::RUNNING);\n    lock_.UnlockForOther(thread-&gt;GetId());  // \u4e3a\u5176\u4ed6\u7ebf\u7a0b\u89e3\u9501\n}\n</code></pre>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#futex","title":"Futex \u5b9e\u73b0\u6838\u5fc3\u6570\u636e\u7ed3\u6784","text":"<pre><code>struct fmutex {\n    // \u72b6\u6001\u548c\u7b49\u5f85\u8005\u8ba1\u6570\uff08\u4f4d\u7f16\u7801\uff09\n    // \u6700\u4f4e\u4f4d\uff1a0 = \u672a\u9501\u5b9a, 1 = \u5df2\u9501\u5b9a\n    // \u5176\u4ed6\u4f4d\uff1a\u7b49\u5f85\u8005\u6570\u91cf\n    ATOMIC_INT stateAndWaiters;\n\n    // \u72ec\u5360\u6240\u6709\u8005\u7ebf\u7a0b ID\n    ATOMIC(THREAD_ID) exclusiveOwner;\n\n    // \u9012\u5f52\u8ba1\u6570\uff08\u7528\u4e8e RecursiveMutex\uff09\n    int recursiveCount;\n\n    // \u662f\u5426\u4e3a\u9012\u5f52\u9501\n    bool recursiveMutex;\n};\n</code></pre>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#_9","title":"\u52a0\u9501\u6d41\u7a0b","text":"<pre><code>flowchart TD\n    Start[Lock] --&gt; CheckRecursive{\u68c0\u67e5\u662f\u5426\u4e3a\u9012\u5f52\u9501&lt;br/&gt;\u4e14\u5df2\u6301\u6709}\n    CheckRecursive --&gt;|\u662f| FastPath1[recursiveCount++&lt;br/&gt;\u76f4\u63a5\u8fd4\u56de&lt;br/&gt;\u5feb\u901f\u8def\u5f84]\n    CheckRecursive --&gt;|\u5426| TryCAS[\u5c1d\u8bd5 CAS \u83b7\u53d6\u9501]\n    TryCAS --&gt;|\u6210\u529f| SetOwner[\u8bbe\u7f6e exclusiveOwner&lt;br/&gt;\u8fd4\u56de]\n    TryCAS --&gt;|\u5931\u8d25| SpinWait[\u81ea\u65cb\u7b49\u5f85&lt;br/&gt;WaitBrieflyFor&lt;br/&gt;\u6700\u591a 50 \u6b21\u8fed\u4ee3&lt;br/&gt;\u5e26\u6307\u6570\u9000\u907f]\n    SpinWait --&gt;|\u6210\u529f| SetOwner\n    SpinWait --&gt;|\u5931\u8d25| FutexWait[\u8fdb\u5165 futex \u7b49\u5f85]\n    FutexWait --&gt; IncWaiters[IncrementWaiters]\n    IncWaiters --&gt; FutexCall[futex FUTEX_WAIT_PRIVATE]\n    FutexCall --&gt; DecWaiters[DecrementWaiters]\n    DecWaiters --&gt; TryCAS</code></pre>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#_10","title":"\u89e3\u9501\u6d41\u7a0b","text":"<pre><code>flowchart TD\n    Start[Unlock] --&gt; CheckOwner[\u68c0\u67e5\u7ebf\u7a0b\u6240\u6709\u6743]\n    CheckOwner --&gt; CheckRecursive{\u9012\u5f52\u9501\u4e14&lt;br/&gt;recursiveCount &gt; 0}\n    CheckRecursive --&gt;|\u662f| FastPath2[recursiveCount--&lt;br/&gt;\u76f4\u63a5\u8fd4\u56de&lt;br/&gt;\u5feb\u901f\u8def\u5f84]\n    CheckRecursive --&gt;|\u5426| ClearMask[\u6e05\u9664 HELD_MASK \u4f4d&lt;br/&gt;CAS]\n    ClearMask --&gt; CheckWaiters{\u662f\u5426\u6709\u7b49\u5f85\u8005}\n    CheckWaiters --&gt;|\u662f| WakeOne[futex FUTEX_WAKE_PRIVATE&lt;br/&gt;WAKE_ONE]\n    CheckWaiters --&gt;|\u5426| End[\u7ed3\u675f]\n    WakeOne --&gt; End</code></pre>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#_11","title":"\u5173\u952e\u4f18\u5316","text":"<ol> <li>\u5feb\u901f\u8def\u5f84\u4f18\u5316\uff1a\u65e0\u7ade\u4e89\u65f6\u4ec5\u9700\u4e00\u6b21 CAS \u64cd\u4f5c</li> <li>\u81ea\u65cb\u7b49\u5f85\uff1a\u77ed\u6682\u81ea\u65cb\u907f\u514d\u4e0d\u5fc5\u8981\u7684\u7cfb\u7edf\u8c03\u7528</li> <li>\u4f4d\u7f16\u7801\uff1a\u72b6\u6001\u548c\u7b49\u5f85\u8005\u8ba1\u6570\u5408\u5e76\uff0c\u51cf\u5c11\u5185\u5b58\u5360\u7528</li> <li>\u5185\u5b58\u5e8f\u4f18\u5316\uff1a\u4f7f\u7528 relaxed/acquire/release \u8bed\u4e49\uff0c\u51cf\u5c11\u5185\u5b58\u5c4f\u969c\u5f00\u9500</li> </ol>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#2-recursivemutex","title":"2. RecursiveMutex\uff08\u9012\u5f52\u4e92\u65a5\u9501\uff09","text":""},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#_12","title":"\u57fa\u672c\u7279\u6027","text":"<ul> <li>\u7c7b\u578b\uff1a\u9012\u5f52\u4e92\u65a5\u9501</li> <li>\u7528\u9014\uff1a\u5141\u8bb8\u540c\u4e00\u7ebf\u7a0b\u591a\u6b21\u52a0\u9501</li> <li>\u5b9e\u73b0\uff1a\u7ee7\u627f\u81ea Mutex\uff0c\u8bbe\u7f6e <code>recursiveMutex = true</code></li> </ul>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#_13","title":"\u5b9e\u73b0\u7ec6\u8282","text":"<pre><code>class RecursiveMutex : public Mutex {\npublic:\n    RecursiveMutex() : Mutex(true) {}  // \u8bbe\u7f6e recursiveMutex = true\n};\n</code></pre>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#_14","title":"\u9012\u5f52\u52a0\u9501\u6d41\u7a0b","text":"<pre><code>flowchart TD\n    Start[Lock \u5df2\u6301\u6709\u9501] --&gt; Check{\u68c0\u67e5 recursiveMutex&lt;br/&gt;&amp;&amp; IsHeld current_tid}\n    Check --&gt;|\u662f| RecursivePath[recursiveCount++&lt;br/&gt;\u76f4\u63a5\u8fd4\u56de&lt;br/&gt;\u5feb\u901f\u8def\u5f84]\n    Check --&gt;|\u5426| NormalPath[\u6267\u884c\u6b63\u5e38\u52a0\u9501\u6d41\u7a0b]</code></pre>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#_15","title":"\u4f7f\u7528\u573a\u666f","text":"<p>\u9012\u5f52\u9501\u9002\u7528\u4e8e\u4ee5\u4e0b\u573a\u666f\uff1a</p> <ol> <li>\u56de\u8c03\u51fd\u6570\uff1a\u5916\u90e8\u56de\u8c03\u53ef\u80fd\u89e6\u53d1\u9012\u5f52\u8c03\u7528</li> <li>\u865a\u51fd\u6570/\u63a5\u53e3\uff1a\u5b50\u7c7b\u5b9e\u73b0\u53ef\u80fd\u8c03\u7528\u57fa\u7c7b\u65b9\u6cd5</li> <li>\u7b2c\u4e09\u65b9\u5e93\u96c6\u6210\uff1a\u65e0\u6cd5\u63a7\u5236\u5916\u90e8\u4ee3\u7801\u7684\u8c03\u7528\u94fe</li> <li>\u5168\u5c40\u9501\uff1a\u590d\u6742\u8c03\u7528\u94fe\u4e2d\u96be\u4ee5\u907f\u514d\u9012\u5f52</li> </ol> <p>\u793a\u4f8b\uff1a <pre><code>class ClassLinkerExtension {\n    RecursiveMutex contextsLock_;\n\n    void EnumerateClasses(Callback cb) {\n        LockHolder lock(contextsLock_);\n        for (auto* ctx : contexts_) {\n            ctx-&gt;EnumerateClasses(cb);  // \u56de\u8c03\u53ef\u80fd\u518d\u6b21\u52a0\u9501\n        }\n    }\n};\n</code></pre></p>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#3-rwlock","title":"3. RWLock\uff08\u8bfb\u5199\u9501\uff09","text":""},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#_16","title":"\u57fa\u672c\u7279\u6027","text":"<ul> <li>\u7c7b\u578b\uff1a\u8bfb\u5199\u5206\u79bb\u9501</li> <li>\u7528\u9014\uff1a\u591a\u8bfb\u4e00\u5199\u573a\u666f\uff0c\u63d0\u9ad8\u5e76\u53d1\u6027\u80fd</li> <li>\u5b9e\u73b0\uff1a\u57fa\u4e8e\u539f\u5b50\u64cd\u4f5c\u548c futex \u7684\u81ea\u5b9a\u4e49\u5b9e\u73b0</li> </ul>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#_17","title":"\u6838\u5fc3\u6570\u636e\u7ed3\u6784","text":"<pre><code>class RWLock {\n    // \u72b6\u6001\u7f16\u7801\uff1a\n    // -1: \u5199\u9501\u5b9a\n    //  0: \u672a\u9501\u5b9a\n    // &gt;0: \u8bfb\u9501\u5b9a\uff08\u503c\u4e3a\u8bfb\u8005\u6570\u91cf\uff09\n    std::atomic_int32_t state_ {0};\n\n    // \u72ec\u5360\u6240\u6709\u8005\uff08\u5199\u9501\u6301\u6709\u8005\uff09\n    std::atomic&lt;ThreadId&gt; exclusiveOwner_ {0};\n\n    // \u7b49\u5f85\u8005\u6570\u91cf\n    std::atomic_uint32_t waiters_ {0};\n};\n</code></pre>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#_18","title":"\u8bfb\u9501\u6d41\u7a0b","text":"<pre><code>flowchart TD\n    Start[ReadLock] --&gt; CheckState{\u68c0\u67e5 state_ &gt;= 0&lt;br/&gt;\u672a\u5199\u9501\u5b9a}\n    CheckState --&gt;|\u662f| TryCAS[CAS: state_ = state_ + 1]\n    TryCAS --&gt;|\u6210\u529f| FastPath[\u8fd4\u56de&lt;br/&gt;\u5feb\u901f\u8def\u5f84]\n    TryCAS --&gt;|\u5931\u8d25| WaitWrite[\u7b49\u5f85\u5199\u9501\u91ca\u653e]\n    CheckState --&gt;|\u5426| WaitWrite\n    WaitWrite --&gt; Spin[\u81ea\u65cb\u7b49\u5f85]\n    Spin --&gt; FutexWait[futex \u7b49\u5f85]\n    FutexWait --&gt; CheckState</code></pre>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#_19","title":"\u5199\u9501\u6d41\u7a0b","text":"<pre><code>flowchart TD\n    Start[WriteLock] --&gt; CheckUnlocked{\u68c0\u67e5 state_ == 0&lt;br/&gt;\u672a\u9501\u5b9a}\n    CheckUnlocked --&gt;|\u662f| TryCAS[CAS: state_ = -1]\n    TryCAS --&gt;|\u6210\u529f| SetOwner[\u8bbe\u7f6e exclusiveOwner_&lt;br/&gt;\u8fd4\u56de]\n    TryCAS --&gt;|\u5931\u8d25| WaitAll[\u7b49\u5f85\u6240\u6709\u8bfb\u9501\u548c\u5199\u9501\u91ca\u653e]\n    CheckUnlocked --&gt;|\u5426| WaitAll\n    WaitAll --&gt; Spin[\u81ea\u65cb\u7b49\u5f85]\n    Spin --&gt; FutexWait[futex \u7b49\u5f85]\n    FutexWait --&gt; CheckUnlocked</code></pre>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#_20","title":"\u6027\u80fd\u7279\u70b9","text":"<ul> <li>\u8bfb\u591a\u5199\u5c11\u573a\u666f\uff1a\u663e\u8457\u63d0\u5347\u5e76\u53d1\u6027\u80fd</li> <li>\u5185\u8054\u4f18\u5316\uff1a<code>ReadLock()</code> \u548c <code>Unlock()</code> \u4f7f\u7528 <code>ALWAYS_INLINE</code></li> <li>\u5185\u5b58\u5bf9\u9f50\uff1a\u7ed3\u6784\u4f53\u5927\u5c0f\u56fa\u5b9a\u4e3a 16 \u5b57\u8282\uff0c\u4f18\u5316\u7f13\u5b58\u6027\u80fd</li> </ul>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#4-conditionvariable","title":"4. ConditionVariable\uff08\u6761\u4ef6\u53d8\u91cf\uff09","text":""},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#_21","title":"\u57fa\u672c\u7279\u6027","text":"<ul> <li>\u7c7b\u578b\uff1a\u6761\u4ef6\u53d8\u91cf</li> <li>\u7528\u9014\uff1a\u7ebf\u7a0b\u95f4\u6761\u4ef6\u7b49\u5f85\u548c\u901a\u77e5</li> <li>\u5b9e\u73b0\uff1a\u57fa\u4e8e futex \u7684\u81ea\u5b9a\u4e49\u5b9e\u73b0</li> </ul>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#_22","title":"\u6838\u5fc3\u6570\u636e\u7ed3\u6784","text":"<pre><code>struct CondVar {\n    // \u5173\u8054\u7684\u4e92\u65a5\u9501\u6307\u9488\n    alignas(alignof(uint64_t)) ATOMIC(struct fmutex *) mutexPtr;\n\n    // \u6761\u4ef6\u503c\uff08\u53d8\u5316\u5373\u89e6\u53d1\uff09\n    ATOMIC(int32_t) cond;\n\n    // \u7b49\u5f85\u8005\u6570\u91cf\n    ATOMIC(int32_t) waiters;\n};\n</code></pre>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#wait","title":"Wait \u6d41\u7a0b","text":"<pre><code>flowchart TD\n    Start[Wait mutex] --&gt; CheckHeld[\u68c0\u67e5 mutex \u662f\u5426\u5df2\u6301\u6709]\n    CheckHeld --&gt; SetMutexPtr[\u8bbe\u7f6e cond-&gt;mutexPtr = mutex]\n    SetMutexPtr --&gt; IncWaiters[IncrementWaiters mutex]\n    IncWaiters --&gt; UnlockMutex[MutexUnlock mutex&lt;br/&gt;\u539f\u5b50\u91ca\u653e\u9501]\n    UnlockMutex --&gt; FutexWait[futex FUTEX_WAIT_PRIVATE&lt;br/&gt;\u7b49\u5f85\u6761\u4ef6]\n    FutexWait --&gt; LockMutex[MutexLock mutex&lt;br/&gt;\u91cd\u65b0\u83b7\u53d6\u9501]\n    LockMutex --&gt; End[\u7ed3\u675f]</code></pre>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#signal","title":"Signal \u6d41\u7a0b","text":"<pre><code>flowchart TD\n    Start[Signal] --&gt; CheckWaiters{\u68c0\u67e5\u662f\u5426\u6709\u7b49\u5f85\u8005}\n    CheckWaiters --&gt;|\u5426| End1[\u7ed3\u675f]\n    CheckWaiters --&gt;|\u662f| IncCond[cond++&lt;br/&gt;\u89e6\u53d1\u6761\u4ef6\u53d8\u5316]\n    IncCond --&gt; CheckMutexHeld{\u5f53\u524d\u7ebf\u7a0b&lt;br/&gt;\u662f\u5426\u6301\u6709 mutex}\n    CheckMutexHeld --&gt;|\u662f| Requeue[futex FUTEX_REQUEUE_PRIVATE&lt;br/&gt;\u8f6c\u79fb\u5230 mutex \u7b49\u5f85\u961f\u5217]\n    CheckMutexHeld --&gt;|\u5426| Wake[futex FUTEX_WAKE_PRIVATE&lt;br/&gt;\u5524\u9192\u7b49\u5f85\u8005]\n    Requeue --&gt; End2[\u7ed3\u675f]\n    Wake --&gt; End2</code></pre>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#_23","title":"\u4f18\u5316\u7279\u6027","text":"<ul> <li>Requeue \u4f18\u5316\uff1a\u5982\u679c\u4fe1\u53f7\u53d1\u9001\u8005\u6301\u6709 mutex\uff0c\u76f4\u63a5\u5c06\u7b49\u5f85\u8005\u8f6c\u79fb\u5230 mutex \u961f\u5217\uff0c\u51cf\u5c11\u5524\u9192\u5ef6\u8fdf</li> <li>\u539f\u5b50\u64cd\u4f5c\uff1a\u4f7f\u7528\u539f\u5b50\u64cd\u4f5c\u4fdd\u8bc1\u7ebf\u7a0b\u5b89\u5168</li> </ul>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#5-event","title":"5. Event\uff08\u4e8b\u4ef6\uff09","text":""},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#_24","title":"\u57fa\u672c\u7279\u6027","text":"<ul> <li>\u7c7b\u578b\uff1a\u4e00\u6b21\u6027\u4e8b\u4ef6</li> <li>\u7528\u9014\uff1a\u7ebf\u7a0b\u95f4\u4e8b\u4ef6\u901a\u77e5</li> <li>\u5b9e\u73b0\uff1a\u57fa\u4e8e Mutex + ConditionVariable</li> </ul>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#_25","title":"\u5b9e\u73b0","text":"<pre><code>class Event {\n    bool happened_ = false;\n    Mutex lock_;\n    ConditionVariable cv_;\n\n    void Wait() {\n        LockHolder lh(lock_);\n        while (!happened_) {\n            cv_.Wait(&amp;lock_);\n        }\n    }\n\n    void Fire() {\n        LockHolder lh(lock_);\n        happened_ = true;\n        cv_.SignalAll();\n    }\n};\n</code></pre>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#6-dummylock","title":"6. DummyLock\uff08\u7a7a\u9501\uff09","text":""},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#_26","title":"\u57fa\u672c\u7279\u6027","text":"<ul> <li>\u7c7b\u578b\uff1a\u7a7a\u64cd\u4f5c\u9501</li> <li>\u7528\u9014\uff1a\u6a21\u677f\u4ee3\u7801\u4e2d\u7684\u5360\u4f4d\u7b26\uff0c\u63d0\u4f9b\u7edf\u4e00\u63a5\u53e3\u4f46\u4e0d\u5b9e\u9645\u52a0\u9501</li> <li>\u5b9e\u73b0\uff1a\u6240\u6709\u65b9\u6cd5\u90fd\u662f\u7a7a\u64cd\u4f5c</li> </ul>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#_27","title":"\u5b9e\u73b0","text":"<pre><code>class CAPABILITY(\"mutex\") DummyLock {\npublic:\n    void Lock() const ACQUIRE() {}\n    bool TryLock() const TRY_ACQUIRE(true) { return true; }\n    void Unlock() const RELEASE() {}\n    void ReadLock() const ACQUIRE_SHARED() {}\n    void WriteLock() const ACQUIRE() {}\n    // ... \u5176\u4ed6\u65b9\u6cd5\u90fd\u662f\u7a7a\u64cd\u4f5c\n};\n</code></pre>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#_28","title":"\u4f7f\u7528\u573a\u666f","text":"<ul> <li>\u6761\u4ef6\u7f16\u8bd1\uff1a\u67d0\u4e9b\u914d\u7f6e\u4e0b\u4e0d\u9700\u8981\u9501\u4fdd\u62a4</li> <li>\u6a21\u677f\u4ee3\u7801\uff1a\u7edf\u4e00\u63a5\u53e3\uff0c\u4f46\u67d0\u4e9b\u5b9e\u4f8b\u4e0d\u9700\u8981\u540c\u6b65</li> <li>\u6d4b\u8bd5\uff1a\u7b80\u5316\u6d4b\u8bd5\u4ee3\u7801</li> </ul> <p>\u793a\u4f8b\uff1a <pre><code>template &lt;bool NEED_SYNC&gt;\nclass Container {\n    using LockType = std::conditional_t&lt;NEED_SYNC, Mutex, DummyLock&gt;;\n    LockType lock_;\n\n    void Access() {\n        LockHolder lock(lock_);  // \u7edf\u4e00\u63a5\u53e3\n        // \u64cd\u4f5c\n    }\n};\n</code></pre></p>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#_29","title":"\u5e95\u5c42\u5b9e\u73b0\u673a\u5236","text":""},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#futex_1","title":"Futex \u7cfb\u7edf\u8c03\u7528","text":"<p>Futex\uff08Fast Userspace Mutex\uff09\u662f Linux \u63d0\u4f9b\u7684\u9ad8\u6548\u540c\u6b65\u539f\u8bed\uff1a</p> <pre><code>inline int futex(volatile int *uaddr, int op, int val, \n                 const struct timespec *timeout, \n                 volatile int *uaddr2, int val3) {\n    return syscall(SYS_futex, uaddr, op, val, timeout, uaddr2, val3);\n}\n</code></pre>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#_30","title":"\u4e3b\u8981\u64cd\u4f5c","text":"<ol> <li>FUTEX_WAIT_PRIVATE\uff1a\u7b49\u5f85\u5730\u5740\u503c\u53d8\u5316</li> <li>FUTEX_WAKE_PRIVATE\uff1a\u5524\u9192\u7b49\u5f85\u8005</li> <li>FUTEX_REQUEUE_PRIVATE\uff1a\u5c06\u7b49\u5f85\u8005\u8f6c\u79fb\u5230\u53e6\u4e00\u4e2a\u5730\u5740\u7684\u7b49\u5f85\u961f\u5217</li> <li>FUTEX_WAIT_BITSET_PRIVATE\uff1a\u652f\u6301\u8d85\u65f6\u7684\u7b49\u5f85</li> </ol>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#_31","title":"\u81ea\u65cb\u7b49\u5f85\u7b56\u7565","text":""},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#backoff","title":"BackOff \u7b97\u6cd5","text":"<pre><code>static void BackOff(uint32_t i) {\n    static constexpr uint32_t SPIN_MAX = 10;\n    if (i &lt;= SPIN_MAX) {\n        // \u77ed\u65f6\u95f4\uff1aCPU \u81ea\u65cb\n        volatile uint32_t x = 0;\n        const uint32_t spinCount = 10 * i;  // \u6307\u6570\u589e\u957f\n        for (uint32_t spin = 0; spin &lt; spinCount; spin++) {\n            ++x;\n        }\n    } else {\n        // \u957f\u65f6\u95f4\uff1a\u8ba9\u51fa CPU\n        ark::os::thread::Yield();\n    }\n}\n</code></pre>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#waitbrieflyfor","title":"WaitBrieflyFor","text":"<pre><code>static inline bool WaitBrieflyFor(ATOMIC_INT *addr) {\n    static constexpr uint32_t MAX_BACK_OFF = 10;\n    static constexpr uint32_t MAX_ITER = 50;\n\n    for (uint32_t i = 1; i &lt;= MAX_ITER; i++) {\n        BackOff(std::min(i, MAX_BACK_OFF));\n        int state = ATOMIC_LOAD(addr, memory_order_relaxed);\n        if ((state &amp; HELD_MASK) == 0) {\n            return true;  // \u9501\u5df2\u91ca\u653e\n        }\n    }\n    return false;  // \u8d85\u65f6\uff0c\u9700\u8981 futex \u7b49\u5f85\n}\n</code></pre>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#_32","title":"\u5185\u5b58\u5e8f\u8bed\u4e49","text":"<p>Ark Runtime \u7684\u9501\u5b9e\u73b0\u7cbe\u7ec6\u63a7\u5236\u5185\u5b58\u5e8f\uff1a</p> \u64cd\u4f5c \u5185\u5b58\u5e8f \u539f\u56e0 \u72b6\u6001\u8bfb\u53d6\uff08\u68c0\u67e5\uff09 <code>memory_order_relaxed</code> \u4ec5\u68c0\u67e5\u72b6\u6001\uff0c\u4e0d\u6d89\u53ca\u540c\u6b65 \u52a0\u9501\u6210\u529f <code>memory_order_acquire</code> \u5efa\u7acb acquire \u8bed\u4e49\uff0c\u4fdd\u8bc1\u540e\u7eed\u64cd\u4f5c\u53ef\u89c1 \u89e3\u9501 <code>memory_order_release</code> \u5efa\u7acb release \u8bed\u4e49\uff0c\u4fdd\u8bc1\u4e4b\u524d\u64cd\u4f5c\u53ef\u89c1 RWLock \u5199\u89e3\u9501 <code>memory_order_seq_cst</code> \u9700\u8981\u4e0e waiters_ \u7684\u8bfb\u53d6\u4fdd\u6301\u987a\u5e8f"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#raii","title":"RAII \u9501\u5305\u88c5\u5668","text":""},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#1-lockholder","title":"1. LockHolder\uff08\u5355\u9501\u5305\u88c5\u5668\uff09","text":""},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#_33","title":"\u57fa\u672c\u7528\u6cd5","text":"<pre><code>template &lt;class T, bool NEED_LOCK = true&gt;\nclass SCOPED_CAPABILITY LockHolder {\n    explicit LockHolder(T &amp;lock) ACQUIRE(lock) : lock_(lock) {\n        if constexpr (NEED_LOCK) {\n            lock_.Lock();\n        }\n    }\n\n    ~LockHolder() RELEASE() {\n        if constexpr (NEED_LOCK) {\n            lock_.Unlock();\n        }\n    }\n\nprivate:\n    T &amp;lock_;\n};\n</code></pre>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#_34","title":"\u4f7f\u7528\u793a\u4f8b","text":"<pre><code>void CriticalSection() {\n    LockHolder lock(mutex_);  // \u81ea\u52a8\u52a0\u9501\n    // \u4e34\u754c\u533a\u4ee3\u7801\n    // \u6790\u6784\u65f6\u81ea\u52a8\u89e3\u9501\n}\n</code></pre>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#2-scopedlock","title":"2. ScopedLock\uff08\u591a\u9501\u5305\u88c5\u5668\uff09","text":""},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#_35","title":"\u6b7b\u9501\u907f\u514d\u7b97\u6cd5","text":"<p><code>ScopedLock</code> \u5b9e\u73b0\u4e86\u81ea\u52a8\u6b7b\u9501\u907f\u514d\u7b97\u6cd5\uff1a</p> <pre><code>template &lt;bool NEED_LOCK = true, class... T&gt;\nclass ScopedLock {\n    explicit ScopedLock(T &amp;...locks) : locks_(std::tie(locks...)) {\n        if constexpr (NEED_LOCK) {\n            Lock&lt;LockType::LOCK&gt;(locks...);  // \u6b7b\u9501\u907f\u514d\u7b97\u6cd5\n        }\n    }\n};\n</code></pre>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#_36","title":"\u6b7b\u9501\u907f\u514d\u539f\u7406","text":"<pre><code>template &lt;LockType TYPE, class L0, class... L1&gt;\nvoid Lock(L0 &amp;lock0, L1 &amp;...rest) {\n    detail::LockMutex&lt;TYPE&gt;(lock0);  // \u5148\u9501\u7b2c\u4e00\u4e2a\n\n    int failedIndex = detail::TryLock&lt;TYPE&gt;(rest...);\n    if (failedIndex == -1) {\n        return;  // \u5168\u90e8\u6210\u529f\n    }\n\n    // \u5931\u8d25\uff1a\u91ca\u653e\u5df2\u6301\u6709\u7684\u9501\uff0c\u8ba9\u51fa CPU\uff0c\u91cd\u65b0\u5c1d\u8bd5\n    lock0.Unlock();\n    thread::Yield();\n    Lock&lt;TYPE&gt;(rest..., lock0);  // \u9012\u5f52\u8c03\u7528\uff0c\u6539\u53d8\u9501\u987a\u5e8f\n}\n</code></pre> <p>\u5173\u952e\u70b9\uff1a - \u6309\u987a\u5e8f\u5c1d\u8bd5\u52a0\u9501 - \u5931\u8d25\u65f6\u91ca\u653e\u6240\u6709\u5df2\u6301\u6709\u7684\u9501 - \u8ba9\u51fa CPU\uff0c\u6539\u53d8\u9501\u987a\u5e8f\u540e\u91cd\u8bd5 - \u907f\u514d\u5faa\u73af\u7b49\u5f85\u5bfc\u81f4\u7684\u6b7b\u9501</p>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#3-readlockholder-writelockholder","title":"3. ReadLockHolder / WriteLockHolder","text":"<p>\u7528\u4e8e RWLock \u7684\u4e13\u7528\u5305\u88c5\u5668\uff1a</p> <pre><code>ReadLockHolder readLock(rwlock_);   // \u8bfb\u9501\nWriteLockHolder writeLock(rwlock_);  // \u5199\u9501\n</code></pre>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#_37","title":"\u6b7b\u9501\u907f\u514d\u7b97\u6cd5","text":""},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#_38","title":"\u7b97\u6cd5\u6d41\u7a0b","text":"<pre><code>flowchart TD\n    Start[Lock lock0, lock1, lock2] --&gt; Lock0[Lock lock0&lt;br/&gt;\u6210\u529f]\n    Lock0 --&gt; TryLock1[TryLock lock1&lt;br/&gt;\u6210\u529f]\n    TryLock1 --&gt; TryLock2[TryLock lock2]\n    TryLock2 --&gt;|\u6210\u529f| AllLocked[\u5168\u90e8\u52a0\u9501\u6210\u529f]\n    TryLock2 --&gt;|\u5931\u8d25| Unlock1[Unlock lock1]\n    Unlock1 --&gt; Unlock0[Unlock lock0]\n    Unlock0 --&gt; Yield[Yield \u8ba9\u51fa CPU]\n    Yield --&gt; Retry[Lock lock1, lock2, lock0&lt;br/&gt;\u6539\u53d8\u987a\u5e8f\u91cd\u8bd5]\n    Retry --&gt; Start</code></pre>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#_39","title":"\u7b97\u6cd5\u7279\u70b9","text":"<ol> <li>\u975e\u963b\u585e\uff1a\u4e0d\u4f1a\u6c38\u4e45\u963b\u585e</li> <li>\u516c\u5e73\u6027\uff1a\u901a\u8fc7\u6539\u53d8\u9501\u987a\u5e8f\u907f\u514d\u9965\u997f</li> <li>\u6548\u7387\uff1a\u5728\u4f4e\u7ade\u4e89\u573a\u666f\u4e0b\u51e0\u4e4e\u65e0\u5f00\u9500</li> </ol>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#_40","title":"\u4f7f\u7528\u5efa\u8bae","text":"<ul> <li>\u56fa\u5b9a\u987a\u5e8f\uff1a\u5982\u679c\u53ef\u80fd\uff0c\u59cb\u7ec8\u6309\u76f8\u540c\u987a\u5e8f\u52a0\u9501</li> <li>\u6700\u5c0f\u5316\u9501\u6570\u91cf\uff1a\u51cf\u5c11\u9700\u8981\u540c\u65f6\u6301\u6709\u7684\u9501\u6570\u91cf</li> <li>\u4f7f\u7528 ScopedLock\uff1a\u81ea\u52a8\u5904\u7406\u6b7b\u9501\u907f\u514d</li> </ul>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#_41","title":"\u6027\u80fd\u4f18\u5316\u7b56\u7565","text":""},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#1","title":"1. \u5feb\u901f\u8def\u5f84\u4f18\u5316","text":""},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#mutex","title":"Mutex \u5feb\u901f\u8def\u5f84","text":"<pre><code>// \u65e0\u7ade\u4e89\u65f6\u7684\u5feb\u901f\u8def\u5f84\nauto curState = ATOMIC_LOAD(&amp;m-&gt;stateAndWaiters, memory_order_relaxed);\nif (LIKELY((curState &amp; HELD_MASK) == 0)) {\n    auto newState = curState | HELD_MASK;\n    if (CAS_WEAK(&amp;m-&gt;stateAndWaiters, curState, newState, \n                 memory_order_acquire, memory_order_relaxed)) {\n        // \u6210\u529f\uff01\u4ec5\u9700\u4e00\u6b21 CAS\n        return;\n    }\n}\n</code></pre> <p>\u6027\u80fd\uff1a\u65e0\u7ade\u4e89\u65f6\u4ec5\u9700 1 \u6b21\u539f\u5b50\u64cd\u4f5c</p>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#2","title":"2. \u81ea\u65cb\u7b49\u5f85\u4f18\u5316","text":"<ul> <li>\u77ed\u65f6\u95f4\u81ea\u65cb\uff1a\u907f\u514d\u4e0d\u5fc5\u8981\u7684\u7cfb\u7edf\u8c03\u7528</li> <li>\u6307\u6570\u9000\u907f\uff1a\u51cf\u5c11 CPU \u5360\u7528</li> <li>\u81ea\u9002\u5e94\uff1a\u6839\u636e\u7b49\u5f85\u65f6\u95f4\u8c03\u6574\u7b56\u7565</li> </ul>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#3","title":"3. \u5185\u8054\u4f18\u5316","text":"<p>\u5173\u952e\u8def\u5f84\u51fd\u6570\u4f7f\u7528 <code>ALWAYS_INLINE</code>\uff1a</p> <pre><code>ALWAYS_INLINE void ReadLock() ACQUIRE_SHARED() {\n    // \u5185\u8054\u5b9e\u73b0\uff0c\u51cf\u5c11\u51fd\u6570\u8c03\u7528\u5f00\u9500\n}\n</code></pre>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#4","title":"4. \u5185\u5b58\u5e03\u5c40\u4f18\u5316","text":"<ul> <li>\u7d27\u51d1\u7f16\u7801\uff1a\u72b6\u6001\u548c\u7b49\u5f85\u8005\u8ba1\u6570\u5408\u5e76</li> <li>\u7f13\u5b58\u5bf9\u9f50\uff1aRWLock \u56fa\u5b9a 16 \u5b57\u8282\uff0c\u4f18\u5316\u7f13\u5b58\u6027\u80fd</li> <li>\u65e0\u9501\u539f\u5b50\uff1a\u4f7f\u7528 lock-free \u539f\u5b50\u64cd\u4f5c</li> </ul>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#5","title":"5. \u5185\u5b58\u5e8f\u4f18\u5316","text":"<ul> <li>\u6700\u5c0f\u5316\u5c4f\u969c\uff1a\u4ec5\u5728\u5fc5\u8981\u65f6\u4f7f\u7528\u5f3a\u5185\u5b58\u5e8f</li> <li>Relaxed \u8bed\u4e49\uff1a\u5185\u90e8\u72b6\u6001\u68c0\u67e5\u4f7f\u7528 relaxed</li> <li>Acquire/Release\uff1a\u4ec5\u5728\u540c\u6b65\u70b9\u4f7f\u7528</li> </ul>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#_42","title":"\u4f7f\u7528\u573a\u666f\u548c\u6700\u4f73\u5b9e\u8df5","text":""},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#_43","title":"\u4f7f\u7528\u573a\u666f\u7edf\u8ba1","text":"<p>\u6839\u636e\u4ee3\u7801\u5e93\u5206\u6790\uff08577 \u5904 LockHolder \u4f7f\u7528\uff0c93 \u4e2a\u6587\u4ef6\uff09\uff0c\u9501\u7684\u4e3b\u8981\u4f7f\u7528\u573a\u666f\uff1a</p> \u6a21\u5757 \u9501\u7c7b\u578b \u4f7f\u7528\u573a\u666f \u6587\u4ef6\u6570 \u7c7b\u94fe\u63a5\u5668 <code>RecursiveMutex</code> \u56de\u8c03\u51fd\u6570\u573a\u666f\uff0c\u7c7b\u52a0\u8f7d\u4fdd\u62a4 ~10 \u7ebf\u7a0b\u7ba1\u7406 <code>Mutex</code> \u7ebf\u7a0b\u5217\u8868\u3001\u7ebf\u7a0b\u72b6\u6001\u4fdd\u62a4 ~15 \u5185\u5b58\u7ba1\u7406 <code>RWLock</code> / <code>Mutex</code> GC \u64cd\u4f5c\u3001\u5185\u5b58\u5206\u914d\u5668 ~30 \u76d1\u63a7\u5668 <code>Mutex</code> \u5bf9\u8c61\u540c\u6b65\u3001Monitor \u6c60 ~5 \u534f\u7a0b\u7ba1\u7406 <code>RecursiveMutex</code> \u534f\u7a0b\u5de5\u4f5c\u7ebf\u7a0b\u3001\u590d\u6742\u8c03\u7528\u94fe ~8 \u5de5\u5177\u94fe <code>Mutex</code> \u8c03\u8bd5\u5668\u3001\u91c7\u6837\u5668\u3001\u68c0\u67e5\u5668 ~20 \u5176\u4ed6 \u5404\u79cd\u7c7b\u578b \u5b57\u7b26\u4e32\u8868\u3001\u5b9a\u65f6\u5668\u7b49 ~5"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#_44","title":"\u5178\u578b\u4f7f\u7528\u6a21\u5f0f","text":"<p>\u6a21\u5f0f 1\uff1a\u7b80\u5355\u4e34\u754c\u533a\u4fdd\u62a4 <pre><code>class ThreadSafeCounter {\n    Mutex mutex_;\n    int count_ GUARDED_BY(mutex_);\n\npublic:\n    void Increment() {\n        LockHolder lock(mutex_);\n        count_++;\n    }\n};\n</code></pre></p> <p>\u6a21\u5f0f 2\uff1a\u8bfb\u591a\u5199\u5c11\u573a\u666f <pre><code>class SharedData {\n    RWLock rwlock_;\n    Data data_ GUARDED_BY(rwlock_);\n\npublic:\n    Data Read() {\n        ReadLockHolder lock(rwlock_);\n        return data_;\n    }\n\n    void Write(const Data&amp; d) {\n        WriteLockHolder lock(rwlock_);\n        data_ = d;\n    }\n};\n</code></pre></p> <p>\u6a21\u5f0f 3\uff1a\u56de\u8c03\u573a\u666f\uff08\u9700\u8981\u9012\u5f52\u9501\uff09 <pre><code>class ClassLinkerExtension {\n    RecursiveMutex contextsLock_;\n    Vector&lt;Context*&gt; contexts_ GUARDED_BY(contextsLock_);\n\n    void EnumerateClasses(Callback cb) {\n        LockHolder lock(contextsLock_);\n        for (auto* ctx : contexts_) {\n            cb(ctx);  // \u56de\u8c03\u53ef\u80fd\u518d\u6b21\u8c03\u7528 EnumerateClasses\n        }\n    }\n};\n</code></pre></p>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#_45","title":"\u6700\u4f73\u5b9e\u8df5","text":""},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#1_1","title":"1. \u9009\u62e9\u5408\u9002\u7684\u9501\u7c7b\u578b","text":"<pre><code>// \u2705 \u7b80\u5355\u4e34\u754c\u533a\nMutex mutex_;\n\n// \u2705 \u9700\u8981\u9012\u5f52\u52a0\u9501\uff08\u56de\u8c03\u3001\u865a\u51fd\u6570\uff09\nRecursiveMutex recursiveMutex_;\n\n// \u2705 \u8bfb\u591a\u5199\u5c11\nRWLock rwlock_;\n\n// \u2705 \u6761\u4ef6\u7b49\u5f85\nConditionVariable cv_;\nMutex mutex_;\n</code></pre>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#2-raii","title":"2. \u4f7f\u7528 RAII \u5305\u88c5\u5668","text":"<pre><code>// \u2705 \u63a8\u8350\uff1a\u81ea\u52a8\u7ba1\u7406\u9501\u751f\u547d\u5468\u671f\n{\n    LockHolder lock(mutex_);\n    // \u4e34\u754c\u533a\n}\n\n// \u274c \u4e0d\u63a8\u8350\uff1a\u624b\u52a8\u7ba1\u7406\nmutex_.Lock();\n// \u4e34\u754c\u533a\nmutex_.Unlock();  // \u53ef\u80fd\u5fd8\u8bb0\u89e3\u9501\n</code></pre>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#3_1","title":"3. \u907f\u514d\u9012\u5f52\u52a0\u9501\uff08\u5982\u53ef\u80fd\uff09","text":"<pre><code>// \u274c \u9700\u8981\u9012\u5f52\u9501\nclass MyClass {\n    RecursiveMutex mutex_;\n    void PublicMethod() {\n        LockHolder lock(mutex_);\n        PrivateMethod();  // \u5185\u90e8\u518d\u6b21\u52a0\u9501\n    }\n    void PrivateMethod() {\n        LockHolder lock(mutex_);  // \u9012\u5f52\u52a0\u9501\n    }\n};\n\n// \u2705 \u4f18\u5316\uff1a\u6d88\u9664\u9012\u5f52\nclass MyClass {\n    Mutex mutex_;\n    void PublicMethod() {\n        LockHolder lock(mutex_);\n        PrivateMethodImpl();  // \u5185\u90e8\u5b9e\u73b0\uff0c\u4e0d\u52a0\u9501\n    }\nprivate:\n    inline void PrivateMethodImpl() {  // \u5047\u8bbe\u5df2\u6301\u6709\u9501\n        // \u5b9e\u73b0\u903b\u8f91\n    }\n    void PrivateMethod() {  // \u516c\u5f00\u63a5\u53e3\n        LockHolder lock(mutex_);\n        PrivateMethodImpl();\n    }\n};\n</code></pre>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#4-scopedlock","title":"4. \u591a\u9501\u573a\u666f\u4f7f\u7528 ScopedLock","text":"<pre><code>// \u2705 \u63a8\u8350\uff1a\u81ea\u52a8\u6b7b\u9501\u907f\u514d\nScopedLock lock(mutex1_, mutex2_, mutex3_);\n\n// \u274c \u5371\u9669\uff1a\u53ef\u80fd\u6b7b\u9501\nLockHolder lock1(mutex1_);\nLockHolder lock2(mutex2_);\nLockHolder lock3(mutex3_);\n</code></pre>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#5_1","title":"5. \u6700\u5c0f\u5316\u9501\u7c92\u5ea6","text":"<pre><code>// \u274c \u9501\u7c92\u5ea6\u592a\u5927\nvoid ProcessData() {\n    LockHolder lock(mutex_);\n    // \u5927\u91cf\u8ba1\u7b97\uff08\u4e0d\u9700\u8981\u9501\u4fdd\u62a4\uff09\n    // \u5c11\u91cf\u5171\u4eab\u6570\u636e\u8bbf\u95ee\n}\n\n// \u2705 \u9501\u7c92\u5ea6\u5c0f\nvoid ProcessData() {\n    // \u5927\u91cf\u8ba1\u7b97\uff08\u65e0\u9501\uff09\n    {\n        LockHolder lock(mutex_);\n        // \u4ec5\u4fdd\u62a4\u5171\u4eab\u6570\u636e\u8bbf\u95ee\n    }\n}\n</code></pre>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#_46","title":"\u7ebf\u7a0b\u5b89\u5168\u6ce8\u89e3","text":"<p>Ark Runtime \u4f7f\u7528 Clang \u7ebf\u7a0b\u5b89\u5168\u6ce8\u89e3\u8fdb\u884c\u9759\u6001\u5206\u6790\uff1a</p>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#_47","title":"\u6ce8\u89e3\u7c7b\u578b","text":"\u6ce8\u89e3 \u542b\u4e49 \u793a\u4f8b <code>ACQUIRE(lock)</code> \u51fd\u6570\u83b7\u53d6\u9501 <code>void Lock() ACQUIRE();</code> <code>RELEASE(lock)</code> \u51fd\u6570\u91ca\u653e\u9501 <code>void Unlock() RELEASE();</code> <code>TRY_ACQUIRE(true, lock)</code> \u5c1d\u8bd5\u83b7\u53d6\u9501 <code>bool TryLock() TRY_ACQUIRE(true);</code> <code>GUARDED_BY(lock)</code> \u53d8\u91cf\u53d7\u9501\u4fdd\u62a4 <code>int data_ GUARDED_BY(mutex_);</code> <code>SCOPED_CAPABILITY</code> RAII \u9501\u5305\u88c5\u5668 <code>class LockHolder SCOPED_CAPABILITY</code>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#_48","title":"\u4f7f\u7528\u793a\u4f8b","text":"<pre><code>class ThreadSafeCounter {\n    Mutex mutex_;\n    int count_ GUARDED_BY(mutex_);\n\npublic:\n    void Increment() {\n        LockHolder lock(mutex_);  // \u81ea\u52a8\u5206\u6790\n        count_++;  // \u2705 \u6b63\u786e\uff1a\u5728\u9501\u4fdd\u62a4\u4e0b\n    }\n\n    int GetCount() {\n        // count_;  // \u274c \u9519\u8bef\uff1a\u672a\u6301\u6709\u9501\n        LockHolder lock(mutex_);\n        return count_;  // \u2705 \u6b63\u786e\n    }\n};\n</code></pre>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#_49","title":"\u7279\u6b8a\u529f\u80fd","text":""},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#lockforother-unlockforother","title":"LockForOther / UnlockForOther","text":"<p>\u8fd9\u4e24\u4e2a\u65b9\u6cd5\u7528\u4e8e Monitor \u7cfb\u7edf\uff0c\u5141\u8bb8\u4e3a\u5176\u4ed6\u7ebf\u7a0b\u52a0\u9501/\u89e3\u9501\uff1a</p> <pre><code>// \u4e3a\u6307\u5b9a\u7ebf\u7a0b\u52a0\u9501\uff08\u4ec5\u7528\u4e8e\u65b0\u521b\u5efa\u7684 mutex\uff09\nvoid LockForOther(ThreadId thread);\n\n// \u4e3a\u6307\u5b9a\u7ebf\u7a0b\u89e3\u9501\nvoid UnlockForOther(ThreadId thread);\n</code></pre> <p>\u4f7f\u7528\u573a\u666f\uff1a - Monitor \u5bf9\u8c61\u521d\u59cb\u5316\u65f6\uff0c\u9700\u8981\u5c06\u9501\u8f6c\u79fb\u7ed9\u7279\u5b9a\u7ebf\u7a0b - \u7ebf\u7a0b\u72b6\u6001\u8f6c\u6362\u65f6\u7684\u9501\u6240\u6709\u6743\u8f6c\u79fb</p> <p>\u6ce8\u610f\u4e8b\u9879\uff1a - \u4ec5\u7528\u4e8e\u65b0\u521b\u5efa\u7684\u3001\u5c1a\u672a\u4f7f\u7528\u7684 mutex - \u5fc5\u987b\u786e\u4fdd\u76ee\u6807\u7ebf\u7a0b\u5904\u4e8e\u975e\u8fd0\u884c\u72b6\u6001 - \u4e3b\u8981\u7528\u4e8e\u8fd0\u884c\u65f6\u5185\u90e8\uff0c\u4e0d\u5efa\u8bae\u7528\u6237\u4ee3\u7801\u4f7f\u7528</p>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#trylockwithspinning","title":"TryLockWithSpinning","text":"<p>\u5e26\u81ea\u65cb\u7684\u5c1d\u8bd5\u52a0\u9501\uff1a</p> <pre><code>bool TryLockWithSpinning();\n</code></pre> <p>\u5b9e\u73b0\uff1a\u6700\u591a\u5c1d\u8bd5 10 \u6b21\uff0c\u6bcf\u6b21\u5c1d\u8bd5\u4e4b\u95f4\u8fdb\u884c\u77ed\u6682\u81ea\u65cb\u7b49\u5f85\u3002</p> <p>\u7528\u9014\uff1a\u5728\u9884\u671f\u9501\u5f88\u5feb\u91ca\u653e\u7684\u573a\u666f\u4e0b\uff0c\u907f\u514d\u7acb\u5373\u5931\u8d25\u3002</p>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#_50","title":"\u5e38\u89c1\u95ee\u9898\u548c\u89e3\u51b3\u65b9\u6848","text":""},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#1-vs","title":"1. \u9012\u5f52\u9501 vs \u666e\u901a\u9501","text":"<p>\u95ee\u9898\uff1a\u4f55\u65f6\u4f7f\u7528 RecursiveMutex\uff1f</p> <p>\u7b54\u6848\uff1a - \u9700\u8981\u9012\u5f52\u9501\uff1a\u56de\u8c03\u51fd\u6570\u3001\u865a\u51fd\u6570\u3001\u7b2c\u4e09\u65b9\u5e93\u96c6\u6210 - \u53ef\u4ee5\u4f18\u5316\uff1a\u7b80\u5355\u7c7b\u5185\u90e8\u65b9\u6cd5\uff0c\u901a\u8fc7\u91cd\u6784\u6d88\u9664\u9012\u5f52</p> <p>\u6027\u80fd\u5f71\u54cd\uff1a\u975e\u9012\u5f52\u573a\u666f\u4e0b\u6027\u80fd\u5dee\u5f02 &lt; 5%</p>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#2_1","title":"2. \u6b7b\u9501\u95ee\u9898","text":"<p>\u95ee\u9898\uff1a\u5982\u4f55\u907f\u514d\u6b7b\u9501\uff1f</p> <p>\u89e3\u51b3\u65b9\u6848\uff1a 1. \u4f7f\u7528 <code>ScopedLock</code> \u81ea\u52a8\u907f\u514d\u6b7b\u9501 2. \u56fa\u5b9a\u9501\u7684\u83b7\u53d6\u987a\u5e8f 3. \u6700\u5c0f\u5316\u540c\u65f6\u6301\u6709\u7684\u9501\u6570\u91cf 4. \u4f7f\u7528\u8d85\u65f6\u673a\u5236\uff08<code>TryLock</code>\uff09</p>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#3_2","title":"3. \u6027\u80fd\u4f18\u5316","text":"<p>\u95ee\u9898\uff1a\u5982\u4f55\u63d0\u5347\u9501\u6027\u80fd\uff1f</p> <p>\u5efa\u8bae\uff1a 1. \u51cf\u5c11\u9501\u7ade\u4e89\uff1a\u7f29\u5c0f\u4e34\u754c\u533a 2. \u4f7f\u7528 RWLock\uff1a\u8bfb\u591a\u5199\u5c11\u573a\u666f 3. \u907f\u514d\u4e0d\u5fc5\u8981\u7684\u9012\u5f52\u9501 4. \u4f7f\u7528\u5185\u8054\u51fd\u6570\uff1a\u51cf\u5c11\u8c03\u7528\u5f00\u9500</p>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#4_1","title":"4. \u8c03\u8bd5\u6280\u5de7","text":"<p>\u95ee\u9898\uff1a\u5982\u4f55\u8c03\u8bd5\u9501\u76f8\u5173\u95ee\u9898\uff1f</p> <p>\u5de5\u5177\uff1a 1. \u7ebf\u7a0b\u5b89\u5168\u5206\u6790\uff1a\u542f\u7528 Clang \u7ebf\u7a0b\u5b89\u5168\u6ce8\u89e3 2. \u6b7b\u9501\u68c0\u6d4b\uff1a\u4f7f\u7528 <code>DoNotCheckOnTerminationLoop()</code> \u8c03\u8bd5 3. \u6027\u80fd\u5206\u6790\uff1a\u4f7f\u7528 profiler \u5206\u6790\u9501\u7ade\u4e89</p>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#_51","title":"\u5b9e\u73b0\u7ec6\u8282\u53c2\u8003","text":""},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#_52","title":"\u5173\u952e\u6587\u4ef6","text":"<ul> <li>\u7edf\u4e00\u63a5\u53e3\uff1a<code>libarkbase/os/mutex.h</code> - \u63d0\u4f9b\u7edf\u4e00\u7684\u9501\u63a5\u53e3\u548c RAII \u5305\u88c5\u5668</li> <li>Futex \u5b9e\u73b0\uff1a</li> <li><code>platforms/unix/libarkbase/futex/mutex.h</code> - Mutex/RWLock/ConditionVariable \u7c7b\u5b9a\u4e49</li> <li><code>platforms/unix/libarkbase/futex/fmutex.h</code> - \u5e95\u5c42 fmutex \u7ed3\u6784\u5b9a\u4e49</li> <li><code>platforms/unix/libarkbase/futex/fmutex.cpp</code> - \u6838\u5fc3\u5b9e\u73b0\u903b\u8f91</li> <li><code>platforms/unix/libarkbase/futex/mutex.cpp</code> - \u7c7b\u65b9\u6cd5\u5b9e\u73b0</li> <li>pthread \u5b9e\u73b0\uff1a<code>libarkbase/os/mutex.cpp</code> - \u975e Linux \u5e73\u53f0\u7684 pthread \u5305\u88c5\u5b9e\u73b0</li> </ul>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#_53","title":"\u5173\u952e\u5e38\u91cf","text":"<pre><code>// Futex \u64cd\u4f5c\nstatic constexpr int WAKE_ONE = 1;\nstatic constexpr int WAKE_ALL = INT_MAX;\n\n// \u72b6\u6001\u7f16\u7801\nstatic constexpr int32_t HELD_MASK = 1;           // \u9501\u5b9a\u4f4d\nstatic constexpr int32_t WAITER_SHIFT = 1;        // \u7b49\u5f85\u8005\u8ba1\u6570\u504f\u79fb\nstatic constexpr int32_t WAITER_INCREMENT = 1 &lt;&lt; WAITER_SHIFT;\n\n// RWLock \u72b6\u6001\nstatic constexpr int32_t WRITE_LOCKED = -1;\nstatic constexpr int32_t UNLOCKED = 0;\nstatic constexpr int32_t READ_INCREMENT = 1;\n</code></pre>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#_54","title":"\u7ebf\u7a0b\u672c\u5730\u5b58\u50a8","text":"<pre><code>// \u907f\u514d\u91cd\u590d\u8c03\u7528 GetCurrentThreadId\nthread_local ark::os::thread::ThreadId current_tid {0};\n</code></pre> <p>\u4f18\u5316\u539f\u56e0\uff1a<code>GetCurrentThreadId()</code> \u53ef\u80fd\u6d89\u53ca\u7cfb\u7edf\u8c03\u7528\uff0c\u4f7f\u7528 TLS \u7f13\u5b58\u53ef\u4ee5\u663e\u8457\u63d0\u5347\u6027\u80fd\u3002</p> <p>Fork \u5904\u7406\uff1a<code>PostFork()</code> \u51fd\u6570\u5728 fork \u540e\u66f4\u65b0 TLS\uff0c\u786e\u4fdd\u7ebf\u7a0b ID \u6b63\u786e\u3002</p>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#_55","title":"\u603b\u7ed3","text":"<p>Ark Runtime \u7684\u9501\u5b9e\u73b0\u5177\u6709\u4ee5\u4e0b\u7279\u70b9\uff1a</p> <ol> <li>\u9ad8\u6027\u80fd\uff1a\u57fa\u4e8e futex \u7684\u4f18\u5316\u5b9e\u73b0\uff0c\u5feb\u901f\u8def\u5f84\u4ec5\u9700\u4e00\u6b21 CAS</li> <li>\u5185\u5b58\u9ad8\u6548\uff1a\u7d27\u51d1\u7684\u6570\u636e\u7ed3\u6784\uff0c\u6700\u5c0f\u5316\u5185\u5b58\u5360\u7528</li> <li>\u529f\u80fd\u5b8c\u6574\uff1a\u652f\u6301 Mutex\u3001RecursiveMutex\u3001RWLock\u3001ConditionVariable</li> <li>\u6613\u4e8e\u4f7f\u7528\uff1a\u4e30\u5bcc\u7684 RAII \u5305\u88c5\u5668\u548c\u6b7b\u9501\u907f\u514d\u7b97\u6cd5</li> <li>\u7c7b\u578b\u5b89\u5168\uff1a\u96c6\u6210 Clang \u7ebf\u7a0b\u5b89\u5168\u6ce8\u89e3</li> </ol>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#_56","title":"\u6027\u80fd\u5bf9\u6bd4","text":""},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#_57","title":"\u64cd\u4f5c\u6027\u80fd\u5bf9\u6bd4","text":"\u64cd\u4f5c Mutex RecursiveMutex RWLock (\u8bfb) RWLock (\u5199) \u65e0\u7ade\u4e89\u52a0\u9501 1 CAS (~10ns) 1 CAS + 1 \u68c0\u67e5 (~12ns) 1 CAS (~10ns) 1 CAS (~10ns) \u9012\u5f52\u52a0\u9501 \u6b7b\u9501 2 \u6b21\u5185\u5b58\u64cd\u4f5c (~5ns) N/A N/A \u6709\u7ade\u4e89\u52a0\u9501 \u81ea\u65cb + futex \u81ea\u65cb + futex \u81ea\u65cb + futex \u81ea\u65cb + futex \u89e3\u9501 1 CAS + \u6761\u4ef6\u5524\u9192 1 CAS + \u6761\u4ef6\u5524\u9192 1 CAS + \u6761\u4ef6\u5524\u9192 1 CAS + \u6279\u91cf\u5524\u9192 \u5185\u5b58\u5360\u7528 16 \u5b57\u8282 16 \u5b57\u8282 16 \u5b57\u8282 16 \u5b57\u8282"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#_58","title":"\u573a\u666f\u6027\u80fd\u5bf9\u6bd4","text":"\u573a\u666f Mutex RecursiveMutex RWLock \u63a8\u8350 \u65e0\u7ade\u4e89 1 CAS 1 CAS + \u68c0\u67e5 1 CAS Mutex \u9012\u5f52\u52a0\u9501 \u6b7b\u9501 \u274c \u5feb\u901f\u8def\u5f84 \u2705 N/A RecursiveMutex \u8bfb\u591a\u5199\u5c11 \u4e32\u884c \u4e32\u884c \u5e76\u884c\u8bfb\u53d6 \u2705 RWLock \u5199\u591a\u8bfb\u5c11 \u4e32\u884c \u4e32\u884c \u4e32\u884c Mutex \u9ad8\u7ade\u4e89 \u81ea\u65cb + futex \u81ea\u65cb + futex \u81ea\u65cb + futex \u76f8\u540c"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#_59","title":"\u6027\u80fd\u4f18\u5316\u6548\u679c","text":"<ul> <li>\u5feb\u901f\u8def\u5f84\uff1a\u65e0\u7ade\u4e89\u65f6\u6027\u80fd\u63d0\u5347 10-100 \u500d\uff08\u907f\u514d\u7cfb\u7edf\u8c03\u7528\uff09</li> <li>\u81ea\u65cb\u7b49\u5f85\uff1a\u77ed\u65f6\u95f4\u7b49\u5f85\u6027\u80fd\u63d0\u5347 2-5 \u500d\uff08\u907f\u514d\u4e0a\u4e0b\u6587\u5207\u6362\uff09</li> <li>RWLock\uff1a\u8bfb\u591a\u5199\u5c11\u573a\u666f\u6027\u80fd\u63d0\u5347 N \u500d\uff08N = \u8bfb\u8005\u6570\u91cf\uff09</li> <li>\u5185\u8054\u4f18\u5316\uff1a\u5173\u952e\u8def\u5f84\u6027\u80fd\u63d0\u5347 5-10%\uff08\u51cf\u5c11\u51fd\u6570\u8c03\u7528\u5f00\u9500\uff09</li> </ul>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#_60","title":"\u8bbe\u8ba1\u539f\u5219","text":"<ol> <li>\u6027\u80fd\u4f18\u5148\uff1a\u5feb\u901f\u8def\u5f84\u4f18\u5316\uff0c\u6700\u5c0f\u5316\u7cfb\u7edf\u8c03\u7528</li> <li>\u5b89\u5168\u6027\uff1a\u6b7b\u9501\u907f\u514d\uff0c\u7ebf\u7a0b\u5b89\u5168\u6ce8\u89e3</li> <li>\u6613\u7528\u6027\uff1aRAII \u5305\u88c5\u5668\uff0c\u81ea\u52a8\u8d44\u6e90\u7ba1\u7406</li> <li>\u53ef\u7ef4\u62a4\u6027\uff1a\u6e05\u6670\u7684\u4ee3\u7801\u7ed3\u6784\uff0c\u5b8c\u5584\u7684\u6ce8\u91ca</li> </ol>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#_61","title":"\u9644\u5f55","text":""},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#a","title":"A. \u6027\u80fd\u57fa\u51c6\u6d4b\u8bd5\u5efa\u8bae","text":"<ol> <li>\u65e0\u7ade\u4e89\u573a\u666f\uff1a\u6d4b\u8bd5\u5feb\u901f\u8def\u5f84\u6027\u80fd</li> <li>\u9ad8\u7ade\u4e89\u573a\u666f\uff1a\u6d4b\u8bd5\u81ea\u65cb\u548c futex \u7b49\u5f85\u6027\u80fd</li> <li>\u9012\u5f52\u52a0\u9501\uff1a\u5bf9\u6bd4 RecursiveMutex \u548c Mutex \u7684\u6027\u80fd\u5dee\u5f02</li> <li>\u8bfb\u591a\u5199\u5c11\uff1a\u6d4b\u8bd5 RWLock \u76f8\u6bd4 Mutex \u7684\u6027\u80fd\u63d0\u5347</li> </ol>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#b","title":"B. \u4ee3\u7801\u5ba1\u67e5\u68c0\u67e5\u6e05\u5355","text":"<ul> <li>[ ] \u662f\u5426\u4f7f\u7528\u4e86\u5408\u9002\u7684\u9501\u7c7b\u578b\uff1f</li> <li>[ ] \u662f\u5426\u4f7f\u7528\u4e86 RAII \u5305\u88c5\u5668\uff1f</li> <li>[ ] \u591a\u9501\u573a\u666f\u662f\u5426\u4f7f\u7528\u4e86 ScopedLock\uff1f</li> <li>[ ] \u662f\u5426\u6dfb\u52a0\u4e86\u7ebf\u7a0b\u5b89\u5168\u6ce8\u89e3\uff1f</li> <li>[ ] \u9501\u7c92\u5ea6\u662f\u5426\u8db3\u591f\u5c0f\uff1f</li> <li>[ ] \u662f\u5426\u907f\u514d\u4e86\u4e0d\u5fc5\u8981\u7684\u9012\u5f52\u9501\uff1f</li> </ul>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#c","title":"C. \u5b9e\u9645\u4ee3\u7801\u793a\u4f8b","text":""},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#1_2","title":"\u793a\u4f8b 1\uff1a\u7c7b\u94fe\u63a5\u5668\u4e2d\u7684\u9012\u5f52\u9501\u4f7f\u7528","text":"<pre><code>// runtime/include/class_linker_extension.h\nclass ClassLinkerExtension {\n    RecursiveMutex contextsLock_;\n    PandaVector&lt;ClassLinkerContext *&gt; contexts_ GUARDED_BY(contextsLock_);\n\n    bool EnumerateClasses(Callback cb) {\n        // \u7b2c\u4e00\u6b21\u52a0\u9501\n        {\n            LockHolder lock(contextsLock_);\n            for (auto *ctx : contexts_) {\n                // \u56de\u8c03\u53ef\u80fd\u518d\u6b21\u8c03\u7528 EnumerateClasses\uff0c\u9700\u8981\u9012\u5f52\u9501\n                if (!ctx-&gt;EnumerateClasses(cb)) {\n                    return false;\n                }\n            }\n        }\n        return true;\n    }\n};\n</code></pre>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#2_2","title":"\u793a\u4f8b 2\uff1a\u5185\u5b58\u7ba1\u7406\u4e2d\u7684\u8bfb\u5199\u9501","text":"<pre><code>// runtime/mem/rem_set.h\nclass RemSet {\n    using CommonLock = os::memory::RecursiveMutex;  // \u6216 RWLock\n\n    void AddReference(ObjectHeader *from, ObjectHeader *to) {\n        WriteLockHolder lock(lock_);  // \u5199\u9501\n        // \u6dfb\u52a0\u5f15\u7528\n    }\n\n    void VisitReferences(Visitor visitor) {\n        ReadLockHolder lock(lock_);  // \u8bfb\u9501\uff0c\u5141\u8bb8\u591a\u4e2a\u8bfb\u8005\n        // \u904d\u5386\u5f15\u7528\n    }\n};\n</code></pre>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#3_3","title":"\u793a\u4f8b 3\uff1a\u591a\u9501\u573a\u666f\u7684\u6b7b\u9501\u907f\u514d","text":"<pre><code>void TransferFunds(Account &amp;from, Account &amp;to, int amount) {\n    // \u81ea\u52a8\u6b7b\u9501\u907f\u514d\uff1a\u6309\u5730\u5740\u6392\u5e8f\u52a0\u9501\n    ScopedLock lock(from.mutex_, to.mutex_);\n\n    from.balance_ -= amount;\n    to.balance_ += amount;\n    // \u6790\u6784\u65f6\u81ea\u52a8\u6309\u76f8\u53cd\u987a\u5e8f\u89e3\u9501\n}\n</code></pre>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#4_2","title":"\u793a\u4f8b 4\uff1a\u6761\u4ef6\u53d8\u91cf\u4f7f\u7528","text":"<pre><code>class ProducerConsumer {\n    Mutex mutex_;\n    ConditionVariable cv_;\n    Queue queue_ GUARDED_BY(mutex_);\n\n    void Produce(Item item) {\n        LockHolder lock(mutex_);\n        queue_.push(item);\n        cv_.Signal();  // \u901a\u77e5\u6d88\u8d39\u8005\n    }\n\n    Item Consume() {\n        LockHolder lock(mutex_);\n        while (queue_.empty()) {\n            cv_.Wait(&amp;mutex_);  // \u7b49\u5f85\u6761\u4ef6\n        }\n        Item item = queue_.front();\n        queue_.pop();\n        return item;\n    }\n};\n</code></pre>"},{"location":"arkcompiler/LOCK_IMPLEMENTATION_WIKI/#d","title":"D. \u76f8\u5173\u8d44\u6e90","text":"<ul> <li>Linux Futex \u6587\u6863\uff1a<code>man 2 futex</code></li> <li>Clang \u7ebf\u7a0b\u5b89\u5168\u6ce8\u89e3\uff1ahttps://clang.llvm.org/docs/ThreadSafetyAnalysis.html</li> <li>\u5185\u5b58\u5e8f\u8bed\u4e49\uff1aC++11 \u5185\u5b58\u6a21\u578b</li> <li>Futex \u8bba\u6587\uff1aFutexes Are Tricky (Ulrich Drepper)</li> </ul> <p>\u6587\u6863\u7248\u672c\uff1a1.0 \u6700\u540e\u66f4\u65b0\uff1a2025-01-XX \u7ef4\u62a4\u8005\uff1aArk Runtime Team</p>"},{"location":"arkcompiler/TRACE_COMPLETE_GUIDE/","title":"ARK Runtime Trace \u5b8c\u6574\u6307\u5357","text":"<p>\u672c\u6587\u6863\u6db5\u76d6 Trace \u7cfb\u7edf\u7684\u5b9e\u73b0\u539f\u7406\u3001\u4f7f\u7528\u65b9\u6cd5\u3001\u53ef\u89c6\u5316\u5de5\u5177\u548c\u9ad8\u7ea7\u6280\u5de7</p>"},{"location":"arkcompiler/TRACE_COMPLETE_GUIDE/#1-trace","title":"1. Trace \u7cfb\u7edf\u67b6\u6784","text":""},{"location":"arkcompiler/TRACE_COMPLETE_GUIDE/#11","title":"1.1 \u4e09\u5c42\u67b6\u6784","text":"<p>ARK \u7684 Trace \u7cfb\u7edf\u91c7\u7528\u4e09\u5c42\u67b6\u6784\uff1a</p> <pre><code>graph TD\n    A[\"\u5e94\u7528\u5c42: ark::Tracer&lt;br&gt;Tracer::Start('name')&lt;br&gt;Tracer::Finish()\"]\n    B[\"C\u63a5\u53e3\u5c42: StartTrace/FinishTrace&lt;br&gt;(\u6761\u4ef6\u7f16\u8bd1: HiTrace \u6216 ftrace)\"]\n    C[\"\u5b9e\u73b0\u5c42: ark::trace&lt;br&gt;BeginTracePoint/EndTracePoint&lt;br&gt;\u2192 /sys/kernel/debug/tracing/\"]\n\n    A --&gt; B\n    B --&gt; C</code></pre>"},{"location":"arkcompiler/TRACE_COMPLETE_GUIDE/#12","title":"1.2 \u6838\u5fc3\u6587\u4ef6","text":"\u6587\u4ef6 \u4f5c\u7528 <code>runtime/trace.h</code> Tracer \u7c7b\u5b9a\u4e49\uff0c\u6761\u4ef6\u7f16\u8bd1\u9009\u62e9\u5b9e\u73b0 <code>libarkbase/trace/trace.h</code> ark::trace \u547d\u540d\u7a7a\u95f4 API <code>platforms/unix/libarkbase/trace.cpp</code> ftrace \u5b9e\u73b0\uff08Linux\uff09"},{"location":"arkcompiler/TRACE_COMPLETE_GUIDE/#13","title":"1.3 \u5173\u952e\u5b9e\u73b0\u7ec6\u8282","text":""},{"location":"arkcompiler/TRACE_COMPLETE_GUIDE/#tracer-runtimetraceh","title":"Tracer \u7c7b\uff08runtime/trace.h\uff09","text":"<pre><code>namespace ark {\nclass Tracer {\npublic:\n    static void Start(const std::string &amp;name, float limit = -1) {\n        StartTrace(TRACER_TAG, name, limit);\n    }\n\n    static void Finish() {\n        FinishTrace(TRACER_TAG);\n    }\n\n    static void Count(const std::string &amp;name, int64_t count) {\n        CountTrace(TRACER_TAG, name, count);\n    }\n};\n}\n</code></pre>"},{"location":"arkcompiler/TRACE_COMPLETE_GUIDE/#_1","title":"\u6761\u4ef6\u7f16\u8bd1\u903b\u8f91","text":"<p>\u5f53\u672a\u5b9a\u4e49 <code>PANDA_USE_HITRACE</code> \u65f6\uff08Linux \u9ed8\u8ba4\uff09\uff1a</p> <pre><code>// runtime/trace.h\n#include \"libarkbase/trace/trace.h\"\n\ninline void StartTrace(uint64_t tag, const std::string &amp;name, float limit = -1) {\n    ark::trace::BeginTracePoint(name.c_str());  // \u8c03\u7528 ftrace\n}\n\ninline void FinishTrace(uint64_t tag) {\n    ark::trace::EndTracePoint();  // \u8c03\u7528 ftrace\n}\n</code></pre> <p>\u5f53\u5b9a\u4e49 <code>PANDA_USE_HITRACE</code> \u65f6\uff08HarmonyOS\uff09\uff1a</p> <pre><code>#include \"hitrace_meter/hitrace_meter.h\"\n// \u4f7f\u7528 HiTrace API\n</code></pre>"},{"location":"arkcompiler/TRACE_COMPLETE_GUIDE/#ftrace-platformsunixlibarkbasetracecpp","title":"ftrace \u5b9e\u73b0\uff08platforms/unix/libarkbase/trace.cpp\uff09","text":"<pre><code>// \u521d\u59cb\u5316\uff1a\u68c0\u67e5\u73af\u5883\u53d8\u91cf\nbool DoInit() {\n    const char *pandaTraceVal = std::getenv(\"PANDA_TRACE\");\n    if (pandaTraceVal == nullptr || strcmp(pandaTraceVal, \"1\") != 0) {\n        return false;\n    }\n\n    g_traceMarkerFd = open(\"/sys/kernel/debug/tracing/trace_marker\", O_WRONLY);\n    return g_traceMarkerFd != -1;\n}\n\n// \u5199\u5165 trace \u70b9\nvoid DoBeginTracePoint(const char *str) {\n    dprintf(g_traceMarkerFd, \"B|%d|%s\", getpid(), str);\n}\n\nvoid DoEndTracePoint() {\n    dprintf(g_traceMarkerFd, \"E|\");\n}\n</code></pre>"},{"location":"arkcompiler/TRACE_COMPLETE_GUIDE/#14-trace","title":"1.4 Trace \u683c\u5f0f","text":"<p>ftrace \u4f7f\u7528\u6807\u51c6\u683c\u5f0f\uff1a</p> <ul> <li>Begin: <code>B|&lt;pid&gt;|&lt;name&gt;</code> - \u5f00\u59cb\u4e00\u4e2a trace \u70b9</li> <li>End: <code>E|</code> - \u7ed3\u675f\u5f53\u524d trace \u70b9\uff08LIFO \u6808\u7ed3\u6784\uff09</li> <li>Counter: <code>C|&lt;pid&gt;|&lt;name&gt;|&lt;value&gt;</code> - \u8ba1\u6570\u5668\u7c7b\u578b</li> </ul> <p>\u5173\u952e\u7279\u6027\uff1a - \u2705 \u652f\u6301\u5d4c\u5957\uff1aftrace \u4f7f\u7528\u6808\u7ed3\u6784\uff0c\u5b8c\u5168\u652f\u6301\u5d4c\u5957\u7684 Begin/End \u5bf9 - \u2705 \u7ebf\u7a0b\u5b89\u5168\uff1a\u6bcf\u4e2a\u8fdb\u7a0b\u72ec\u7acb\uff0c\u901a\u8fc7 PID \u533a\u5206 - \u2705 \u9ad8\u6027\u80fd\uff1a\u5199\u5165\u5185\u5b58 ring buffer\uff0c\u7eb3\u79d2\u7ea7\u5ef6\u8fdf</p>"},{"location":"arkcompiler/TRACE_COMPLETE_GUIDE/#15-trace","title":"1.5 \u5d4c\u5957 Trace \u793a\u4f8b","text":"<pre><code>void MyFunction() {\n    Tracer::Start(\"MyFunction\");        // Begin \"MyFunction\"\n\n    Tracer::Start(\"Step1\");            // Begin \"Step1\"\n    DoStep1();\n    Tracer::Finish();                  // End \"Step1\"\n\n    Tracer::Start(\"Step2\");            // Begin \"Step2\"\n    DoStep2();\n    Tracer::Finish();                  // End \"Step2\"\n\n    Tracer::Finish();                  // End \"MyFunction\"\n}\n</code></pre> <p>\u8f93\u51fa\u5230 ftrace\uff1a <pre><code>B|1234|MyFunction\nB|1234|Step1\nE|\nB|1234|Step2\nE|\nE|\n</code></pre></p> <p>\u53ef\u89c6\u5316\u6548\u679c\uff08Perfetto\uff09\uff1a <pre><code>MyFunction \u2503 \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\n  Step1    \u2503    \u2588\u2588\u2588\u2588\n  Step2    \u2503        \u2588\u2588\u2588\u2588\u2588\u2588\n</code></pre></p>"},{"location":"arkcompiler/TRACE_COMPLETE_GUIDE/#2-linux-trace","title":"2. \u5728 Linux \u4e0a\u6293\u53d6 Trace","text":""},{"location":"arkcompiler/TRACE_COMPLETE_GUIDE/#21","title":"2.1 \u524d\u7f6e\u6761\u4ef6","text":"<ol> <li>WSL2/Linux \u73af\u5883</li> <li>Root \u6743\u9650\uff08\u8bbf\u95ee <code>/sys/kernel/debug/tracing</code>\uff09</li> <li>ftrace \u5df2\u542f\u7528\uff08WSL2 \u9ed8\u8ba4\u542f\u7528\uff09</li> </ol>"},{"location":"arkcompiler/TRACE_COMPLETE_GUIDE/#22","title":"2.2 \u5b8c\u6574\u6d41\u7a0b","text":""},{"location":"arkcompiler/TRACE_COMPLETE_GUIDE/#1-ftrace-1","title":"\u6b65\u9aa41\uff1a\u542f\u52a8 ftrace \u6536\u96c6\uff08\u7ec8\u7aef1\uff09","text":"<pre><code># \u4f7f\u7528\u63d0\u4f9b\u7684\u811a\u672c\uff08WSL2 \u517c\u5bb9\uff09\nsudo /path/to/scripts/trace_enable_wsl2.sh output.trace 60 8192\n\n# \u53c2\u6570\u8bf4\u660e\uff1a\n#   output.trace - \u8f93\u51fa\u6587\u4ef6\u540d\n#   60 - \u8ddf\u8e2a\u65f6\u957f\uff08\u79d2\uff09\uff0c\u53ef\u968f\u65f6 Ctrl+C \u63d0\u524d\u7ed3\u675f\n#   8192 - \u7f13\u51b2\u533a\u5927\u5c0f\uff08KB\uff09\uff0c\u9ed8\u8ba4 8MB\n</code></pre>"},{"location":"arkcompiler/TRACE_COMPLETE_GUIDE/#22_1","title":"\u6b65\u9aa42\uff1a\u8fd0\u884c\u7a0b\u5e8f\uff08\u7ec8\u7aef2\uff09","text":"<pre><code># \u5173\u952e\uff1a\u5fc5\u987b\u8bbe\u7f6e\u73af\u5883\u53d8\u91cf PANDA_TRACE=1\nPANDA_TRACE=1 sudo -E ./your_program\n\n# \u6ce8\u610f\uff1a\n# - \u4f7f\u7528 sudo -E \u4fdd\u7559\u73af\u5883\u53d8\u91cf\n# - \u6216\u8005\u76f4\u63a5\u5728 root shell \u4e2d\uff1a\nsudo su\nexport PANDA_TRACE=1\n./your_program\n</code></pre>"},{"location":"arkcompiler/TRACE_COMPLETE_GUIDE/#3","title":"\u6b65\u9aa43\uff1a\u67e5\u770b\u7ed3\u679c","text":"<p>\u65b9\u6cd51\uff1aPerfetto UI\uff08\u63a8\u8350\uff09 1. \u8bbf\u95ee\uff1ahttps://ui.perfetto.dev/ 2. \u70b9\u51fb \"Open trace file\" 3. \u9009\u62e9 <code>output.trace</code> 4. \u67e5\u770b\u53ef\u89c6\u5316\u65f6\u95f4\u7ebf</p> <p>\u65b9\u6cd52\uff1aChrome Tracing 1. \u8f6c\u6362\u683c\u5f0f\uff08\u5982\u9700\u8981\uff09\uff1a    <pre><code>python3 ftrace_to_json.py output.trace output.json\n</code></pre> 2. \u6253\u5f00 <code>chrome://tracing</code> 3. \u52a0\u8f7d <code>output.json</code></p>"},{"location":"arkcompiler/TRACE_COMPLETE_GUIDE/#23-wsl2","title":"2.3 WSL2 \u7279\u6b8a\u8bf4\u660e","text":"<p>\u5728 WSL2 \u4e2d\uff0c<code>/sys/kernel/debug/tracing</code> \u76ee\u5f55\u6743\u9650\u65e0\u6cd5\u901a\u8fc7 <code>chmod</code> \u4fee\u6539\uff0c\u4f46\uff1a - \u2705 \u4ee5 root \u8eab\u4efd\u53ef\u4ee5\u76f4\u63a5\u8bbf\u95ee - \u2705 <code>trace_marker</code> \u6587\u4ef6\u672c\u8eab\u662f\u53ef\u5199\u7684 - \u2705 \u4f7f\u7528\u63d0\u4f9b\u7684 <code>trace_enable_wsl2.sh</code> \u811a\u672c\uff08\u8df3\u8fc7\u6743\u9650\u8bbe\u7f6e\uff09</p>"},{"location":"arkcompiler/TRACE_COMPLETE_GUIDE/#24-trace","title":"2.4 \u9a8c\u8bc1 Trace \u662f\u5426\u751f\u6548","text":"<pre><code># \u68c0\u67e5 trace \u6587\u4ef6\u4e2d\u662f\u5426\u6709\u60a8\u7684\u6807\u8bb0\ngrep \"fzw::GetClass\" output.trace\n\n# \u68c0\u67e5\u662f\u5426\u6709 trace_marker \u5199\u5165\ngrep \"tracing_mark_write\" output.trace\n\n# \u5982\u679c\u90fd\u6ca1\u6709\uff0c\u68c0\u67e5\uff1a\n# 1. \u662f\u5426\u8bbe\u7f6e\u4e86 PANDA_TRACE=1\n# 2. \u7a0b\u5e8f\u662f\u5426\u771f\u7684\u8c03\u7528\u4e86 Tracer::Start/Finish\n# 3. \u662f\u5426\u6709 root \u6743\u9650\n</code></pre>"},{"location":"arkcompiler/TRACE_COMPLETE_GUIDE/#3-perf-vs-trace","title":"3. Perf vs Trace \u539f\u7406\u5bf9\u6bd4","text":""},{"location":"arkcompiler/TRACE_COMPLETE_GUIDE/#31-perf","title":"3.1 Perf\uff08\u91c7\u6837\uff09","text":""},{"location":"arkcompiler/TRACE_COMPLETE_GUIDE/#_2","title":"\u539f\u7406","text":"<pre><code>\u65f6\u95f4\u8f74 \u2192\n\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\n     \u2193      \u2193      \u2193      \u2193      \u2193\n   \u91c7\u68371   \u91c7\u68372   \u91c7\u68373   \u91c7\u68374   \u91c7\u68375\n\n\u6bcf\u6b21\u91c7\u6837\u65f6\uff1a\n1. \u5185\u6838\u6536\u5230\u65f6\u949f\u4e2d\u65ad\uff08timer interrupt\uff09\n2. \u8bfb\u53d6 CPU \u5bc4\u5b58\u5668\uff08RIP/EIP - \u6307\u4ee4\u6307\u9488\uff09\n3. \u904d\u5386\u6808\u5e27\uff08stack unwinding\uff09\n4. \u8bb0\u5f55\u5b8c\u6574\u8c03\u7528\u6808\n</code></pre>"},{"location":"arkcompiler/TRACE_COMPLETE_GUIDE/#_3","title":"\u6570\u636e\u6765\u6e90","text":"<ul> <li>\u5bc4\u5b58\u5668\uff1aRIP/EIP\uff08\u5f53\u524d\u6267\u884c\u4f4d\u7f6e\uff09\u3001RSP/ESP\uff08\u6808\u6307\u9488\uff09</li> <li>\u6808\u5185\u5b58\uff1a\u8fd4\u56de\u5730\u5740\u94fe</li> <li>\u7b26\u53f7\u8868\uff1a\u5c06\u5730\u5740\u8f6c\u6362\u4e3a\u51fd\u6570\u540d</li> <li>\u6027\u80fd\u8ba1\u6570\u5668\uff08PMU\uff09\uff1aCPU cycles\u3001cache miss \u7b49</li> </ul>"},{"location":"arkcompiler/TRACE_COMPLETE_GUIDE/#_4","title":"\u7279\u70b9","text":"\u7279\u6027 \u8bf4\u660e \u7c7b\u578b \u88ab\u52a8\u91c7\u6837\uff08\u57fa\u4e8e\u4e2d\u65ad\uff09 \u7cbe\u786e\u5ea6 \u7edf\u8ba1\u6027\u8d28\uff08\u6982\u7387\uff09 \u5f00\u9500 \u4f4e\uff081-3% CPU\uff09 \u65f6\u5e8f \u65e0\uff08\u53ea\u6709\u91c7\u6837\u70b9\uff09 \u56e0\u679c\u5173\u7cfb \u4e0d\u6e05\u695a \u77ed\u51fd\u6570 \u53ef\u80fd\u4e22\u5931 \u4fb5\u5165\u6027 \u65e0\u9700\u6539\u4ee3\u7801 \u9002\u7528\u573a\u666f \u627e\u70ed\u70b9\u3001CPU \u5206\u6790"},{"location":"arkcompiler/TRACE_COMPLETE_GUIDE/#32-trace","title":"3.2 Trace\uff08\u63d2\u6869\uff09","text":""},{"location":"arkcompiler/TRACE_COMPLETE_GUIDE/#_5","title":"\u539f\u7406","text":"<pre><code>// \u5e94\u7528\u5c42\u5199\u5165\nwrite(fd, \"B|1234|FunctionName\", ...);\n\n// \u5185\u6838\u5c42\u5904\u7406\n1. \u63a5\u6536\u5199\u5165\u8bf7\u6c42\n2. \u4e0d\u843d\u76d8\uff0c\u76f4\u63a5\u5199\u5165 ring buffer\uff08\u5185\u5b58\u4e2d\uff09\n3. Ring buffer \u662f\u65e0\u9501\u7684 per-CPU \u7f13\u51b2\u533a\n4. \u6781\u4f4e\u5f00\u9500\uff08\u7eb3\u79d2\u7ea7\uff09\n</code></pre>"},{"location":"arkcompiler/TRACE_COMPLETE_GUIDE/#ring-buffer","title":"Ring Buffer \u7ed3\u6784","text":"<pre><code>Per-CPU Ring Buffers\uff08\u6bcf\u4e2aCPU\u4e00\u4e2a\uff0c\u907f\u514d\u7ade\u4e89\uff09:\n\nCPU0: [Event1][Event2][Event3]... \u2192 \u5faa\u73af\u8986\u76d6\nCPU1: [Event1][Event2][Event3]... \u2192 \u5faa\u73af\u8986\u76d6\nCPU2: [Event1][Event2][Event3]... \u2192 \u5faa\u73af\u8986\u76d6\n...\n\n\u7279\u70b9\uff1a\n- \u65e0\u9501\uff08lock-free\uff09\n- \u5185\u5b58\u9884\u5206\u914d\n- \u5faa\u73af\u8986\u76d6\uff08\u53ef\u914d\u7f6e\u4e0d\u8986\u76d6\uff09\n- \u6bcf\u4e2a CPU \u72ec\u7acb\uff0c\u65e0\u7ade\u4e89\n</code></pre>"},{"location":"arkcompiler/TRACE_COMPLETE_GUIDE/#_6","title":"\u6027\u80fd\u5bf9\u6bd4","text":"\u64cd\u4f5c \u5ef6\u8fdf \u666e\u901a <code>printf</code> ~1-10 \u00b5s\uff08\u5fae\u79d2\uff09 \u6587\u4ef6 <code>write</code> ~1-5 \u00b5s ftrace marker ~50-200 ns\uff08\u7eb3\u79d2\uff09 \u5dee\u8ddd \u5feb 10-100 \u500d\uff01"},{"location":"arkcompiler/TRACE_COMPLETE_GUIDE/#_7","title":"\u7279\u70b9","text":"\u7279\u6027 \u8bf4\u660e \u7c7b\u578b \u4e3b\u52a8\u8bb0\u5f55\uff08\u51fd\u6570\u8c03\u7528\u65f6\uff09 \u7cbe\u786e\u5ea6 \u7cbe\u786e\uff08\u6bcf\u6b21\u8c03\u7528\uff09 \u5f00\u9500 \u4e2d\uff085-20%\uff0c\u53d6\u51b3\u4e8e\u9891\u7387\uff09 \u65f6\u5e8f \u5b8c\u6574\uff08\u7cbe\u786e\u987a\u5e8f\uff09 \u56e0\u679c\u5173\u7cfb \u6e05\u695a\uff08\u5d4c\u5957\u5173\u7cfb\uff09 \u77ed\u51fd\u6570 \u4e0d\u4f1a\u4e22\u5931 \u4fb5\u5165\u6027 \u9700\u8981\u63d2\u6869 \u9002\u7528\u573a\u666f \u627e\u987a\u5e8f\u3001\u5ef6\u8fdf\u5206\u6790"},{"location":"arkcompiler/TRACE_COMPLETE_GUIDE/#33","title":"3.3 \u5bf9\u6bd4\u603b\u7ed3","text":"\u7ef4\u5ea6 Perf\uff08\u91c7\u6837\uff09 Trace\uff08\u63d2\u6869\uff09 \u539f\u7406 \u88ab\u52a8\u91c7\u6837 \u4e3b\u52a8\u8bb0\u5f55 \u7cbe\u786e\u5ea6 \u7edf\u8ba1\uff08\u6982\u7387\uff09 \u7cbe\u786e\uff08\u6bcf\u6b21\uff09 \u5f00\u9500 \u4f4e\uff081-3%\uff09 \u4e2d\uff085-20%\uff09 \u65f6\u5e8f \u65e0 \u5b8c\u6574 \u56e0\u679c\u5173\u7cfb \u4e0d\u6e05\u695a \u6e05\u695a \u77ed\u51fd\u6570 \u53ef\u80fd\u4e22\u5931 \u4e0d\u4f1a\u4e22\u5931 \u4fb5\u5165\u6027 \u65e0\u9700\u6539\u4ee3\u7801 \u9700\u8981\u63d2\u6869 \u9002\u7528\u573a\u666f \u627e\u70ed\u70b9\u3001CPU\u5206\u6790 \u627e\u987a\u5e8f\u3001\u5ef6\u8fdf\u5206\u6790 \u6570\u636e\u91cf \u5c0f \u5927"},{"location":"arkcompiler/TRACE_COMPLETE_GUIDE/#34","title":"3.4 \u6700\u4f73\u5b9e\u8df5\uff1a\u7ec4\u5408\u4f7f\u7528","text":"<pre><code># \u7b2c\u4e00\u6b65\uff1a\u7528 Perf \u627e\u70ed\u70b9\nperf record -g ./your_program\nperf report --stdio\n# \u53d1\u73b0\uff1aGetClass() \u5360\u7528 40% CPU\n\n# \u7b2c\u4e8c\u6b65\uff1a\u7528 Trace \u770b\u7ec6\u8282\n# \u5728 GetClass() \u4e2d\u52a0 trace \u70b9\nTracer::Start(\"GetClass\");\n  Tracer::Start(\"LoadFromCache\");\n  Tracer::Finish();\n  Tracer::Start(\"LoadFromDisk\");\n  Tracer::Finish();\nTracer::Finish();\n\n# \u53d1\u73b0\uff1aLoadFromDisk \u5f88\u6162\uff0c\u9700\u8981\u4f18\u5316\n</code></pre>"},{"location":"arkcompiler/TRACE_COMPLETE_GUIDE/#4","title":"4. \u81ea\u52a8\u63d2\u6869\u65b9\u6848","text":""},{"location":"arkcompiler/TRACE_COMPLETE_GUIDE/#41","title":"4.1 \u9700\u6c42\u573a\u666f","text":"<ul> <li>\u2705 \u5b66\u4e60\u4ee3\u7801\u65f6\uff0c\u60f3\u5b8c\u6574\u770b\u5230\u6267\u884c\u8fc7\u7a0b</li> <li>\u2705 \u4e0d\u60f3\u624b\u52a8\u5728\u6bcf\u4e2a\u51fd\u6570\u52a0 Trace Start/Finish</li> <li>\u2705 \u5e0c\u671b\u81ea\u52a8\u63d2\u6869\u6240\u6709\u51fd\u6570</li> <li>\u2705 \u51fd\u6570\u540d\u81ea\u52a8\u4f5c\u4e3a trace \u540d\u79f0</li> <li>\u2705 \u53ef\u9009\u5730\u5728\u67d0\u4e9b\u51fd\u6570\u9644\u52a0\u66f4\u591a\u4fe1\u606f\uff08\u53c2\u6570\u3001\u68c0\u67e5\u70b9\uff09</li> </ul>"},{"location":"arkcompiler/TRACE_COMPLETE_GUIDE/#42-gccclang-finstrument-functions","title":"4.2 \u89e3\u51b3\u65b9\u6848\uff1aGCC/Clang <code>-finstrument-functions</code>","text":""},{"location":"arkcompiler/TRACE_COMPLETE_GUIDE/#_8","title":"\u539f\u7406","text":"<p>\u7f16\u8bd1\u5668\u4f1a\u5728\u6bcf\u4e2a\u51fd\u6570\u7684\u5f00\u5934\u548c\u7ed3\u5c3e\u81ea\u52a8\u63d2\u5165\u5bf9\u94a9\u5b50\u51fd\u6570\u7684\u8c03\u7528\uff1a</p> <pre><code>// \u6e90\u4ee3\u7801\nvoid my_function(int x) {\n    printf(\"x = %d\\n\", x);\n}\n\n// \u7f16\u8bd1\u5668\u81ea\u52a8\u8f6c\u6362\u4e3a\uff08\u6982\u5ff5\u4e0a\uff09\nvoid my_function(int x) {\n    __cyg_profile_func_enter(my_function_addr, caller_addr);\n    printf(\"x = %d\\n\", x);\n    __cyg_profile_func_exit(my_function_addr, caller_addr);\n}\n</code></pre>"},{"location":"arkcompiler/TRACE_COMPLETE_GUIDE/#_9","title":"\u5b9e\u73b0\u94a9\u5b50\u51fd\u6570","text":"<pre><code>extern \"C\" {\n    // \u51fd\u6570\u8fdb\u5165\u94a9\u5b50\n    void __cyg_profile_func_enter(void *this_fn, void *call_site) {\n        const char* func_name = GetFunctionName(this_fn);\n        WriteTrace(\"B|%d|%s\", getpid(), func_name);\n    }\n\n    // \u51fd\u6570\u9000\u51fa\u94a9\u5b50\n    void __cyg_profile_func_exit(void *this_fn, void *call_site) {\n        WriteTrace(\"E|\");\n    }\n}\n</code></pre>"},{"location":"arkcompiler/TRACE_COMPLETE_GUIDE/#_10","title":"\u7f16\u8bd1\u9009\u9879","text":"<pre><code># \u57fa\u672c\u7528\u6cd5\ng++ -finstrument-functions your_code.cpp\n\n# \u9700\u8981\u7b26\u53f7\u89e3\u6790\uff08\u83b7\u53d6\u51fd\u6570\u540d\uff09\ng++ -finstrument-functions -rdynamic -ldl your_code.cpp\n\n# \u6392\u9664\u67d0\u4e9b\u51fd\u6570\uff08\u907f\u514d\u9012\u5f52\uff09\ng++ -finstrument-functions \\\n    -finstrument-functions-exclude-file-list=trace.cpp \\\n    -finstrument-functions-exclude-function-list=__cyg_profile_func_enter\n</code></pre>"},{"location":"arkcompiler/TRACE_COMPLETE_GUIDE/#_11","title":"\u63a7\u5236\u7c92\u5ea6","text":"<pre><code>// \u6392\u9664\u7279\u5b9a\u51fd\u6570\nvoid my_hot_function() __attribute__((no_instrument_function));\n\n// \u6392\u9664\u7279\u5b9a\u6587\u4ef6\n#pragma GCC optimize(\"no-instrument-functions\")\n</code></pre>"},{"location":"arkcompiler/TRACE_COMPLETE_GUIDE/#43","title":"4.3 \u589e\u5f3a\u529f\u80fd\uff1a\u8bb0\u5f55\u53c2\u6570\u548c\u68c0\u67e5\u70b9","text":"<pre><code>// \u63d0\u4f9b\u5b8f\u7528\u4e8e\u8bb0\u5f55\u989d\u5916\u4fe1\u606f\n#define TRACE_ARGS(fmt, ...) \\\n    do { \\\n        char buf[512]; \\\n        snprintf(buf, sizeof(buf), fmt, ##__VA_ARGS__); \\\n        TraceHelper::LogArgs(__func__, buf); \\\n    } while(0)\n\n#define TRACE_CHECKPOINT(msg) \\\n    TraceHelper::LogCheckpoint(__func__, msg)\n\n// \u4f7f\u7528\u793a\u4f8b\nvoid ClassLinker::GetClass(const File&amp; pf, EntityId id) {\n    // \u51fd\u6570\u5165\u53e3/\u9000\u51fa\u7531\u7f16\u8bd1\u5668\u81ea\u52a8\u5904\u7406\n\n    // \u8bb0\u5f55\u5173\u952e\u53c2\u6570\uff08\u53ef\u9009\uff09\n    TRACE_ARGS(\"file=%s, id=%x\", pf.GetFilename(), id.GetOffset());\n\n    Class *cls = pf.GetCache()-&gt;GetClass(id);\n    if (cls != nullptr) {\n        TRACE_CHECKPOINT(\"cache hit\");  // \u53ef\u9009\uff1a\u8bb0\u5f55\u68c0\u67e5\u70b9\n        return cls;\n    }\n\n    TRACE_CHECKPOINT(\"cache miss\");\n    cls = LoadClass(...);\n    return cls;\n}\n</code></pre>"},{"location":"arkcompiler/TRACE_COMPLETE_GUIDE/#44-ark","title":"4.4 \u96c6\u6210\u5230 ARK \u9879\u76ee","text":""},{"location":"arkcompiler/TRACE_COMPLETE_GUIDE/#cmakeliststxt","title":"CMakeLists.txt \u914d\u7f6e","text":"<pre><code># \u6dfb\u52a0\u81ea\u52a8\u63d2\u6869\u9009\u9879\noption(ENABLE_AUTO_TRACE \"Enable automatic function tracing\" OFF)\n\nif(ENABLE_AUTO_TRACE)\n    # \u6dfb\u52a0\u7f16\u8bd1\u9009\u9879\n    add_compile_options(-finstrument-functions)\n\n    # \u6392\u9664 trace \u7cfb\u7edf\u672c\u8eab\n    set_source_files_properties(\n        libarkbase/trace/auto_trace.cpp\n        libarkbase/trace/trace.cpp\n        PROPERTIES COMPILE_FLAGS \"-fno-instrument-functions\"\n    )\n\n    # \u6dfb\u52a0\u94fe\u63a5\u9009\u9879\n    add_link_options(-rdynamic -ldl)\n\n    # \u5b9a\u4e49\u5b8f\n    add_definitions(-DENABLE_AUTO_TRACE)\nendif()\n</code></pre>"},{"location":"arkcompiler/TRACE_COMPLETE_GUIDE/#_12","title":"\u7f16\u8bd1\u548c\u8fd0\u884c","text":"<pre><code># \u7f16\u8bd1\uff08\u542f\u7528\u81ea\u52a8\u63d2\u6869\uff09\ncmake -DENABLE_AUTO_TRACE=ON build\ncmake --build build\n\n# \u8fd0\u884c\uff08\u542f\u7528 trace\uff09\nPANDA_TRACE=1 sudo -E ./build/bin/ark your_program.abc\n</code></pre>"},{"location":"arkcompiler/TRACE_COMPLETE_GUIDE/#45","title":"4.5 \u914d\u7f6e\u9009\u9879","text":"\u73af\u5883\u53d8\u91cf \u8bf4\u660e \u9ed8\u8ba4\u503c \u793a\u4f8b <code>PANDA_TRACE</code> \u542f\u7528 trace - <code>PANDA_TRACE=1</code> <code>TRACE_MAX_DEPTH</code> \u6700\u5927\u8ffd\u8e2a\u6df1\u5ea6 20 <code>TRACE_MAX_DEPTH=10</code> <code>TRACE_WHITELIST</code> \u767d\u540d\u5355\uff08\u53ea\u8ffd\u8e2a\u5339\u914d\u7684\uff09 - <code>TRACE_WHITELIST=ClassLinker,LoadClass</code> <code>TRACE_BLACKLIST</code> \u9ed1\u540d\u5355\uff08\u4e0d\u8ffd\u8e2a\u5339\u914d\u7684\uff09 - <code>TRACE_BLACKLIST=mutex,lock</code>"},{"location":"arkcompiler/TRACE_COMPLETE_GUIDE/#46","title":"4.6 \u4f18\u7f3a\u70b9\u5bf9\u6bd4","text":"\u65b9\u9762 \u624b\u52a8\u63d2\u6869 \u81ea\u52a8\u63d2\u6869 \u4ee3\u7801\u6539\u52a8 \u6bcf\u4e2a\u51fd\u6570\u90fd\u8981\u52a0 \u96f6\u6539\u52a8 \u8986\u76d6\u7387 \u5bb9\u6613\u9057\u6f0f 100% \u8986\u76d6 \u7ef4\u62a4\u6210\u672c \u9ad8 \u96f6\u7ef4\u62a4 \u7075\u6d3b\u6027 \u53ef\u4ee5\u7cbe\u786e\u63a7\u5236 \u901a\u8fc7\u767d\u540d\u5355\u63a7\u5236 \u53c2\u6570\u8bb0\u5f55 \u5bb9\u6613 \u9700\u8981\u5b8f\u8f85\u52a9 \u6027\u80fd\u5f00\u9500 \u53ef\u63a7\uff08\u53ea\u63d2\u9700\u8981\u7684\uff09 \u8f83\u5927\uff08\u4f46\u53ef\u8fc7\u6ee4\uff09"},{"location":"arkcompiler/TRACE_COMPLETE_GUIDE/#5-trace","title":"5. Trace \u53ef\u89c6\u5316","text":""},{"location":"arkcompiler/TRACE_COMPLETE_GUIDE/#51-perfetto-ui","title":"5.1 Perfetto UI\uff08\u63a8\u8350\uff09\u2b50\u2b50\u2b50","text":"<p>\u8bbf\u95ee\u5730\u5740\uff1ahttps://ui.perfetto.dev/</p> <p>\u4f18\u52bf\uff1a - \u2705 \u76f4\u63a5\u652f\u6301 ftrace \u683c\u5f0f\uff08\u65e0\u9700\u8f6c\u6362\uff09 - \u2705 \u73b0\u4ee3\u5316 UI \u754c\u9762 - \u2705 \u5f3a\u5927\u7684\u5206\u6790\u529f\u80fd - \u2705 SQL \u67e5\u8be2\u652f\u6301 - \u2705 \u66f4\u597d\u7684\u5927\u6587\u4ef6\u5904\u7406\u80fd\u529b</p> <p>\u4f7f\u7528\u65b9\u6cd5\uff1a 1. \u8bbf\u95ee https://ui.perfetto.dev/ 2. \u70b9\u51fb \"Open trace file\" 3. \u9009\u62e9\u60a8\u7684 trace \u6587\u4ef6 4. \u67e5\u770b\u53ef\u89c6\u5316\u65f6\u95f4\u7ebf</p>"},{"location":"arkcompiler/TRACE_COMPLETE_GUIDE/#52-chrome-tracing","title":"5.2 Chrome Tracing","text":"<p>\u8bbf\u95ee\u5730\u5740\uff1a<code>chrome://tracing</code></p> <p>\u4f7f\u7528\u65b9\u6cd5\uff1a 1. \u8f6c\u6362\u683c\u5f0f\uff08\u5982\u9700\u8981\uff09\uff1a    <pre><code>python3 ftrace_to_json.py output.trace output.json\n</code></pre> 2. \u6253\u5f00 Chrome \u6d4f\u89c8\u5668 3. \u5730\u5740\u680f\u8f93\u5165\uff1a<code>chrome://tracing</code> 4. \u70b9\u51fb \"Load\" \u6309\u94ae 5. \u9009\u62e9 <code>output.json</code></p> <p>\u5feb\u6377\u952e\uff1a - <code>W/A/S/D</code> - \u5e73\u79fb\u548c\u7f29\u653e - <code>1/2/3/4</code> - \u9009\u62e9\u5de5\u5177 - <code>/</code> - \u641c\u7d22\u4e8b\u4ef6 - <code>?</code> - \u663e\u793a\u5e2e\u52a9</p>"},{"location":"arkcompiler/TRACE_COMPLETE_GUIDE/#53","title":"5.3 \u53ef\u89c6\u5316\u6548\u679c\u793a\u4f8b","text":"<pre><code>\u65f6\u95f4\u8f74 \u2192\n\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\n\u7ebf\u7a0b1 \u2503 \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588 fzw::GetClass::panda_file \u2588\u2588\u2588\u2588\n      \u2503    \u2588\u2588\u2588 LoadClass \u2588\u2588\u2588\n      \u2503        \u2588\u2588 LinkMethods \u2588\u2588\n\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\n\u7ebf\u7a0b2 \u2503     \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588 AnotherEvent \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\n\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\u2501\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\uff1a - \u2705 \u6bcf\u4e2a\u4e8b\u4ef6\u7684\u5f00\u59cb\u548c\u7ed3\u675f\u65f6\u95f4 - \u2705 \u4e8b\u4ef6\u4e4b\u95f4\u7684\u8c03\u7528\u5173\u7cfb\uff08\u5d4c\u5957\uff09 - \u2705 \u4e0d\u540c\u7ebf\u7a0b\u7684\u5e76\u884c\u6267\u884c\u60c5\u51b5 - \u2705 \u70ed\u70b9\u5206\u6790\uff08\u54ea\u4e2a\u51fd\u6570\u6700\u8017\u65f6\uff09</p>"},{"location":"arkcompiler/TRACE_COMPLETE_GUIDE/#6","title":"6. \u5e38\u89c1\u95ee\u9898","text":""},{"location":"arkcompiler/TRACE_COMPLETE_GUIDE/#61-trace","title":"6.1 Trace \u6ca1\u6709\u8f93\u51fa","text":"<p>\u68c0\u67e5\u6e05\u5355\uff1a 1. \u2705 \u662f\u5426\u8bbe\u7f6e\u4e86 <code>PANDA_TRACE=1</code> \u73af\u5883\u53d8\u91cf\uff1f 2. \u2705 \u662f\u5426\u6709 root \u6743\u9650\uff1f\uff08\u9700\u8981\u8bbf\u95ee <code>/sys/kernel/debug/tracing/trace_marker</code>\uff09 3. \u2705 \u662f\u5426\u542f\u7528\u4e86 ftrace tracing\uff1f\uff08\u8fd0\u884c trace_enable_wsl2.sh\uff09 4. \u2705 \u7a0b\u5e8f\u662f\u5426\u771f\u7684\u8c03\u7528\u4e86 <code>Tracer::Start/Finish</code>\uff1f 5. \u2705 \u7f16\u8bd1\u65f6\u662f\u5426\u542f\u7528\u4e86 <code>-DENABLE_AUTO_TRACE=ON</code>\uff08\u5982\u679c\u4f7f\u7528\u81ea\u52a8\u63d2\u6869\uff09\uff1f</p> <p>\u9a8c\u8bc1\u65b9\u6cd5\uff1a <pre><code># \u68c0\u67e5 trace \u6587\u4ef6\u4e2d\u662f\u5426\u6709\u60a8\u7684\u6807\u8bb0\ngrep \"fzw::GetClass\" output.trace\n\n# \u68c0\u67e5\u662f\u5426\u6709 trace_marker \u5199\u5165\ngrep \"tracing_mark_write\" output.trace\n</code></pre></p>"},{"location":"arkcompiler/TRACE_COMPLETE_GUIDE/#62-undefined-reference","title":"6.2 \u7f16\u8bd1\u9519\u8bef\uff1aundefined reference","text":"<p>\u9519\u8bef\uff1a <pre><code>undefined reference to `ark::trace::internal::DoInt64TracePoint'\n</code></pre></p> <p>\u89e3\u51b3\uff1a - \u786e\u4fdd <code>DoIntTracePoint</code> \u548c <code>DoInt64TracePoint</code> \u51fd\u6570\u6709 <code>PANDA_PUBLIC_API</code> \u6807\u8bb0 - \u68c0\u67e5\u94fe\u63a5\u4e86 <code>libarkbase.so</code></p>"},{"location":"arkcompiler/TRACE_COMPLETE_GUIDE/#63-wsl2","title":"6.3 WSL2 \u6743\u9650\u95ee\u9898","text":"<p>\u9519\u8bef\uff1a <pre><code>chmod: changing permissions of '/sys/kernel/debug/tracing': Operation not permitted\n</code></pre></p> <p>\u89e3\u51b3\uff1a - \u8fd9\u662f WSL2 \u7684\u6b63\u5e38\u884c\u4e3a\uff0c\u4e0d\u5f71\u54cd\u4f7f\u7528 - \u4f7f\u7528 <code>trace_enable_wsl2.sh</code> \u811a\u672c\uff08\u8df3\u8fc7\u6743\u9650\u8bbe\u7f6e\uff09 - \u4ee5 root \u8eab\u4efd\u8fd0\u884c\u5373\u53ef\u76f4\u63a5\u8bbf\u95ee</p>"},{"location":"arkcompiler/TRACE_COMPLETE_GUIDE/#64","title":"6.4 \u6027\u80fd\u5f71\u54cd\u592a\u5927","text":"<p>\u4f18\u5316\u65b9\u6848\uff1a 1. \u4f7f\u7528\u767d\u540d\u5355\uff1a<code>TRACE_WHITELIST=\"ClassLinker\"</code> 2. \u9650\u5236\u6df1\u5ea6\uff1a<code>TRACE_MAX_DEPTH=5</code> 3. \u6392\u9664\u70ed\u8def\u5f84\uff1a\u5728\u51fd\u6570\u524d\u52a0 <code>__attribute__((no_instrument_function))</code> 4. \u53ea\u5728\u9700\u8981\u65f6\u542f\u7528\uff1a\u5f00\u53d1/\u5b66\u4e60\u65f6\u5f00\u542f\uff0c\u751f\u4ea7\u73af\u5883\u5173\u95ed</p>"},{"location":"arkcompiler/TRACE_COMPLETE_GUIDE/#65-trace","title":"6.5 Trace \u6587\u4ef6\u592a\u5927","text":"<p>\u89e3\u51b3\u65b9\u6848\uff1a 1. \u4f7f\u7528 Perfetto UI\uff08\u5904\u7406\u5927\u6587\u4ef6\u80fd\u529b\u66f4\u5f3a\uff09 2. \u4f7f\u7528\u767d\u540d\u5355/\u9ed1\u540d\u5355\u8fc7\u6ee4 3. \u9650\u5236\u8ffd\u8e2a\u6df1\u5ea6 4. \u7f29\u77ed\u8ffd\u8e2a\u65f6\u95f4</p>"},{"location":"arkcompiler/TRACE_COMPLETE_GUIDE/#66-trace","title":"6.6 \u5d4c\u5957 Trace \u662f\u5426\u652f\u6301\uff1f","text":"<p>\u7b54\u6848\uff1a\u5b8c\u5168\u652f\u6301\uff01</p> <p>ftrace \u4f7f\u7528\u6808\u7ed3\u6784\uff08LIFO\uff09\u5904\u7406\u5d4c\u5957\u7684 Begin/End \u5bf9\uff1a</p> <pre><code>Tracer::Start(\"A\");      // Begin A\nTracer::Start(\"B\");      // Begin B\nTracer::Finish();        // End B\nTracer::Finish();        // End A\n</code></pre> <p>\u8f93\u51fa\uff1a <pre><code>B|pid|A\nB|pid|B\nE|\nE|\n</code></pre></p> <p>\u53ef\u89c6\u5316\uff1a <pre><code>A \u2503 \u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\nB \u2503    \u2588\u2588\u2588\u2588\n</code></pre></p>"},{"location":"arkcompiler/TRACE_COMPLETE_GUIDE/#7","title":"7. \u5feb\u901f\u53c2\u8003","text":""},{"location":"arkcompiler/TRACE_COMPLETE_GUIDE/#71","title":"7.1 \u57fa\u672c\u4f7f\u7528","text":"<pre><code>// \u5728\u4ee3\u7801\u4e2d\u6dfb\u52a0 trace\nTracer::Start(\"MyFunction\");\n// ... \u4e1a\u52a1\u903b\u8f91 ...\nTracer::Finish();\n</code></pre> <pre><code># \u6293\u53d6 trace\nsudo ./scripts/trace_enable_wsl2.sh output.trace 60 8192\nPANDA_TRACE=1 sudo -E ./your_program\n\n# \u67e5\u770b\u7ed3\u679c\n# https://ui.perfetto.dev/ -&gt; \u6253\u5f00 output.trace\n</code></pre>"},{"location":"arkcompiler/TRACE_COMPLETE_GUIDE/#72","title":"7.2 \u81ea\u52a8\u63d2\u6869","text":"<pre><code># \u7f16\u8bd1\ncmake -DENABLE_AUTO_TRACE=ON build\ncmake --build build\n\n# \u8fd0\u884c\nPANDA_TRACE=1 TRACE_WHITELIST=\"ClassLinker\" sudo -E ./build/bin/ark app.abc\n</code></pre>"},{"location":"arkcompiler/TRACE_COMPLETE_GUIDE/#73","title":"7.3 \u5173\u952e\u6587\u4ef6\u4f4d\u7f6e","text":"\u6587\u4ef6 \u8def\u5f84 Tracer \u7c7b\u5b9a\u4e49 <code>runtime/trace.h</code> ftrace \u5b9e\u73b0 <code>platforms/unix/libarkbase/trace.cpp</code> trace API <code>libarkbase/trace/trace.h</code> trace \u811a\u672c <code>scripts/trace_enable_wsl2.sh</code>"},{"location":"arkcompiler/TRACE_COMPLETE_GUIDE/#74","title":"7.4 \u73af\u5883\u53d8\u91cf\u901f\u67e5","text":"\u53d8\u91cf \u4f5c\u7528 <code>PANDA_TRACE=1</code> \u542f\u7528 trace\uff08\u5fc5\u9700\uff09 <code>TRACE_MAX_DEPTH=N</code> \u9650\u5236\u8ffd\u8e2a\u6df1\u5ea6 <code>TRACE_WHITELIST=\"...\"</code> \u53ea\u8ffd\u8e2a\u5339\u914d\u7684\u51fd\u6570 <code>TRACE_BLACKLIST=\"...\"</code> \u4e0d\u8ffd\u8e2a\u5339\u914d\u7684\u51fd\u6570"},{"location":"arkcompiler/TRACE_COMPLETE_GUIDE/#8","title":"8. \u603b\u7ed3","text":""},{"location":"arkcompiler/TRACE_COMPLETE_GUIDE/#_13","title":"\u6838\u5fc3\u8981\u70b9","text":"<ol> <li>Trace \u7cfb\u7edf\u67b6\u6784\uff1a\u4e09\u5c42\u67b6\u6784\uff0c\u6761\u4ef6\u7f16\u8bd1\u9009\u62e9\u5b9e\u73b0\uff08HiTrace \u6216 ftrace\uff09</li> <li>\u5d4c\u5957\u652f\u6301\uff1a\u5b8c\u5168\u652f\u6301\uff0cftrace \u4f7f\u7528\u6808\u7ed3\u6784</li> <li>\u6293\u53d6\u65b9\u6cd5\uff1a\u8bbe\u7f6e <code>PANDA_TRACE=1</code> + root \u6743\u9650 + ftrace \u811a\u672c</li> <li>\u53ef\u89c6\u5316\u5de5\u5177\uff1a\u63a8\u8350 Perfetto UI\uff08https://ui.perfetto.dev/\uff09</li> <li>\u81ea\u52a8\u63d2\u6869\uff1a\u4f7f\u7528 <code>-finstrument-functions</code> \u7f16\u8bd1\u9009\u9879</li> <li>\u6027\u80fd\u8003\u8651\uff1a\u53ef\u901a\u8fc7\u767d\u540d\u5355/\u9ed1\u540d\u5355/\u6df1\u5ea6\u9650\u5236\u63a7\u5236\u5f00\u9500</li> </ol>"},{"location":"arkcompiler/TRACE_COMPLETE_GUIDE/#_14","title":"\u9002\u7528\u573a\u666f","text":"<ul> <li>\u5b66\u4e60\u4ee3\u7801\uff1a\u4f7f\u7528\u81ea\u52a8\u63d2\u6869\uff0c\u5b8c\u6574\u8ffd\u8e2a\u6267\u884c\u6d41\u7a0b</li> <li>\u6027\u80fd\u5206\u6790\uff1a\u5148\u7528 Perf \u627e\u70ed\u70b9\uff0c\u518d\u7528 Trace \u770b\u7ec6\u8282</li> <li>\u8c03\u8bd5\u95ee\u9898\uff1a\u4f7f\u7528 Trace \u67e5\u770b\u7cbe\u786e\u7684\u8c03\u7528\u987a\u5e8f\u548c\u65f6\u95f4</li> <li>\u751f\u4ea7\u73af\u5883\uff1a\u5173\u95ed Trace \u6216\u4f7f\u7528\u767d\u540d\u5355\u9650\u5236</li> </ul>"},{"location":"arkcompiler/arena_allocator_testing_guide/","title":"ArenaAllocator \u4f18\u5316\u6d4b\u8bd5\u6307\u5357","text":"<p>\u672c\u6587\u6863\u63cf\u8ff0\u4e86\u5982\u4f55\u7f16\u8bd1\u548c\u8fd0\u884c\u4e0e ArenaAllocator \u4f18\u5316\uff08Reset \u529f\u80fd\u548c\u7ebf\u7a0b\u672c\u5730\u6c60\uff09\u76f8\u5173\u7684\u6d4b\u8bd5\u5957\u4ef6\u3002</p>"},{"location":"arkcompiler/arena_allocator_testing_guide/#1","title":"1. \u6d4b\u8bd5\u4f4d\u7f6e","text":"<ul> <li>\u5355\u5143\u6d4b\u8bd5: <code>libarkbase/tests/arena_allocator_test.cpp</code><ul> <li>\u6d4b\u8bd5\u7528\u4f8b: <code>ArenaAllocatorTest.ResetTest</code>, <code>ArenaAllocatorTest.ResetMultiArenaTest</code></li> </ul> </li> <li>\u96c6\u6210\u6d4b\u8bd5: <code>runtime/tests/class_linker_test.cpp</code><ul> <li>\u6d4b\u8bd5\u7528\u4f8b: <code>ClassLinkerTest.ThreadLocalAllocatorReuse</code></li> </ul> </li> </ul>"},{"location":"arkcompiler/arena_allocator_testing_guide/#2","title":"2. \u7f16\u8bd1","text":"<p>\u6d4b\u8bd5\u5206\u4e3a\u4e24\u4e2a\u7f16\u8bd1\u76ee\u6807\uff1a<code>arkbase_tests</code>\uff08\u7528\u4e8e\u57fa\u7840\u5e93\u6d4b\u8bd5\uff09\u548c <code>arkruntime_interpreter_test</code>\uff08\u7528\u4e8e\u8fd0\u884c\u65f6\u96c6\u6210\u6d4b\u8bd5\uff09\u3002</p>"},{"location":"arkcompiler/arena_allocator_testing_guide/#_1","title":"\u7f16\u8bd1\u5355\u5143\u6d4b\u8bd5","text":"<pre><code>cmake --build build --target arkbase_tests\n</code></pre>"},{"location":"arkcompiler/arena_allocator_testing_guide/#_2","title":"\u7f16\u8bd1\u96c6\u6210\u6d4b\u8bd5","text":"<pre><code>cmake --build build --target arkruntime_interpreter_test\n</code></pre> <p>\u6ce8\u610f: \u8bf7\u786e\u4fdd\u60a8\u7684\u6784\u5efa\u76ee\u5f55\u5df2\u914d\u7f6e\u597d\uff08\u4f8b\u5982 <code>build</code>\uff09\u3002</p>"},{"location":"arkcompiler/arena_allocator_testing_guide/#3","title":"3. \u8fd0\u884c\u6d4b\u8bd5","text":"<p>\u7f16\u8bd1\u540e\u7684\u6d4b\u8bd5\u4e8c\u8fdb\u5236\u6587\u4ef6\u4f4d\u4e8e <code>build/bin-gtests/</code>\u3002\u4f7f\u7528 <code>--gtest_filter</code> \u6765\u8fd0\u884c\u7279\u5b9a\u7684\u6d4b\u8bd5\u7528\u4f8b\u3002</p>"},{"location":"arkcompiler/arena_allocator_testing_guide/#arenaallocator_1","title":"\u8fd0\u884c ArenaAllocator \u5355\u5143\u6d4b\u8bd5","text":"<p>\u9a8c\u8bc1 <code>Reset()</code> \u529f\u80fd\uff1a</p> <pre><code>./build/bin-gtests/arkbase_tests --gtest_filter=\"ArenaAllocatorTest.Reset*\"\n</code></pre> <p>\u9884\u671f\u8f93\u51fa: <pre><code>[ RUN      ] ArenaAllocatorTest.ResetTest\n[       OK ] ArenaAllocatorTest.ResetTest (1 ms)\n[ RUN      ] ArenaAllocatorTest.ResetMultiArenaTest\n[       OK ] ArenaAllocatorTest.ResetMultiArenaTest (1 ms)\n</code></pre></p>"},{"location":"arkcompiler/arena_allocator_testing_guide/#classlinker","title":"\u8fd0\u884c ClassLinker \u96c6\u6210\u6d4b\u8bd5","text":"<p>\u9a8c\u8bc1\u7ebf\u7a0b\u672c\u5730\u5206\u914d\u5668\u6c60\u5316\u548c\u91cd\u7528\uff1a</p> <pre><code>./build/bin-gtests/arkruntime_interpreter_test --gtest_filter=\"ClassLinkerTest.ThreadLocalAllocatorReuse\"\n</code></pre> <p>\u9884\u671f\u8f93\u51fa: <pre><code>[ RUN      ] ClassLinkerTest.ThreadLocalAllocatorReuse\n[       OK ] ClassLinkerTest.ThreadLocalAllocatorReuse (7 ms)\n</code></pre></p>"},{"location":"arkcompiler/arena_allocator_testing_guide/#4","title":"4. \u6545\u969c\u6392\u9664","text":"<ul> <li>\u6784\u5efa\u5931\u8d25: \u5982\u679c\u60a8\u4fee\u6539\u4e86 <code>arena_allocator.h</code> \u6216 <code>.cpp</code>\uff0c\u5fc5\u987b\u91cd\u5efa \u4e24\u4e2a \u76ee\u6807\uff0c\u4ee5\u786e\u4fdd\u66f4\u6539\u4f20\u64ad\u5230\u8fd0\u884c\u65f6\u6d4b\u8bd5\u4e2d\u3002</li> <li>\u672a\u627e\u5230\u76ee\u6807: \u5982\u679c\u672a\u627e\u5230 <code>arkruntime_interpreter_test</code>\uff0c\u8bf7\u9a8c\u8bc1\u60a8\u662f\u5426\u5728 <code>build</code> \u76ee\u5f55\u4e2d\u4e3a\u6b63\u786e\u7684\u67b6\u6784/\u5e73\u53f0\u914d\u7f6e\u8fdb\u884c\u4e86\u7f16\u8bd1\u3002</li> </ul>"},{"location":"arkcompiler/build_guide/","title":"ArkCompiler \u7f16\u8bd1\u6307\u5357","text":"<p>\u672c\u6587\u6863\u6c47\u603b\u4e86 ArkCompiler \u7684 CMake \u7f16\u8bd1\u547d\u4ee4\u4ee5\u53ca Device LLVM \u7684\u6784\u5efa\u6b65\u9aa4\u3002</p>"},{"location":"arkcompiler/build_guide/#1","title":"1. \u7f16\u8bd1\u73af\u5883\u51c6\u5907","text":"<p>\u5728\u5f00\u59cb\u7f16\u8bd1\u4e4b\u524d\uff0c\u8bf7\u786e\u4fdd\u5df2\u5b89\u88c5\u6240\u6709\u5fc5\u8981\u7684\u4f9d\u8d56\u9879\u3002</p> <pre><code>cd static_core/tools\nln -s ../../../arkcompiler_ets_frontend/ets2panda es2panda\n\ncd ..\nsudo ./scripts/install-deps-ubuntu -i=dev -i=test\nsudo apt install gdb\n./scripts/install-third-party --force-clone\n</code></pre>"},{"location":"arkcompiler/build_guide/#2-cmake-host","title":"2. CMake \u7f16\u8bd1 (Host)","text":""},{"location":"arkcompiler/build_guide/#release","title":"Release \u7248\u672c","text":"<pre><code>cmake -B build -DCMAKE_BUILD_TYPE=Release -DCMAKE_TOOLCHAIN_FILE=./cmake/toolchain/host_clang_default.cmake -GNinja .\ncmake --build build\n</code></pre>"},{"location":"arkcompiler/build_guide/#debug","title":"Debug \u7248\u672c","text":"<pre><code>cmake -B build -DCMAKE_BUILD_TYPE=Debug -DCMAKE_TOOLCHAIN_FILE=./cmake/toolchain/host_clang_default.cmake -GNinja .\ncmake --build build\n</code></pre>"},{"location":"arkcompiler/build_guide/#3-llvm-device-ohos-arm64","title":"3. LLVM Device \u7f16\u8bd1 (OHOS ARM64)","text":""},{"location":"arkcompiler/build_guide/#_1","title":"\u5b89\u88c5\u4f9d\u8d56","text":"<pre><code>sudo ./scripts/install-deps-ubuntu -i=llvm-prebuilts\n</code></pre>"},{"location":"arkcompiler/build_guide/#sdk","title":"\u6784\u5efa SDK","text":"<pre><code>cd /home/fanzewei/code/fzw_arkc_0805/arkcompiler_runtime_core/static_core/scripts/sdk\n./build_sdk.sh build-sdk --build_type=Release --ohos_arm64 --ets_std_lib --linux_tools\n</code></pre>"},{"location":"arkcompiler/build_guide/#_2","title":"\u90e8\u7f72\u4ea7\u7269","text":"<p>\u5c06\u7f16\u8bd1\u751f\u6210\u7684\u4e8c\u8fdb\u5236\u6587\u4ef6\u548c\u5e93\u6587\u4ef6\u590d\u5236\u5230\u6307\u5b9a\u76ee\u5f55\uff1a</p> <pre><code># \u590d\u5236\u4e8c\u8fdb\u5236\u6587\u4ef6\ncp ./ohos_arm64/bin/ark /home/fanzewei/code/fzw_arkc_0805/0821_llvm_out/\ncp ./ohos_arm64/bin/ark_aot /home/fanzewei/code/fzw_arkc_0805/0821_llvm_out/\n\n# \u590d\u5236\u5e93\u6587\u4ef6\ncp -r ./ohos_arm64/lib /home/fanzewei/code/fzw_arkc_0805/0821_llvm_out\n\n# \u590d\u5236\u6807\u51c6\u5e93 abc \u6587\u4ef6\ncp ./sdk/ets/etsstdlib.abc /home/fanzewei/code/fzw_arkc_0805/0821_llvm_out\n</code></pre>"},{"location":"arkcompiler/es2panda-developer-guide/","title":"es2panda Developer Guide","text":"<p>\u672c\u6587\u6863\u6c47\u603b\u5e76\u8865\u5145 <code>es2panda</code> \u5728\u7f16\u8bd1 ArkTS (<code>.ets</code>) \u65f6\u5e38\u89c1\u914d\u7f6e\u4e0e\u5b9e\u8df5\uff0c\u91cd\u70b9\u8986\u76d6\uff1a\u58f0\u660e\u4f9d\u8d56\uff08<code>.d.ets</code>\uff09\u3001<code>arktsconfig.json</code>\u3001\u6807\u51c6\u5e93\u4f7f\u7528\u3001\u4ee5\u53ca\u5bfc\u5165\u8def\u5f84\u89e3\u6790\u7684\u5173\u952e\u89c4\u5219\u3002</p>"},{"location":"arkcompiler/es2panda-developer-guide/#1-dets","title":"1. \u7f16\u8bd1\u5305\u542b\u58f0\u660e\u4f9d\u8d56\uff08<code>.d.ets</code>\uff09","text":"<p>\u5f53\u4ee3\u7801\u4f9d\u8d56\u7b2c\u4e09\u65b9\u58f0\u660e\uff08<code>.d.ets</code>\uff09\u6216\u62c6\u5206\u6a21\u5757\u65f6\uff0c\u6709\u4e24\u79cd\u4e3b\u8981\u65b9\u5f0f\u8ba9\u7f16\u8bd1\u5668\u89e3\u6790\u4f9d\u8d56\u3002</p>"},{"location":"arkcompiler/es2panda-developer-guide/#a-arktsconfigjson","title":"\u65b9\u6cd5 A\uff1a\u4f7f\u7528 <code>arktsconfig.json</code>\uff08\u63a8\u8350\uff09","text":"<p>\u5efa\u8bae\u5728\u771f\u5b9e\u5de5\u7a0b\u6216\u590d\u6742\u4f9d\u8d56\u4e2d\u4f7f\u7528 <code>arktsconfig.json</code>\uff0c\u901a\u8fc7 <code>compilerOptions.paths</code> \u663e\u5f0f\u6620\u5c04\u6a21\u5757\u8def\u5f84\u3002</p> <p>\u547d\u4ee4\uff1a <pre><code>./build/bin/es2panda --arktsconfig path/to/arktsconfig.json source_file.ets\n</code></pre></p> <p>\u914d\u7f6e\u7ed3\u6784\uff1a - \u5fc5\u987b\u5305\u542b\u6807\u51c6\u5e93\u8def\u5f84 <code>std</code> \u4e0e <code>escompat</code>\uff0c\u5426\u5219\u57fa\u7840\u7c7b\u578b\uff08\u5982 <code>string</code>\u3001<code>Object</code>\u3001<code>console</code>\uff09\u65e0\u6cd5\u89e3\u6790\u3002 - \u53ef\u9009\u6dfb\u52a0 <code>api</code> \u4e0e <code>arkts</code>\uff0c\u7528\u4e8e\u5f15\u5165 SDK API \u4e0e ArkTS \u6269\u5c55\u63a5\u53e3\uff08\u4e0e\u6784\u5efa\u65f6\u9ed8\u8ba4\u914d\u7f6e\u4fdd\u6301\u4e00\u81f4\uff09\u3002</p> <pre><code>{\n  \"compilerOptions\": {\n    \"baseUrl\": \".\",\n    \"paths\": {\n      \"std\": [\"/path/to/arkcompiler/runtime_core/static_core/plugins/ets/stdlib/std\"],\n      \"escompat\": [\"/path/to/arkcompiler/runtime_core/static_core/plugins/ets/stdlib/escompat\"],\n      \"api\": [\"/path/to/arkcompiler/runtime_core/static_core/plugins/ets/sdk/api\"],\n      \"arkts\": [\"/path/to/arkcompiler/runtime_core/static_core/plugins/ets/sdk/arkts\"],\n      \"dependency\": [\"./path/to/your/lib.d.ets\"]\n    }\n  }\n}\n</code></pre> <p>\u4f9d\u8d56\u5143\u4fe1\u606f\uff08\u53ef\u9009\uff09\uff1a<code>compilerOptions.dependencies</code></p> <p><code>dependencies</code> \u53ef\u4e3a\u67d0\u4e9b\u5bfc\u5165\u8def\u5f84\u6807\u6ce8\u8bed\u8a00\u7c7b\u578b\u4e0e\u58f0\u660e\u6587\u4ef6\u4f4d\u7f6e\u3002\u82e5\u672a\u6307\u5b9a\uff0c\u8bed\u8a00\u7531\u540e\u7f00\u63a8\u65ad\uff0c<code>hasDecl</code> \u9ed8\u8ba4\u4e3a <code>true</code>\u3002</p> <pre><code>{\n  \"compilerOptions\": {\n    \"baseUrl\": \".\",\n    \"paths\": {\n      \"std\": [\".../stdlib/std\"],\n      \"escompat\": [\".../stdlib/escompat\"]\n    },\n    \"dependencies\": {\n      \"dynamic_js_import_tests\": { \"language\": \"js\" },\n      \"path/to/ets/dynamic_import_tests\": {\n        \"language\": \"js\",\n        \"path\": \"path/to/ets/declaration\"\n      }\n    }\n  }\n}\n</code></pre>"},{"location":"arkcompiler/es2panda-developer-guide/#b","title":"\u65b9\u6cd5 B\uff1a\u76f8\u5bf9\u8def\u5f84\u5f15\u7528\uff08\u7b80\u5355\u5feb\u901f\uff09","text":"<p>\u7528\u4e8e\u5c0f\u578b\u9a8c\u8bc1\u6216\u4e34\u65f6\u6d4b\u8bd5\uff0c\u53ef\u76f4\u63a5\u628a <code>.d.ets</code> \u653e\u5728\u540c\u76ee\u5f55\u6216\u76f8\u5bf9\u76ee\u5f55\u4e2d\uff0c\u901a\u8fc7\u76f8\u5bf9\u8def\u5f84\u5bfc\u5165\u3002</p> <p>\u7ed3\u6784\u793a\u4f8b\uff1a <pre><code>project/\n  \u251c\u2500\u2500 Main.ets\n  \u2514\u2500\u2500 Lib.d.ets\n</code></pre></p> <p>\u4f7f\u7528\u65b9\u5f0f\uff1a <pre><code>// Main.ets\nimport { foo } from \"./Lib\";   // \u53ef\u7701\u7565\u6269\u5c55\u540d\n// \u6216\nimport { foo } from \"./Lib.d\"; // \u5e38\u89c1\u4e8e\u6d4b\u8bd5\u7528\u4f8b\n</code></pre></p> <p>\u547d\u4ee4\uff1a <pre><code>./build/bin/es2panda project/Main.ets\n</code></pre></p> <p>\u8bf4\u660e\uff1a\u5bfc\u5165\u8def\u5f84\u53ef\u4ee5\u662f\u76f8\u5bf9\u6216\u7edd\u5bf9\u8def\u5f84\uff1b\u53ef\u5e26\u6216\u4e0d\u5e26\u6269\u5c55\u540d\u3002\u4e5f\u53ef\u6307\u5411\u5305\u76ee\u5f55\uff08\u542b <code>index.ets</code>/<code>index.ts</code>\uff09\u6216\u5305\u6a21\u5757\u8def\u5f84\u3002</p>"},{"location":"arkcompiler/es2panda-developer-guide/#2-dets","title":"2. \u7f16\u5199\u5408\u6cd5\u7684 <code>.d.ets</code> \u58f0\u660e\u6587\u4ef6","text":"<p>\u9876\u5c42\u5bfc\u51fa\u5e94\u4f7f\u7528 <code>declare</code>\uff0c\u4f8b\u5982\uff1a</p> <pre><code>export declare function foo(): void;\nexport declare class Bar {\n    public static id(): string;\n}\n</code></pre> <p>\u5728 <code>export declare namespace</code> \u5185\u90e8\uff0c\u6210\u5458\u53ef\u4ee5\u76f4\u63a5 <code>export function</code> / <code>export class</code>\uff0c\u4e0d\u9700\u8981\u518d\u52a0 <code>declare</code>\uff1a</p> <pre><code>export declare namespace MixedNamespace {\n    export const constantValue: number;\n    export function someFunction(): void;\n    export interface SomeInterface {\n        id: number;\n    }\n    export class SomeClass {\n        prop: string;\n    }\n}\n</code></pre> <p>\u5efa\u8bae\uff1a\u82e5\u672a\u4f7f\u7528 <code>declare</code>\uff0c\u53ef\u80fd\u89e6\u53d1\u8bed\u4e49\u9519\u8bef\u6216\u7c7b\u578b\u68c0\u67e5\u5931\u8d25\u3002\u4e3a\u51cf\u5c11\u6b67\u4e49\uff0c\u5c3d\u91cf\u5728\u9876\u5c42\u4f7f\u7528 <code>export declare</code>\u3002</p>"},{"location":"arkcompiler/es2panda-developer-guide/#3","title":"3. \u6807\u51c6\u5e93\u4e0e\u9690\u5f0f\u5bfc\u5165","text":""},{"location":"arkcompiler/es2panda-developer-guide/#chrononanonow","title":"\u9ad8\u7cbe\u5ea6\u8ba1\u65f6\uff08<code>Chrono.nanoNow()</code>\uff09","text":"<p>\u63a8\u8350\u4ece\u5305\u8def\u5f84\u5bfc\u5165\uff1a</p> <pre><code>import { Chrono } from \"std/time\";\n\nfunction main() {\n    let t: long = Chrono.nanoNow();\n    console.log(t);\n}\n</code></pre> <p>API \u7ec6\u8282\uff1a - Package: <code>std.time</code> - Class: <code>Chrono</code>\uff08<code>final</code>\uff09 - Method: <code>public static native nanoNow(): long;</code></p>"},{"location":"arkcompiler/es2panda-developer-guide/#_1","title":"\u9690\u5f0f\u6807\u51c6\u5e93\u5bfc\u5165","text":"<p>\u7f16\u8bd1\u5668\u4f1a\u4e3a\u6bcf\u4e2a\u6a21\u5757\u9690\u5f0f\u5bfc\u5165\u4e00\u90e8\u5206\u6838\u5fc3\u6807\u51c6\u5e93\u5305\uff08\u4f8b\u5982 <code>std/core</code>\u3001<code>std/math</code>\uff09\uff0c\u56e0\u6b64 <code>console</code> \u7b49\u7b26\u53f7\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528\u3002\u8be5\u884c\u4e3a\u7531\u5185\u90e8\u9ed8\u8ba4\u5bfc\u5165\u6587\u4ef6\u5b9e\u73b0\uff0c\u5e38\u89c4\u9879\u76ee\u65e0\u9700\u663e\u5f0f\u914d\u7f6e\u3002</p>"},{"location":"arkcompiler/es2panda-developer-guide/#4-vs","title":"4. \u5bfc\u5165\u98ce\u683c\uff1a\u5305\u5bfc\u5165 vs \u6587\u4ef6\u5bfc\u5165","text":"\u5bfc\u5165\u65b9\u5f0f \u793a\u4f8b \u884c\u4e3a \u5efa\u8bae \u5305\u5bfc\u5165 <code>import { Chrono } from \"std/time\";</code> \u6309\u5305\u8def\u5f84\u805a\u5408\u5bfc\u51fa\uff0c\u7a33\u5b9a\u53ef\u9760 \u63a8\u8350 \u6587\u4ef6\u5bfc\u5165 <code>import { Chrono } from \"std/time/Chrono\";</code> \u76f4\u63a5\u6307\u5411\u7269\u7406\u6587\u4ef6\uff0c\u5bb9\u6613\u56e0\u6587\u4ef6\u79fb\u52a8\u800c\u5931\u6548 \u4e0d\u63a8\u8350 <p>\u7ed3\u8bba\uff1a\u4f18\u5148\u4f7f\u7528\u5305\u8def\u5f84\uff08\u5982 <code>std/time</code>\uff09\uff0c\u9664\u975e\u6709\u660e\u786e\u7406\u7531\u5fc5\u987b\u7ed1\u5b9a\u5177\u4f53\u6587\u4ef6\u3002</p>"},{"location":"arkcompiler/es2panda-developer-guide/#5-arktsconfigjson","title":"5. <code>arktsconfig.json</code> \u901f\u67e5\u4e0e\u5e38\u7528\u6a21\u677f","text":""},{"location":"arkcompiler/es2panda-developer-guide/#_2","title":"\u6700\u5c0f\u53ef\u7528\u6a21\u677f","text":"<pre><code>{\n  \"compilerOptions\": {\n    \"baseUrl\": \".\",\n    \"paths\": {\n      \"std\": [\"../lib/stdlib/std\"],\n      \"escompat\": [\"../lib/stdlib/escompat\"]\n    }\n  }\n}\n</code></pre>"},{"location":"arkcompiler/es2panda-developer-guide/#sdk-files","title":"SDK \u793a\u4f8b\uff08\u542b <code>files</code>\uff09","text":"<pre><code>{\n  \"compilerOptions\": {\n    \"baseUrl\": \"../../\",\n    \"paths\": {\n      \"std\": [\"ets/stdlib/std\"],\n      \"escompat\": [\"ets/stdlib/escompat\"]\n    },\n    \"outDir\": \"../cache\"\n  },\n  \"files\": [\n    \"./api/@ohos.buffer.ets\",\n    \"./arkts/@arkts.math.Decimal.ets\"\n  ]\n}\n</code></pre> <p>\u53c2\u8003\u4f4d\u7f6e\uff1a<code>plugins/ets/stdlib/stdconfig.json</code> \u4e0e <code>plugins/ets/sdk/arktsconfig.json</code>\u3002</p>"},{"location":"arkcompiler/es2panda-developer-guide/#_3","title":"\u6784\u5efa\u65f6\u751f\u6210\u7684\u9ed8\u8ba4\u914d\u7f6e","text":"<p>\u6784\u5efa\u7cfb\u7edf\u4f1a\u751f\u6210 <code>arktsconfig.json</code>\uff0c\u5176\u5185\u5bb9\u901a\u5e38\u5305\u542b <code>std</code>\u3001<code>escompat</code>\u3001<code>api</code>\u3001<code>arkts</code> \u7b49\u8def\u5f84\u3002\u53ef\u7528\u4e8e\u6838\u5bf9\u8def\u5f84\u8bbe\u7f6e\u662f\u5426\u4e00\u81f4\u3002</p>"},{"location":"arkcompiler/es2panda-developer-guide/#6-import-type","title":"6. \u8865\u5145\uff1a<code>import type</code> \u4e0e\u503c\u5bfc\u5165","text":"<p>ArkTS \u652f\u6301 <code>import type</code> \u53ea\u5bfc\u5165\u7c7b\u578b\uff1a</p> <pre><code>import type { A } from \"./types\";\nimport { AImpl } from \"./impl\";\n</code></pre> <ul> <li><code>import type</code> \u4ec5\u5f15\u5165\u7c7b\u578b\uff0c\u4e0d\u5f15\u5165\u503c\uff1b</li> <li>\u666e\u901a <code>import</code> \u540c\u65f6\u5f15\u5165\u7c7b\u578b\u4e0e\u8fd0\u884c\u65f6\u503c\u3002</li> </ul>"},{"location":"arkcompiler/es2panda-developer-guide/#7","title":"7. \u5e38\u89c1\u6392\u9519\u63d0\u793a","text":"<ul> <li>\u57fa\u7840\u7c7b\u578b/console \u672a\u89e3\u6790\uff1a\u591a\u534a\u662f <code>std</code> / <code>escompat</code> \u6620\u5c04\u7f3a\u5931\u3002</li> <li>\u4f9d\u8d56 JS \u6a21\u5757\u89e3\u6790\u5931\u8d25\uff1a\u8003\u8651\u5728 <code>dependencies</code> \u4e2d\u58f0\u660e <code>language</code> \u6216 <code>path</code>\u3002</li> <li>\u58f0\u660e\u6587\u4ef6\u7f16\u8bd1\u5931\u8d25\uff1a\u68c0\u67e5\u9876\u5c42\u662f\u5426\u6b63\u786e\u4f7f\u7528 <code>export declare</code>\u3002</li> </ul>"},{"location":"leetcode/cpp_binary_search_guide/","title":"C++ STL \u4e8c\u5206\u67e5\u627e\u7b97\u6cd5\u5168\u666f\u6307\u5357","text":"<p>\u672c\u6587\u6863\u6574\u7406\u4e86 C++ \u6807\u51c6\u5e93 (<code>&lt;algorithm&gt;</code>) \u4e2d\u6240\u6709\u57fa\u4e8e\u4e8c\u5206\u67e5\u627e\u539f\u7406\u7684\u7b97\u6cd5\uff0c\u4ee5\u53ca\u73b0\u4ee3 C++ (C++11/20) \u4e2d\u7684\u8fdb\u9636\u7528\u6cd5\u548c\u6027\u80fd\u9677\u9631\u3002</p>"},{"location":"leetcode/cpp_binary_search_guide/#1","title":"1. \u6838\u5fc3\u7b97\u6cd5\u6982\u89c8","text":"<p>\u6240\u6709\u8fd9\u4e9b\u7b97\u6cd5\u7684\u524d\u63d0\u6761\u4ef6\uff1a\u5e8f\u5217\u5fc5\u987b\u5bf9\u4e8e\u6bd4\u8f83\u64cd\u4f5c\u662f\u5df2\u6392\u5e8f\uff08\u6216\u5df2\u5206\u533a\uff09\u7684\u3002</p> \u51fd\u6570\u540d \u8fd4\u56de\u503c \u8bed\u4e49/\u4f5c\u7528 \u590d\u6742\u5ea6 <code>std::binary_search</code> <code>bool</code> \u53ea\u56de\u7b54\u201c\u5728\u4e0d\u5728\u201d\u3002\u4e0d\u8fd4\u56de\u4f4d\u7f6e\u3002 $O(\\log n)$ <code>std::lower_bound</code> <code>iterator</code> \u627e\u7b2c\u4e00\u4e2a $\\ge$ val \u7684\u4f4d\u7f6e\u3002\u5e38\u7528\u4e8e\u67e5\u627e\u63d2\u5165\u4f4d\u7f6e\u3002 $O(\\log n)$ <code>std::upper_bound</code> <code>iterator</code> \u627e\u7b2c\u4e00\u4e2a $&gt;$ val \u7684\u4f4d\u7f6e\u3002\u5e38\u7528\u4e8e\u786e\u5b9a\u8303\u56f4\u7ec8\u70b9\u3002 $O(\\log n)$ <code>std::equal_range</code> <code>pair&lt;iter, iter&gt;</code> \u540c\u65f6\u8fd4\u56de <code>lower_bound</code> \u548c <code>upper_bound</code>\u3002 $O(\\log n)$ <code>std::partition_point</code> <code>iterator</code> (C++11) \u627e\u7b2c\u4e00\u4e2a\u4e0d\u6ee1\u8db3\u8c13\u8bcd\u7684\u5143\u7d20\u4f4d\u7f6e\u3002 $O(\\log n)$"},{"location":"leetcode/cpp_binary_search_guide/#2","title":"2. \u8be6\u7ec6\u89e3\u6790","text":""},{"location":"leetcode/cpp_binary_search_guide/#21","title":"2.1 \u57fa\u7840\u68c0\u67e5","text":""},{"location":"leetcode/cpp_binary_search_guide/#stdbinary_search","title":"<code>std::binary_search</code>","text":"<ul> <li>\u7528\u9014\uff1a\u4ec5\u68c0\u67e5\u5143\u7d20\u662f\u5426\u5b58\u5728\u3002</li> <li>\u6ce8\u610f\uff1a\u5982\u679c\u4f60\u4e4b\u540e\u9700\u8981\u8bbf\u95ee\u8be5\u5143\u7d20\uff0c\u4e0d\u8981\u7528\u8fd9\u4e2a\u3002\u7528 <code>lower_bound</code> \u4ee3\u66ff\uff0c\u5426\u5219\u4f1a\u8fdb\u884c\u4e24\u6b21 $O(\\log n)$ \u67e5\u627e\u3002</li> </ul>"},{"location":"leetcode/cpp_binary_search_guide/#22-the-big-three","title":"2.2 \u5b9a\u4f4d\u4f4d\u7f6e (The \"Big Three\")","text":"<ul> <li><code>lower_bound(begin, end, val)</code>: \u95ed\u533a\u95f4\u8d77\u70b9 <code>[</code>\u3002</li> <li><code>upper_bound(begin, end, val)</code>: \u5f00\u533a\u95f4\u7ec8\u70b9 <code>)</code>\u3002</li> <li><code>equal_range(begin, end, val)</code>: \u8fd4\u56de <code>{first, second}</code>\uff0c\u5373 <code>[lower_bound, upper_bound)</code>\u3002\u533a\u95f4\u957f\u5ea6\u5373\u4e3a\u7b49\u4e8e <code>val</code> \u7684\u5143\u7d20\u4e2a\u6570\u3002</li> </ul>"},{"location":"leetcode/cpp_binary_search_guide/#23","title":"2.3 \u5e7f\u4e49\u4e8c\u5206\u67e5\u627e (\u9690\u85cf\u7684\u795e\u5668)","text":""},{"location":"leetcode/cpp_binary_search_guide/#stdpartition_point-c11","title":"<code>std::partition_point</code> (C++11)","text":"<p>\u8fd9\u662f\u4e8c\u5206\u67e5\u627e\u7684\u901a\u7528\u5f62\u5f0f\u3002\u5b83\u4e0d\u6bd4\u8f83\u5177\u4f53\u7684\u503c\uff0c\u800c\u662f\u6839\u636e\u4e00\u4e2a\u5e03\u5c14\u8c13\u8bcd (Predicate) \u8fdb\u884c\u4e8c\u5206\u3002 * \u524d\u63d0\uff1a\u6570\u7ec4\u5fc5\u987b\u662f\u6839\u636e\u8be5\u8c13\u8bcd\u201c\u5df2\u5206\u533a\u201d\u7684\uff08\u6240\u6709 <code>true</code> \u5728\u524d\uff0c\u6240\u6709 <code>false</code> \u5728\u540e\uff09\u3002 * \u8fd4\u56de\u503c\uff1a\u8fd4\u56de\u7b2c\u4e00\u4e2a\u8ba9\u8c13\u8bcd\u4e3a <code>false</code> \u7684\u5143\u7d20\u3002 * \u573a\u666f\uff1a\u4e8c\u5206\u7b54\u6848 (Binary Search on Answer)\u3002\u4f8b\u5982\uff0c\u201c\u627e\u5230\u7b2c\u4e00\u4e2a\u5927\u4e8e X \u7684\u6570\u201d\u672c\u8d28\u4e0a\u5c31\u662f <code>partition_point</code>\u3002</p> <pre><code>std::vector&lt;int&gt; v = {1, 2, 3, 4, 5, 6, 7};\n// \u67e5\u627e\u7b2c\u4e00\u4e2a\u5927\u4e8e 4 \u7684\u6570 (\u5373\u4f7f\u6570\u7ec4\u6ca1\u6392\u5e8f\uff0c\u53ea\u8981\u6ee1\u8db3\u5206\u533a\u6027\u8d28\u5373\u53ef)\nauto it = std::partition_point(v.begin(), v.end(), [](int i) {\n    return i &lt;= 4; // \u524d\u534a\u90e8\u5206\u6ee1\u8db3 &lt;= 4 (True)\uff0c\u540e\u534a\u90e8\u5206\u4e0d\u6ee1\u8db3 (False)\n});\n// it \u6307\u5411 5\n</code></pre>"},{"location":"leetcode/cpp_binary_search_guide/#3","title":"3. \u9644\u5f55","text":"<pre><code>graph TD\n    %% \u5b9a\u4e49\u6837\u5f0f\n    classDef target fill:#d4edda,stroke:#28a745,stroke-width:2px;\n    classDef other fill:#f8f9fa,stroke:#6c757d,stroke-width:1px;\n    classDef ptr fill:#fff3cd,stroke:#ffc107,stroke-width:2px,stroke-dasharray: 5 5;\n\n    %% \u6570\u7ec4\u8282\u70b9\n    subgraph Array [std::vector v]\n        direction LR\n        N0[10&lt;br/&gt;idx:0]:::other\n        N1[20&lt;br/&gt;idx:1]:::other\n        N2[30&lt;br/&gt;idx:2]:::target\n        N3[30&lt;br/&gt;idx:3]:::target\n        N4[30&lt;br/&gt;idx:4]:::target\n        N5[40&lt;br/&gt;idx:5]:::other\n        N6[50&lt;br/&gt;idx:6]:::other\n\n        N0 --- N1 --- N2 --- N3 --- N4 --- N5 --- N6\n    end\n\n    %% \u6307\u9488\u8282\u70b9\n    LB(lower_bound&lt;br/&gt;\u6307\u5411\u7b2c\u4e00\u4e2a &gt;= 30):::ptr\n    UB(upper_bound&lt;br/&gt;\u6307\u5411\u7b2c\u4e00\u4e2a &gt; 30):::ptr\n\n    %% \u8fde\u63a5\u5173\u7cfb\n    LB --&gt; N2\n    UB --&gt; N5\n\n    %% \u8303\u56f4\u6807\u6ce8\n    subgraph Range [std::equal_range \u8fd4\u56de\u7684\u533a\u95f4 Pair]\n        direction TB\n        %% \u4fee\u6b63\u70b9\uff1a\u4f7f\u7528\u5f15\u53f7\u5305\u88f9\u542b\u6709\u7279\u6b8a\u7b26\u53f7\u7684\u6587\u672c\n        Note1[\"\u533a\u95f4\u8303\u56f4: [first, last)\"]\n        Note2[\"\u5305\u542b idx 2, 3, 4\"]\n    end</code></pre>"}]}